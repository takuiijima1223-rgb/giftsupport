<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>就労支援管理システム - Gift Support</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- BabelにReactの処理を明示的に指定 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f1f5f9; }
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; width: 100%; }
            .no-print { display: none !important; }
            .shadow-sm, .shadow-md { box-shadow: none !important; }
            input, textarea, select { border: 1px solid #ccc !important; }
            input:disabled, textarea:disabled { background-color: white !important; color: black !important; }
            select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background: none !important; padding-right: 0 !important; }
            .overflow-x-auto { overflow: visible !important; }
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="portal-root"></div>

    <script type="text/babel" data-presets="react,env">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { createPortal } = ReactDOM;

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error) { console.error("ErrorBoundary:", error); }
            render() {
                if (this.state.hasError) return (
                    <div className="min-h-screen flex items-center justify-center bg-red-50 p-6">
                        <div className="bg-white p-8 rounded shadow-lg border border-red-200 max-w-lg text-center">
                            <h1 className="text-xl font-bold text-red-600 mb-4">システムエラーが発生しました</h1>
                            <p className="text-gray-600 mb-6 text-sm">{this.state.error?.toString()}</p>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="px-6 py-2 bg-red-600 text-white rounded">リセットして復旧</button>
                        </div>
                    </div>
                );
                return this.props.children;
            }
        }

        const Icon = React.memo(({ name, size = 18, className = "", onClick }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current, attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={ref} onClick={onClick} style={{ display: 'inline-flex', alignItems: 'center', cursor: onClick ? 'pointer' : 'inherit' }} />;
        });

        const ModalPortal = ({ children }) => {
            const el = document.getElementById('portal-root');
            return el ? createPortal(children, el) : null;
        };

        const formatDateKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        
        const calculateWorkHours = (tStr) => {
            if (!tStr || !tStr.includes('-')) return 0;
            try {
                const [s, e] = tStr.split('-');
                const start = Number(s.split(':')[0]) + (Number(s.split(':')[1])||0)/60;
                const end = Number(e.split(':')[0]) + (Number(e.split(':')[1])||0)/60;
                let d = end - start;
                if (d < 0) d += 24;
                return Math.max(0, d > 6 ? d - 1 : d);
            } catch (err) { return 0; }
        };

        const initialApp = { applicantName: "", applicantNameKana: "", gender: "", dob: "", age: "", address: "", phone: "", email: "", disabilityType: [], disabilityName: "", disabilityGrade: "", hasExperience: "", todayQuestion: "", visitReason: [], futureGoal: "", desiredService: [], concerns: [], goals: [], isVisitingHospital: "", hospitalName: "", consultedDoctor: "", howDidYouKnow: [], schedule: { trial1: "", trial1Time: "", trial2: "", trial2Time: "", trial3: "", trial3Time: "", certificateDate: "", contractDate: "" } };
        const initialAss = { createDate: "", writer: "", referrer: "", commuteMethod: "", emergencyContact: { name: "", relation: "", tel: "" }, certificates: { mental: { status: "", note: "" }, rehabilitation: { status: "", note: "" }, physical: { status: "", note: "" }, devDisability: { has: "", note: "" } }, financial: { pension: { has: "", note: "" }, welfare: { has: "", note: "" } }, medical: { hospital: "", diagnosis: "", medication: "", doctor: "", psw: "", visitFrequency: "" }, workHistory: [], likesDislikes: { work: "", person: "" }, onsetAge: "", diagnosisAge: "", hospitalizationHistory: "", medicalAdvice: "", medicationManagement: "", symptomStability: "", currentMentalState: "", triggers: "", coping: "", lifeSituation: "", familySituation: "", personality: "", upbringing: "", dailyLife: { wakeTime: "", sleepTime: "", commSkill: "", literacy: "", numeracy: "", strengths: "", challenges: "", concerns: "" }, familyStructure: [], checklist: { health: { physical: { score: 0, note: "" }, medication: { score: 0, note: "" }, diet: { score: 0, note: "" } }, daily: { rhythm: { score: 0, note: "" }, appearance: { score: 0, note: "" }, cleanliness: { score: 0, note: "" }, money: { score: 0, note: "" }, mobility: { score: 0, note: "" } }, social: { expression: { score: 0, note: "" }, communication: { score: 0, note: "" }, emotion: { score: 0, note: "" }, cooperation: { score: 0, note: "" } }, work: { understanding: { score: 0, note: "" }, intention: { score: 0, note: "" }, motivation: { score: 0, note: "" }, endurance: { score: 0, note: "" }, familySupport: { score: 0, note: "" } } }, basicHabits: { greeting: { has: false, note: "" }, reporting: { has: false, note: "" }, attendance: { has: false, note: "" }, discipline: { has: false, note: "" } }, desiredSupport: { items: [], detail: "" }, overallOpinion: { desiredWork: "", readiness: "", suitability: "", futureTasks: "", remarks: "" } };
        const initialPlan = { periodStart: "", periodEnd: "", monitoringDate: "", userDesire: "", familyDesire: "", needs: "", longTermGoal: "", shortTermGoal: "", supportContent: "", staff: "", approver: "", explainDate: "" };
        const initialMon = { date: "", interviewer: "", location: "", currentStatus: "", needs: "", anxiety: "", satisfaction: "", futureTasks: "", feedback: "" };
        const initialTerm = { date: "", goals: [1,2,3,4].map(id => ({ id, target: "", achievement: "", overall: "", satisfaction: "", nextOpinion: "" })) };

        const getInitialUserState = () => ({ id: null, name: "新規利用者", status: "未定", application: initialApp, assessment: initialAss, plan: initialPlan, monitoring: initialMon, termination: initialTerm, dailyRecords: [], interviewRecords: [] });

        const checkDeadlineAlert = (targetDateStr, completedDateStr, label) => {
            if (!targetDateStr) return { isAlert: false, message: '', type: null };
            if (completedDateStr) return { isAlert: false, message: '', type: null }; 
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const targetDate = new Date(targetDateStr);
            if (isNaN(targetDate.getTime())) return { isAlert: false, message: '', type: null };
            targetDate.setHours(0, 0, 0, 0);
            const alertStartDate = new Date(targetDate); alertStartDate.setDate(targetDate.getDate() - 30);
            if (today > targetDate) {
                const diffDays = Math.floor((today - targetDate) / (1000 * 60 * 60 * 24));
                return { isAlert: true, message: `${label}の期限を${diffDays}日過ぎています`, type: 'danger' };
            } else if (today >= alertStartDate) {
                const diffDays = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));
                return { isAlert: true, message: `${label}まであと${diffDays}日です`, type: 'warning' };
            }
            return { isAlert: false, message: '', type: null };
        };

        const determineStatus = (u) => {
            if (u?.plan?.periodStart && u?.plan?.periodEnd && u?.plan?.approver) return "利用中";
            if (u?.application?.schedule?.trial1 || u?.application?.schedule?.trial2) return "体験利用中";
            if (u?.application?.receptionDate && u?.application?.applicantName) return "見学対応中";
            return "未定"; 
        };

        const mergeUser = (u) => {
            const init = getInitialUserState();
            const merged = { ...init, ...u, application: { ...init.application, ...(u?.application || {}), schedule: { ...init.application.schedule, ...(u?.application?.schedule || {}) } }, assessment: { ...init.assessment, ...(u?.assessment || {}) }, plan: { ...init.plan, ...(u?.plan || {}) }, monitoring: { ...init.monitoring, ...(u?.monitoring || {}) }, termination: { ...init.termination, ...(u?.termination || {}) }, dailyRecords: u?.dailyRecords || [], interviewRecords: u?.interviewRecords || [] };
            merged.status = determineStatus(merged);
            return merged;
        };

        const Card = ({ title, children, className = "" }) => (
            <div className={`bg-white rounded-lg shadow-sm border border-slate-200 mb-6 ${className}`}>
                {title && <div className="px-6 py-4 border-b border-slate-100"><h3 className="text-lg font-bold text-slate-800">{title}</h3></div>}
                <div className="p-6">{children}</div>
            </div>
        );
        const InputGroup = ({ label, children }) => (<div className="mb-4"><label className="block text-sm font-medium text-slate-600 mb-1">{label}</label>{children}</div>);
        const TextInput = ({ value, onChange, placeholder, type = "text", className = "", step }) => (<input type={type} step={step} className={`w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white ${className}`} value={value || ""} onChange={onChange} placeholder={placeholder} />);
        const TextArea = ({ value, onChange, rows = 3, placeholder }) => (<textarea className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-white" rows={rows} value={value || ""} onChange={onChange} placeholder={placeholder} />);
        const Select = ({ value, onChange, options = [], placeholder = "選択" }) => (
            <div className="relative"><select className="w-full px-3 py-2 border border-slate-300 rounded-md text-sm appearance-none bg-white" value={value || ""} onChange={onChange}><option value="">{placeholder}</option>{options.map(o => <option key={o.val} value={o.val}>{o.lbl}</option>)}{value && !options.find(o=>o.val===value) && <option value={value}>{value}</option>}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon name="chevron-down" size={16} /></div></div>
        );
        const Checkbox = ({ label, checked, onChange }) => (<label className="flex items-center space-x-2 mr-4 mb-2 cursor-pointer"><input type="checkbox" checked={!!checked} onChange={onChange} className="w-4 h-4 text-blue-600 rounded" /><span className="text-sm">{label}</span></label>);
        const Radio = ({ label, name, value, checked, onChange }) => (<label className="flex items-center space-x-2 cursor-pointer mr-4"><input type="radio" name={name} value={value} checked={!!checked} onChange={onChange} className="w-4 h-4 text-blue-600 border-slate-300" /><span className="text-sm text-slate-700">{label}</span></label>);
        const SectionHeader = ({ text }) => <h4 className="text-md font-bold text-slate-700 mt-6 mb-3 border-l-4 border-blue-500 pl-3">{text}</h4>;
        const AutoFillDisplay = ({ label, value }) => (<div className="mb-4"><label className="block text-xs font-bold text-blue-600 mb-1 flex items-center">{label} <span className="ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-normal">自動反映</span></label><div className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-md text-sm text-slate-700 min-h-[38px] flex items-center">{value || "（未入力）"}</div></div>);
        const AlertBanner = ({ alert, dateLabel, date }) => {
            if (!alert || !alert.isAlert) return null;
            return (
                <div className={`mb-4 p-4 rounded-md border flex items-start gap-3 shadow-sm ${alert.type === 'danger' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-yellow-50 border-yellow-200 text-yellow-800'}`}>
                    <Icon name="bell" className={`flex-shrink-0 ${alert.type === 'danger' ? 'text-red-500' : 'text-yellow-600'}`} />
                    <div><div className="font-bold">期限の確認が必要です</div><div className="text-sm mt-1">{alert.message}（{dateLabel}: {date}）</div></div>
                </div>
            );
        };

        const TopicsDashboard = ({ users }) => {
            const [summary, setSummary] = useState(localStorage.getItem('knowbe_topics_summary') || "");
            const [lastGen, setLastGen] = useState(localStorage.getItem('knowbe_topics_lastGen') || "");
            const [isGen, setIsGen] = useState(false);

            const generate = async () => {
                setIsGen(true);
                const oneMonthAgo = new Date(); 
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                
                let dataStr = "";
                users.forEach(u => {
                    let recs = [];
                    (u.dailyRecords || []).forEach(r => { 
                        if (new Date(r.date) >= oneMonthAgo) recs.push(`[支援 ${r.date}] 体調:${r.condition}, ${r.content}`); 
                    });
                    (u.interviewRecords || []).forEach(r => { 
                        if (new Date(r.date) >= oneMonthAgo) recs.push(`[面談 ${r.date}] ${r.content}`); 
                    });
                    
                    if (recs.length > 0) {
                        dataStr += `\n【利用者: ${u.name || "未設定"}】\n`;
                        dataStr += `特性/配慮事項: ${u.assessment?.triggers || '特になし'}, ${u.assessment?.coping || '特になし'}\n`;
                        dataStr += `記録:\n${recs.join("\n")}\n`;
                    }
                });

                if (!dataStr) {
                    setSummary("直近1ヶ月の記録がありません。");
                    setIsGen(false);
                    return;
                }

                // プレビュー環境用のAPIキー設定（空文字で環境から自動取得）
                const apiKey = ""; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const q = `以下の直近1ヶ月の記録を元に、職員の朝礼・終礼等で共有すべき「連絡事項・トピックス」を作成してください。\n情報がある利用者ごとに、以下の構成で簡潔にまとめてください。\n\n■ 【利用者名】\n・重要な点（最近の様子や変化など）\n・対応（行った支援や決定事項など）\n・気を付ける点（今後の配慮事項や注意点など）\n\nデータ:\n${dataStr}`;

                let retries = 5; 
                let delay = 1000; 
                let success = false;
                let lastErrorMsg = "";
                
                while (retries > 0 && !success) {
                    try {
                        const res = await fetch(url, { 
                            method: "POST", 
                            headers: { "Content-Type": "application/json" }, 
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: q }] }], 
                                systemInstruction: { parts: [{ text: "あなたは就労支援施設の経験豊富なサービス管理責任者です。職員間の円滑な情報共有のための的確な要約を作成します。" }] } 
                            }) 
                        });
                        
                        const result = await res.json();
                        
                        if (!res.ok) {
                            throw new Error(result.error?.message || `HTTPエラー ${res.status}`);
                        }
                        if (result.error) {
                            throw new Error(result.error.message);
                        }
                        
                        const txt = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (txt) {
                            const t = txt.trim();
                            setSummary(t);
                            const now = new Date().toLocaleString('ja-JP');
                            setLastGen(now);
                            localStorage.setItem('knowbe_topics_summary', t);
                            localStorage.setItem('knowbe_topics_lastGen', now);
                            success = true;
                        } else {
                            throw new Error("生成されたテキストが空でした");
                        }
                    } catch (e) {
                        lastErrorMsg = e.message;
                        retries--;
                        if (retries > 0) { 
                            await new Promise(r => setTimeout(r, delay)); 
                            delay *= 2; 
                        }
                    }
                }
                
                if (!success) {
                    alert(`AI要約の生成に失敗しました。\n\n【エラー内容】\n${lastErrorMsg}\n\n時間をおいて再度お試しいただくか、エラー内容をご確認ください。`);
                }
                setIsGen(false);
            };

            return (
                <div className="mb-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-2">
                        <h2 className="text-lg font-bold flex items-center gap-2 text-slate-800"><Icon name="bell-ring" className="text-blue-500" />連絡事項・トピックス (AI要約)</h2>
                        <div className="flex items-center gap-3">
                            {lastGen && <span className="text-xs text-slate-500">最終更新: {lastGen}</span>}
                            <button onClick={generate} disabled={isGen} className="bg-purple-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 hover:bg-purple-700 disabled:opacity-50 shadow-sm"><Icon name="wand-2" size={14}/> {isGen ? '要約中...' : '最新情報で要約生成'}</button>
                        </div>
                    </div>
                    <div className="bg-white rounded shadow-sm border border-slate-200 p-4 max-h-80 overflow-y-auto custom-scrollbar">
                        {summary ? (
                            <div className="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">{summary}</div>
                        ) : (
                            <div className="p-8 text-center text-slate-400 text-sm">
                                <Icon name="inbox" size={32} className="mx-auto mb-2 opacity-50" />
                                <p className="font-bold text-slate-500 mb-1">AI要約がまだ生成されていません</p>
                                <p>「要約生成」ボタンを押すと、直近の記録から共有事項をまとめます。</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SummaryView = ({ user }) => {
            const app = user?.application || {};
            const ass = user?.assessment || {};
            const pln = user?.plan || {};
            const mon = user?.monitoring || {};
            const trm = user?.termination || {};

            const monAlert = checkDeadlineAlert(pln?.monitoringDate, mon?.date, "モニタリング");
            const termAlert = checkDeadlineAlert(pln?.periodEnd, trm?.date, "終了評価");

            const InfoItem = ({ label, value, important = false }) => (
                <div className="mb-3"><div className={`text-xs font-bold mb-1 ${important ? 'text-red-600' : 'text-slate-500'}`}>{label} {important && <span className="text-xs bg-red-100 text-red-600 px-1 rounded ml-1">重要</span>}</div><div className={`text-sm ${value ? 'text-slate-800' : 'text-slate-400 italic'}`}>{value || "（情報なし）"}</div></div>
            );

            return (
                <div className="animate-fade-in">
                    {monAlert?.isAlert && <AlertBanner alert={monAlert} dateLabel="予定日" date={pln?.monitoringDate} />}
                    {termAlert?.isAlert && <AlertBanner alert={termAlert} dateLabel="計画終了日" date={pln?.periodEnd} />}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div className="space-y-6">
                            <Card title="基本情報・緊急連絡先" className="border-l-4 border-l-blue-500">
                                <div className="flex justify-between items-start mb-4"><div><h2 className="text-2xl font-bold text-slate-800">{app?.applicantName} <span className="text-sm font-normal text-slate-500">({app?.applicantNameKana})</span></h2><div className="flex gap-2 mt-1"><span className="text-sm bg-slate-100 px-2 py-0.5 rounded text-slate-600">{app?.gender}</span><span className="text-sm bg-slate-100 px-2 py-0.5 rounded text-slate-600">{app?.age}歳</span>{(app?.disabilityType || []).map(t => (<span key={t} className="text-sm bg-blue-100 px-2 py-0.5 rounded text-blue-700">{t}</span>))}</div></div><div className="text-right"><div className="text-sm font-bold text-slate-500">障害等級</div><div className="text-lg">{app?.disabilityGrade || "-"}</div></div></div>
                                <div className="grid grid-cols-2 gap-4 bg-red-50 p-4 rounded-md border border-red-100 mb-4"><div><div className="text-xs font-bold text-red-700 mb-1">緊急連絡先</div><div className="font-bold text-slate-800">{ass?.emergencyContact?.name} <span className="text-sm font-normal">({ass?.emergencyContact?.relation})</span></div><div className="text-slate-700">{ass?.emergencyContact?.tel}</div></div><div><div className="text-xs font-bold text-red-700 mb-1">診断名・病名</div><div className="font-bold text-slate-800">{ass?.medical?.diagnosis || app?.disabilityName || "（未記入）"}</div></div></div>
                                <InfoItem label="通院先・主治医" value={`${ass?.medical?.hospital || ''} / ${ass?.medical?.doctor || ''}`} /><InfoItem label="服薬状況・管理" value={ass?.medical?.medication} />
                            </Card>
                            <Card title="特性・配慮事項" className="border-l-4 border-l-orange-400"><InfoItem label="調子を崩す前兆（サイン）" value={ass?.triggers} important /><InfoItem label="調子を崩した時の対処法" value={ass?.coping} important /><div className="my-4 border-t border-slate-100"></div><InfoItem label="得意なこと・強み" value={ass?.dailyLife?.strengths || (ass?.workHistory || []).map(w => w.content).join(", ")} /><InfoItem label="苦手なこと・課題" value={ass?.dailyLife?.challenges} /><InfoItem label="コミュニケーションの特性" value={ass?.dailyLife?.commSkill} /></Card>
                        </div>
                        <div className="space-y-6">
                            <Card title="支援目標・方針" className="border-l-4 border-l-green-500"><InfoItem label="本人の希望（将来の目標）" value={pln?.userDesire || app?.futureGoal} /><div className="bg-green-50 p-3 rounded mb-3"><InfoItem label="短期目標（〜6ヶ月）" value={pln?.shortTermGoal} /></div><InfoItem label="長期目標（約1年）" value={pln?.longTermGoal} /><InfoItem label="具体的な支援内容" value={pln?.supportContent} /></Card>
                            <Card title="直近の状況・評価" className="border-l-4 border-l-indigo-500">
                                <div className="mb-4"><div className="text-xs font-bold text-slate-500 mb-1">直近のモニタリング ({mon?.date || "実施なし"})</div><div className="bg-slate-50 p-3 rounded border border-slate-100"><div className="text-sm mb-2"><span className="font-bold">現状:</span> {mon?.currentStatus || "記録なし"}</div><div className="text-sm mb-2"><span className="font-bold">満足度:</span> {mon?.satisfaction || "-"}</div><div className="text-sm"><span className="font-bold">今後の課題:</span> {mon?.futureTasks || "-"}</div></div></div>
                                {trm?.date && (<div className="mb-4"><div className="text-xs font-bold text-slate-500 mb-1">終了評価 ({trm?.date})</div><div className="bg-slate-50 p-3 rounded border border-slate-100"><div className="text-sm">{(trm?.goals || []).map(g => g.overall).filter(o => o).join(" / ") || "全体評価の記述なし"}</div></div></div>)}
                                <InfoItem label="事業所に望む支援" value={ass?.desiredSupport?.detail || (ass?.desiredSupport?.items || []).join(", ")} />
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        const ApplicationForm = ({ data = {}, onChange, staffs = [] }) => {
            const u = (f, v) => onChange({ ...data, [f]: v });
            const uS = (f, v) => onChange({ ...data, schedule: { ...(data?.schedule || {}), [f]: v } });
            const hc = (f, i) => { const c = data?.[f] || []; if (c.includes(i)) u(f, c.filter(x => x !== i)); else u(f, [...c, i]); };
            const sOpts = staffs.map(s => ({val: s.name, lbl: s.name}));
            const tOpts = ["10:00～11:00", "10:00～12:00", "10:00～14:00", "10:00～15:00", "11:00～12:00", "11:00～14:00", "11:00～15:00", "13:00～14:00", "13:00～15:00", "14:00～15:00"];

            return (
                <div className="animate-fade-in">
                    <Card title="基本情報・連絡先">
                        <div className="grid grid-cols-2 gap-4"><InputGroup label="受付日"><TextInput type="date" value={data?.receptionDate} onChange={e => u('receptionDate', e.target.value)} /></InputGroup><InputGroup label="対応者"><Select value={data?.interviewer} onChange={e=>u('interviewer',e.target.value)} options={sOpts}/></InputGroup></div>
                        <div className="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded border border-blue-100 mb-4"><InputGroup label="氏名" required><TextInput value={data?.applicantName} onChange={e=>u('applicantName',e.target.value)} className="font-bold"/></InputGroup><InputGroup label="フリガナ"><TextInput value={data?.applicantNameKana} onChange={e=>u('applicantNameKana',e.target.value)}/></InputGroup><InputGroup label="生年月日"><TextInput type="date" value={data?.dob} onChange={e=>u('dob',e.target.value)}/></InputGroup><InputGroup label="年齢"><TextInput type="number" value={data?.age} onChange={e=>u('age',e.target.value)}/></InputGroup></div>
                        <InputGroup label="性別"><div className="flex mt-2">{['男性','女性','その他'].map(g=><Radio key={g} label={g} name="gender" value={g} checked={data?.gender===g} onChange={()=>u('gender',g)}/>)}</div></InputGroup>
                        <div className="grid grid-cols-2 gap-4"><InputGroup label="住所"><TextInput value={data?.address} onChange={e=>u('address',e.target.value)}/></InputGroup><InputGroup label="電話番号"><TextInput value={data?.phone} onChange={e=>u('phone',e.target.value)}/></InputGroup></div>
                        <InputGroup label="メール"><TextInput value={data?.email} onChange={e=>u('email',e.target.value)}/></InputGroup>
                    </Card>
                    <Card title="障害・手帳情報">
                        <InputGroup label="障害種別"><div className="flex flex-wrap">{['身体障害','知的障害','精神障害'].map(t=><Checkbox key={t} label={t} checked={(data?.disabilityType||[]).includes(t)} onChange={()=>hc('disabilityType',t)}/>)}</div></InputGroup>
                        <div className="grid grid-cols-2 gap-4"><InputGroup label="病名・障害名"><TextInput value={data?.disabilityName} onChange={e=>u('disabilityName',e.target.value)}/></InputGroup><InputGroup label="障害等級"><TextInput value={data?.disabilityGrade} onChange={e=>u('disabilityGrade',e.target.value)}/></InputGroup></div>
                    </Card>
                    <Card title="アンケート">
                        <InputGroup label="ご利用経験"><div className="flex"><Radio label="はい" name="exp" checked={data?.hasExperience==='はい'} onChange={()=>u('hasExperience','はい')}/><Radio label="いいえ" name="exp" checked={data?.hasExperience==='いいえ'} onChange={()=>u('hasExperience','いいえ')}/></div></InputGroup>
                        <InputGroup label="本日聞きたいこと"><TextArea value={data?.todayQuestion} onChange={e=>u('todayQuestion',e.target.value)}/></InputGroup>
                        <InputGroup label="現在の悩み"><div className="flex flex-wrap">{['生活リズム','得意不得意不明','日中の居場所','交友関係','不眠','人間関係','仕事の悩み'].map(i=><Checkbox key={i} label={i} checked={(data?.concerns||[]).includes(i)} onChange={()=>hc('concerns',i)}/>)}</div></InputGroup>
                        <InputGroup label="今後頑張りたいこと"><TextArea value={data?.futureGoal} onChange={e=>u('futureGoal',e.target.value)}/></InputGroup>
                    </Card>
                    <Card title="今後の予定管理">
                        <div className="grid grid-cols-1 gap-4">
                            <InputGroup label="体験1回目"><div className="flex gap-2"><TextInput type="date" value={data?.schedule?.trial1} onChange={e=>uS('trial1',e.target.value)}/><Select value={data?.schedule?.trial1Time} onChange={e=>uS('trial1Time',e.target.value)} options={tOpts.map(t=>({val:t,lbl:t}))}/></div></InputGroup>
                            <InputGroup label="体験2回目"><div className="flex gap-2"><TextInput type="date" value={data?.schedule?.trial2} onChange={e=>uS('trial2',e.target.value)}/><Select value={data?.schedule?.trial2Time} onChange={e=>uS('trial2Time',e.target.value)} options={tOpts.map(t=>({val:t,lbl:t}))}/></div></InputGroup>
                            <InputGroup label="体験3回目"><div className="flex gap-2"><TextInput type="date" value={data?.schedule?.trial3} onChange={e=>uS('trial3',e.target.value)}/><Select value={data?.schedule?.trial3Time} onChange={e=>uS('trial3Time',e.target.value)} options={tOpts.map(t=>({val:t,lbl:t}))}/></div></InputGroup>
                            <div className="grid grid-cols-2 gap-4"><InputGroup label="受給者証発行日"><TextInput type="date" value={data?.schedule?.certificateDate} onChange={e=>uS('certificateDate',e.target.value)}/></InputGroup><InputGroup label="契約予定日"><TextInput type="date" value={data?.schedule?.contractDate} onChange={e=>uS('contractDate',e.target.value)}/></InputGroup></div>
                        </div>
                    </Card>
                </div>
            );
        };

        const AssessmentForm = ({ data = {}, onChange }) => {
            const [tab, setTab] = useState(0);
            const u = (f, v) => onChange({ ...data, [f]: v });
            const uN = (p, f, v) => onChange({ ...data, [p]: { ...(data?.[p] || {}), [f]: v } });
            const rr = (lbl, cat, f) => {
                const val = data?.checklist?.[cat]?.[f] || { score: 0, note: "" };
                return (
                    <div className="border-b py-2 flex gap-4 items-center" key={f}>
                        <span className="w-32 text-sm">{lbl}</span>
                        <select className="border p-1 text-sm rounded w-24" value={val.score} onChange={e=>onChange({...data, checklist: {...(data?.checklist||{}), [cat]: {...(data?.checklist?.[cat]||{}), [f]: {...val, score: parseInt(e.target.value)}}}})}>
                            <option value="0">-</option><option value="1">1. 出来る</option><option value="2">2. 少し必要</option><option value="3">3. 必要</option><option value="4">4. 出来ない</option>
                        </select>
                        <TextInput className="flex-1" placeholder="特記事項" value={val.note} onChange={e=>onChange({...data, checklist: {...(data?.checklist||{}), [cat]: {...(data?.checklist?.[cat]||{}), [f]: {...val, note: e.target.value}}}})} />
                    </div>
                );
            };
            return (
                <div className="animate-fade-in">
                    <div className="flex space-x-1 bg-slate-200 p-1 rounded-lg mb-6 overflow-x-auto">{["基本情報", "就労・生活歴", "日常生活", "就労評価", "総合所見"].map((t, i) => (<button key={i} onClick={() => setTab(i)} className={`flex-1 py-2 px-4 rounded-md text-sm font-medium whitespace-nowrap ${tab === i ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-600 hover:bg-slate-300'}`}>{t}</button>))}</div>
                    {tab === 0 && (<Card title="基本情報"><div className="grid grid-cols-2 gap-4"><InputGroup label="作成日"><TextInput type="date" value={data?.createDate} onChange={e=>u('createDate',e.target.value)}/></InputGroup><InputGroup label="通所方法"><TextInput value={data?.commuteMethod} onChange={e=>u('commuteMethod',e.target.value)}/></InputGroup><div className="col-span-2 bg-slate-50 p-4 rounded"><h5 className="font-bold mb-2">緊急連絡先</h5><div className="grid grid-cols-3 gap-2"><TextInput placeholder="氏名" value={data?.emergencyContact?.name} onChange={e=>uN('emergencyContact','name',e.target.value)}/><TextInput placeholder="続柄" value={data?.emergencyContact?.relation} onChange={e=>uN('emergencyContact','relation',e.target.value)}/><TextInput placeholder="TEL" value={data?.emergencyContact?.tel} onChange={e=>uN('emergencyContact','tel',e.target.value)}/></div></div><div className="col-span-2"><SectionHeader text="医療情報"/><div className="grid grid-cols-2 gap-4"><InputGroup label="通院先"><TextInput value={data?.medical?.hospital} onChange={e=>uN('medical','hospital',e.target.value)}/></InputGroup><InputGroup label="診断名"><TextInput value={data?.medical?.diagnosis} onChange={e=>uN('medical','diagnosis',e.target.value)}/></InputGroup></div></div></div></Card>)}
                    {tab === 1 && (<Card title="就労・生活歴"><SectionHeader text="職歴"/>{(data?.workHistory||[]).map((work, idx) => (<div key={idx} className="bg-slate-50 p-3 rounded mb-3 border border-slate-200"><div className="grid grid-cols-2 gap-2 mb-2"><TextInput placeholder="会社名" value={work.company} onChange={e=>{const l=[...(data?.workHistory||[])];l[idx].company=e.target.value;u('workHistory',l)}}/><TextInput placeholder="雇用形態" value={work.type} onChange={e=>{const l=[...(data?.workHistory||[])];l[idx].type=e.target.value;u('workHistory',l)}}/></div><TextArea placeholder="仕事内容" rows={2} value={work.content} onChange={e=>{const l=[...(data?.workHistory||[])];l[idx].content=e.target.value;u('workHistory',l)}}/></div>))}<button className="text-sm text-blue-600 hover:text-blue-800 mb-6" onClick={()=>u('workHistory',[...(data?.workHistory||[]),{company:"",content:"",type:""}])}>+ 職歴追加</button><SectionHeader text="病歴・障害履歴"/><div className="grid grid-cols-1 gap-4"><InputGroup label="現在の精神状況"><TextArea value={data?.currentMentalState} onChange={e=>u('currentMentalState',e.target.value)}/></InputGroup><InputGroup label="調子を崩す前兆（誘因）"><TextArea value={data?.triggers} onChange={e=>u('triggers',e.target.value)}/></InputGroup><InputGroup label="調子を崩した時の対処"><TextArea value={data?.coping} onChange={e=>u('coping',e.target.value)}/></InputGroup></div></Card>)}
                    {tab === 2 && (<Card title="日常生活の状況"><div className="grid grid-cols-2 gap-4 mb-4"><InputGroup label="起床"><TextInput type="time" value={data?.dailyLife?.wakeTime} onChange={e=>uN('dailyLife','wakeTime',e.target.value)}/></InputGroup><InputGroup label="就寝"><TextInput type="time" value={data?.dailyLife?.sleepTime} onChange={e=>uN('dailyLife','sleepTime',e.target.value)}/></InputGroup></div><InputGroup label="コミュニケーション"><TextArea value={data?.dailyLife?.commSkill} onChange={e=>uN('dailyLife','commSkill',e.target.value)}/></InputGroup><SectionHeader text="家族構成"/>{(data?.familyStructure||[]).map((fam, idx) => (<div key={idx} className="flex gap-2 mb-2"><TextInput placeholder="氏名" value={fam.name} onChange={e=>{const l=[...(data?.familyStructure||[])];l[idx].name=e.target.value;u('familyStructure',l)}}/><TextInput placeholder="続柄" value={fam.relation} onChange={e=>{const l=[...(data?.familyStructure||[])];l[idx].relation=e.target.value;u('familyStructure',l)}}/><TextInput placeholder="年齢" className="w-20" value={fam.age} onChange={e=>{const l=[...(data?.familyStructure||[])];l[idx].age=e.target.value;u('familyStructure',l)}}/><TextInput placeholder="職業・備考" value={fam.note} onChange={e=>{const l=[...(data?.familyStructure||[])];l[idx].note=e.target.value;u('familyStructure',l)}}/></div>))}<button className="text-sm text-blue-600 hover:text-blue-800" onClick={()=>u('familyStructure',[...(data?.familyStructure||[]),{name:"",relation:""}])}>+ 家族追加</button></Card>)}
                    {tab === 3 && (<Card title="就労評価"><div className="bg-blue-50 p-4 rounded mb-6 text-sm"><strong>評価基準:</strong> 1.出来る / 2.少し必要 / 3.必要 / 4.出来ない</div><SectionHeader text="1. 健康管理"/>{rr('体調管理','health','physical')}{rr('服薬管理','health','medication')}<SectionHeader text="2. 日常生活管理"/>{rr('生活リズム','daily','rhythm')}{rr('身だしなみ','daily','appearance')}<SectionHeader text="3. 対人技能"/>{rr('意思伝達','social','expression')}{rr('協調性','social','cooperation')}<SectionHeader text="4. 就労"/>{rr('就労意欲','work','motivation')}{rr('体力・精神力','work','endurance')}</Card>)}
                    {tab === 4 && (<Card title="総合所見"><SectionHeader text="当該事業所に望む支援"/><div className="flex flex-wrap mb-2">{['就職先の確保','実習先の確保','職場定着','生活支援'].map(i=><Checkbox key={i} label={i} checked={(data?.desiredSupport?.items||[]).includes(i)} onChange={()=>{const c=data?.desiredSupport?.items||[]; uN('desiredSupport','items',c.includes(i)?c.filter(x=>x!==i):[...c,i])}}/>)}</div><TextArea placeholder="その他の具体的内容" value={data?.desiredSupport?.detail} onChange={e=>uN('desiredSupport','detail',e.target.value)}/><SectionHeader text="総合所見"/><InputGroup label="本人が希望している就労内容"><TextArea value={data?.overallOpinion?.desiredWork} onChange={e=>uN('overallOpinion','desiredWork',e.target.value)}/></InputGroup><InputGroup label="今後必要となる力（課題）"><TextArea value={data?.overallOpinion?.futureTasks} onChange={e=>uN('overallOpinion','futureTasks',e.target.value)}/></InputGroup></Card>)}
                </div>
            );
        };

        const PlanForm = ({ data = {}, onChange }) => {
            const u = (f, v) => onChange({ ...data, [f]: v });
            return (
                <Card title="個別支援計画" className="animate-fade-in">
                    <div className="grid grid-cols-3 gap-4 mb-4"><InputGroup label="開始日"><TextInput type="date" value={data?.periodStart} onChange={e=>{const nd={...data,periodStart:e.target.value};if(e.target.value){const d=new Date(e.target.value);d.setMonth(d.getMonth()+6);nd.monitoringDate=formatDateKey(d);}onChange(nd);}}/></InputGroup><InputGroup label="終了日"><TextInput type="date" value={data?.periodEnd} onChange={e=>u('periodEnd',e.target.value)}/></InputGroup><InputGroup label="モニタリング予定"><TextInput type="date" value={data?.monitoringDate} onChange={e=>u('monitoringDate',e.target.value)}/></InputGroup></div>
                    <SectionHeader text="意向・課題" /><InputGroup label="本人の希望"><TextArea value={data?.userDesire} onChange={e=>u('userDesire',e.target.value)}/></InputGroup><InputGroup label="課題(ニーズ)"><TextArea value={data?.needs} onChange={e=>u('needs',e.target.value)}/></InputGroup>
                    <SectionHeader text="目標" /><InputGroup label="長期目標"><TextArea value={data?.longTermGoal} onChange={e=>u('longTermGoal',e.target.value)}/></InputGroup><InputGroup label="短期目標"><TextArea value={data?.shortTermGoal} onChange={e=>u('shortTermGoal',e.target.value)}/></InputGroup>
                    <SectionHeader text="支援内容" /><InputGroup label="支援内容"><TextArea rows={4} value={data?.supportContent} onChange={e=>u('supportContent',e.target.value)}/></InputGroup>
                </Card>
            );
        };

        const MonitoringForm = ({ data = {}, onChange, planData = {}, staffs = [] }) => {
            const u = (f, v) => onChange({ ...data, [f]: v });
            const alert = checkDeadlineAlert(planData?.monitoringDate, data?.date, "モニタリング");
            return (
                <Card title="モニタリング記録" className="animate-fade-in">
                    <AlertBanner alert={alert} dateLabel="予定日" date={planData?.monitoringDate} />
                    <div className="grid grid-cols-3 gap-4 mb-4"><InputGroup label="面談日"><TextInput type="date" value={data?.date} onChange={e=>u('date', e.target.value)} /></InputGroup><InputGroup label="担当者"><Select value={data?.interviewer} onChange={e=>u('interviewer', e.target.value)} options={staffs.map(s=>({val:s.name,lbl:s.name}))} /></InputGroup><InputGroup label="面談場所"><TextInput value={data?.location} onChange={e=>u('location', e.target.value)} /></InputGroup></div>
                    <SectionHeader text="評価・振り返り" /><InputGroup label="現状"><TextArea value={data?.currentStatus} onChange={e=>u('currentStatus', e.target.value)} /></InputGroup><InputGroup label="現状のニーズ"><TextArea value={data?.needs} onChange={e=>u('needs', e.target.value)} /></InputGroup>
                    <SectionHeader text="今後の方針" /><InputGroup label="今後の課題及び解決方法"><TextArea value={data?.futureTasks} onChange={e=>u('futureTasks', e.target.value)} /></InputGroup>
                </Card>
            );
        };

        const TerminationForm = ({ data = {}, onChange, planData = {} }) => {
            const u = (f, v) => onChange({ ...data, [f]: v });
            const alert = checkDeadlineAlert(planData?.periodEnd, data?.date, "終了評価");
            return (
                <Card title="終了評価" className="animate-fade-in">
                    <AlertBanner alert={alert} dateLabel="計画終了日" date={planData?.periodEnd} />
                    <div className="mb-4"><InputGroup label="実施日"><TextInput type="date" value={data?.date} onChange={e=>u('date', e.target.value)} className="w-48" /></InputGroup></div>
                    <div className="overflow-x-auto"><table className="min-w-full text-sm border-collapse border border-slate-200"><thead className="bg-slate-50"><tr><th className="p-2 border border-slate-200">No.</th><th className="p-2 border border-slate-200">到達目標</th><th className="p-2 border border-slate-200">達成状況</th><th className="p-2 border border-slate-200">全体評価</th></tr></thead><tbody>
                        {(data?.goals || []).map(r => (
                            <tr key={r.id}>
                                <td className="p-2 border border-slate-200 text-center">{r.id}</td>
                                <td className="p-2 border border-slate-200"><TextArea rows={2} value={r.target} onChange={e=>{const g=[...data.goals]; g.find(x=>x.id===r.id).target=e.target.value; u('goals',g);}}/></td>
                                <td className="p-2 border border-slate-200"><TextArea rows={2} value={r.achievement} onChange={e=>{const g=[...data.goals]; g.find(x=>x.id===r.id).achievement=e.target.value; u('goals',g);}}/></td>
                                <td className="p-2 border border-slate-200"><TextArea rows={2} value={r.overall} onChange={e=>{const g=[...data.goals]; g.find(x=>x.id===r.id).overall=e.target.value; u('goals',g);}}/></td>
                            </tr>
                        ))}
                    </tbody></table></div>
                </Card>
            );
        };

        const DailyRecordForm = ({ data = [], assessment = {}, onChange }) => {
            const [f, setF] = useState({ date: formatDateKey(new Date()), condition: '普通', temperature: '', wakeTime: '', sleepTime: '', content: '' });
            const [gen, setGen] = useState(false);

            const generate = async () => {
                setGen(true);
                const query = `以下の情報で「支援記録」を150文字程度で作成。\n体調:${f.condition}, 体温:${f.temperature}℃, 起床:${f.wakeTime}, 就寝:${f.sleepTime}\n得意:${assessment?.dailyLife?.strengths||'なし'}\n苦手:${assessment?.dailyLife?.challenges||'なし'}`;
                
                // プレビュー環境用のAPIキー設定（空文字で環境から自動取得）
                const apiKey = ""; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                let retries = 5;
                let delay = 1000;
                let success = false;
                let lastErrorMsg = "";

                while (retries > 0 && !success) {
                    try {
                        const res = await fetch(url, { 
                            method: "POST", 
                            headers: { "Content-Type": "application/json" }, 
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: query }] }], 
                                systemInstruction: { parts: [{ text: "あなたは就労支援施設の経験豊富な支援員です。" }] }
                            })
                        });
                        
                        const result = await res.json();
                        
                        if (!res.ok) {
                            throw new Error(result.error?.message || `HTTPエラー ${res.status}`);
                        }
                        if (result.error) {
                            throw new Error(result.error.message);
                        }
                        
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            setF({...f, content: text.trim()});
                            success = true;
                        } else {
                            throw new Error("生成されたテキストが空でした");
                        }
                    } catch(e) { 
                        lastErrorMsg = e.message;
                        retries--;
                        if (retries > 0) {
                            await new Promise(r => setTimeout(r, delay));
                            delay *= 2;
                        }
                    }
                }
                
                if (!success) {
                    alert(`AIの生成に失敗しました。\n\n【エラー内容】\n${lastErrorMsg}\n\n時間をおいて再度お試しいただくか、エラー内容をご確認ください。`); 
                }
                setGen(false);
            };

            return (
                <div className="space-y-4 animate-fade-in">
                    <Card title="支援記録の追加">
                        <div className="flex gap-2 mb-2">
                            <TextInput type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})} className="w-40"/>
                            <Select value={f.condition} onChange={e=>setF({...f,condition:e.target.value})} options={['良好','普通','やや不調','不調'].map(x=>({val:x,lbl:x}))} />
                            <TextInput type="number" placeholder="体温" value={f.temperature} onChange={e=>setF({...f,temperature:e.target.value})} className="w-24"/>
                        </div>
                        <div className="mb-2"><button onClick={generate} disabled={gen} className="bg-purple-600 text-white px-3 py-1 rounded text-xs"><Icon name="wand-2" size={12}/> AI自動作成</button></div>
                        <TextArea rows={3} value={f.content} onChange={e=>setF({...f,content:e.target.value})} />
                        <div className="text-right mt-2"><button onClick={()=>{if(f.date)onChange([...data,{id:Date.now(),...f}]); setF({...f,content:''})}} className="bg-blue-600 text-white px-4 py-1 rounded">保存</button></div>
                    </Card>
                    <Card title="過去の記録">
                        {data.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(r => (
                            <div key={r.id} className="border-b py-2 flex justify-between">
                                <div><span className="font-bold mr-2">{r.date}</span><span className="text-xs bg-slate-200 px-1 rounded">{r.condition}</span><p className="text-sm mt-1">{r.content}</p></div>
                                <button onClick={()=>onChange(data.filter(x=>x.id!==r.id))} className="text-red-500"><Icon name="trash-2" size={14}/></button>
                            </div>
                        ))}
                    </Card>
                </div>
            );
        };

        const InterviewRecordForm = ({ data = [], staffs = [], onChange }) => {
            const [f, setF] = useState({ date: formatDateKey(new Date()), interviewer: '', content: '' });
            return (
                <div className="space-y-4 animate-fade-in">
                    <Card title="面談記録の追加">
                        <div className="flex gap-2 mb-2"><TextInput type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})} className="w-40"/><Select value={f.interviewer} onChange={e=>setF({...f,interviewer:e.target.value})} options={staffs.map(s=>({val:s.name,lbl:s.name}))} /></div>
                        <TextArea rows={3} value={f.content} onChange={e=>setF({...f,content:e.target.value})} />
                        <div className="text-right mt-2"><button onClick={()=>{if(f.date&&f.content)onChange([...data,{id:Date.now(),...f}]); setF({...f,content:''})}} className="bg-blue-600 text-white px-4 py-1 rounded">保存</button></div>
                    </Card>
                    <Card title="過去の記録">
                        {data.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(r => (
                            <div key={r.id} className="border-b py-2 flex justify-between">
                                <div><span className="font-bold mr-2">{r.date}</span><span className="text-xs bg-blue-100 text-blue-800 px-1 rounded">{r.interviewer}</span><p className="text-sm mt-1 whitespace-pre-wrap">{r.content}</p></div>
                                <button onClick={()=>onChange(data.filter(x=>x.id!==r.id))} className="text-red-500"><Icon name="trash-2" size={14}/></button>
                            </div>
                        ))}
                    </Card>
                </div>
            );
        };

        // --- シフト表等 ---
        const StaffMonthlyShift = ({ staffs, staffShifts, onShiftChange }) => {
            const [cur, setCur] = useState(new Date());
            const days = Array.from({length: new Date(cur.getFullYear(), cur.getMonth()+1, 0).getDate()}, (_,i)=>new Date(cur.getFullYear(),cur.getMonth(),i+1));
            const opts = ["休","09:00-18:00","09:00-13:00","13:00-18:00","10:00-16:00"];
            
            return (
                <div className="w-full p-2 animate-fade-in">
                    <div className="flex justify-between mb-2"><h1 className="text-xl font-bold">職員シフト表(月)</h1><div><button onClick={()=>setCur(new Date(cur.getFullYear(),cur.getMonth()-1))} className="px-2 border rounded">{'<'}</button><span className="mx-2 font-bold">{cur.getFullYear()}年{cur.getMonth()+1}月</span><button onClick={()=>setCur(new Date(cur.getFullYear(),cur.getMonth()+1))} className="px-2 border rounded">{'>'}</button></div></div>
                    <div className="bg-white border rounded overflow-x-auto">
                        <table className="w-full text-[10px] table-fixed" style={{minWidth:'900px'}}>
                            <thead className="bg-slate-50"><tr><th className="w-20 p-1 border-r border-b">職員名</th>{days.map(d=><th key={d.getDate()} className="w-8 border-r border-b p-0">{d.getDate()}</th>)}</tr></thead>
                            <tbody>
                                {staffs.map(s => (
                                    <tr key={s.id} className="h-8">
                                        <td className="border-r border-b p-1 truncate">{s.name}</td>
                                        {days.map(d => {
                                            const dk = formatDateKey(d);
                                            const v = (staffShifts[dk] && staffShifts[dk][s.id])?.time || "";
                                            return (
                                                <td key={dk} className="border-r border-b p-0 relative">
                                                    <div className="absolute inset-0 flex flex-col items-center justify-center font-bold text-[8px] pointer-events-none">
                                                        {v.includes('-') ? (
                                                            <React.Fragment>
                                                                <span>{v.split('-')[0]}</span>
                                                                <span className="opacity-50 my-[-2px]">|</span>
                                                                <span>{v.split('-')[1]}</span>
                                                            </React.Fragment>
                                                        ) : (
                                                            <span>{v||'休'}</span>
                                                        )}
                                                    </div>
                                                    <select className="w-full h-full opacity-0 cursor-pointer" value={v} onChange={e=>e.target.value==='MAN'?onShiftChange(d,s.id,prompt('時間(例:09:00-17:00)',v)||v):onShiftChange(d,s.id,e.target.value)}>
                                                        {opts.map(o=><option key={o} value={o}>{o}</option>)}
                                                        {!opts.includes(v)&&v&&<option value={v}>{v}</option>}<option value="MAN">手動...</option>
                                                    </select>
                                                </td>
                                            )
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const DatePickerModal = ({ isOpen, onClose, currentDate, onSelectDate }) => {
            if(!isOpen) return null;
            return (
                <ModalPortal><div className="fixed inset-0 bg-black/30 z-[1000] flex items-center justify-center" onClick={onClose}>
                    <div className="bg-white p-4 rounded shadow-lg" onClick={e=>e.stopPropagation()}>
                        <input type="date" value={formatDateKey(currentDate)} onChange={e => { onSelectDate(new Date(e.target.value)); onClose(); }} />
                    </div>
                </div></ModalPortal>
            );
        };

        const SeatManagement = ({ users, staffs, userShifts, staffShifts, tasks, assignments, setAssignments, evaluations, setEvaluations, seatLayout, setSeatLayout }) => {
            const [cur, setCur] = useState(new Date());
            const [isDatePickerOpen, setIsDatePickerOpen] = useState(false);
            const [isEditMode, setIsEditMode] = useState(false);
            const [dragInfo, setDragInfo] = useState(null);

            const dk = formatDateKey(cur);
            const activeUsers = useMemo(() => users.filter(u => userShifts[dk]?.[u.id]?.checked), [users, userShifts, dk]);
            const dayAssign = assignments[dk] || {};
            const curEval = evaluations[dk] || "";
            
            const autoAssign = () => {
                const goodDates = Object.keys(evaluations).filter(d => evaluations[d] >= 3.5);
                if(goodDates.length===0) return alert("データ不足です。評価3.5以上を蓄積してください。");
                const prop = {}; const used = new Set();
                
                const userSeatScores = {};
                goodDates.forEach(date => {
                    const dailyAssign = assignments[date];
                    if (!dailyAssign) return;
                    Object.entries(dailyAssign).forEach(([seatId, data]) => {
                        const userId = data.userId;
                        if (!userSeatScores[userId]) userSeatScores[userId] = {};
                        userSeatScores[userId][seatId] = (userSeatScores[userId][seatId] || 0) + evaluations[date];
                    });
                });

                const userPreferences = activeUsers.map(u => {
                    const scores = userSeatScores[u.id] || {};
                    const preferredSeats = Object.keys(scores).sort((a, b) => scores[b] - scores[a]);
                    return { userId: String(u.id), preferredSeats };
                });

                userPreferences.forEach(({ userId, preferredSeats }) => {
                    let assigned = false;
                    for (const seatId of preferredSeats) {
                        if (seatLayout.find(s => s.id === seatId) && !used.has(seatId)) {
                            prop[seatId] = { userId, taskId: "" };
                            used.add(seatId);
                            assigned = true;
                            break;
                        }
                    }
                    if (!assigned) {
                         for (const seat of seatLayout) {
                             if (!used.has(seat.id)) {
                                 prop[seat.id] = { userId, taskId: "" };
                                 used.add(seat.id);
                                 break;
                             }
                         }
                    }
                });
                setAssignments({...assignments, [dk]:prop});
                alert("AI配置提案完了");
            };

            const handleMouseDown = (e, id, currentX, currentY) => {
                if (!isEditMode) return;
                e.preventDefault();
                setDragInfo({ id, startX: currentX, startY: currentY, mouseX: e.clientX, mouseY: e.clientY });
            };

            const handleMouseMove = (e) => {
                if (!dragInfo) return;
                const dx = e.clientX - dragInfo.mouseX;
                const dy = e.clientY - dragInfo.mouseY;
                const newLayout = seatLayout.map(s => 
                    s.id === dragInfo.id ? { ...s, x: dragInfo.startX + dx, y: dragInfo.startY + dy } : s
                );
                setSeatLayout(newLayout);
            };

            const handleMouseUp = () => setDragInfo(null);

            const addSeat = () => {
                const newId = String(Date.now());
                setSeatLayout([...seatLayout, { id: newId, x: 50, y: 50, r: 0, label: `席 ${seatLayout.length + 1}` }]);
            };
            const removeSeat = (id) => setSeatLayout(seatLayout.filter(s => s.id !== id));
            const rotateSeat = (id) => setSeatLayout(seatLayout.map(s => s.id === id ? { ...s, r: (s.r || 0) + 45 } : s));

            return (
                <div className="p-4 animate-fade-in" onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                    <div className="flex justify-between items-center mb-4">
                        <h1 className="text-xl font-bold">座席配置</h1>
                        <div className="flex gap-2 items-center">
                            {isEditMode ? (
                                <button onClick={() => setIsEditMode(false)} className="bg-orange-500 text-white px-4 py-1 rounded shadow text-sm font-bold flex items-center gap-1"><Icon name="check" size={14}/>編集完了</button>
                            ) : (
                                <React.Fragment>
                                    <button onClick={() => setIsEditMode(true)} className="border border-slate-300 bg-white hover:bg-slate-50 px-3 py-1 rounded text-sm flex items-center gap-1"><Icon name="settings" size={14}/>レイアウト編集</button>
                                    <button onClick={autoAssign} className="bg-purple-600 text-white hover:bg-purple-700 px-3 py-1 rounded text-sm flex items-center gap-1"><Icon name="wand-2" size={14}/>AI提案</button>
                                    <button onClick={()=>setIsDatePickerOpen(true)} className="border border-slate-300 bg-white p-1 rounded font-bold ml-2 px-3">{dk}</button>
                                </React.Fragment>
                            )}
                        </div>
                    </div>

                    {isEditMode && (
                        <div className="mb-4 bg-orange-50 p-3 rounded-lg border border-orange-200 flex items-center gap-4 shadow-sm">
                            <button onClick={addSeat} className="bg-white border border-slate-300 px-3 py-1.5 rounded-md text-sm font-bold hover:bg-slate-50 flex items-center gap-1 shadow-sm"><Icon name="plus" size={16}/> 座席を追加</button>
                            <span className="text-sm text-orange-800"><Icon name="info" size={16} className="inline mr-1"/>座席をドラッグして移動、右上のアイコンで回転・削除ができます。</span>
                        </div>
                    )}

                    <div className="flex flex-col lg:flex-row gap-4">
                        <div className="w-full lg:w-1/4 space-y-4 no-print flex-shrink-0">
                            {!isEditMode && (
                                <div className="flex items-center gap-2 bg-yellow-50 px-3 py-2 rounded border border-yellow-200 shadow-sm">
                                    <span className="text-sm font-bold text-yellow-800">本日の評価:</span>
                                    <select className="bg-transparent font-bold text-yellow-900 focus:outline-none cursor-pointer text-sm" value={curEval} onChange={(e) => setEvaluations({ ...evaluations, [dk]: Number(e.target.value) })}>
                                        <option value="">-</option><option value="5">5.0 (完璧)</option><option value="4.5">4.5</option><option value="4">4.0 (良)</option><option value="3.5">3.5</option><option value="3">3.0 (普通)</option><option value="2">2.0</option><option value="1">1.0 (要改善)</option>
                                    </select>
                                </div>
                            )}
                            <div className="bg-white p-4 rounded shadow-sm border border-slate-200">
                                <h3 className="font-bold text-slate-700 mb-2 flex items-center gap-2"><Icon name="users" size={16}/> 出勤利用者 ({activeUsers.length})</h3>
                                <div className="space-y-1 max-h-[300px] overflow-y-auto pr-1">
                                    {activeUsers.map(u => {
                                        const isAssigned = Object.values(dayAssign).some(a => String(a.userId) === String(u.id));
                                        return (
                                            <div key={u.id} className={`text-xs p-2 rounded flex justify-between items-center ${isAssigned ? 'bg-green-50 text-green-700 border border-green-100' : 'bg-slate-50 text-slate-700 border border-slate-200'}`}>
                                                <span>{u.name}</span>{isAssigned && <Icon name="check" size={12} />}
                                            </div>
                                        );
                                    })}
                                    {activeUsers.length === 0 && <div className="text-xs text-slate-400">予定なし</div>}
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex-1 bg-slate-100 p-4 border border-slate-300 rounded shadow-inner relative overflow-hidden" style={{ minHeight: '600px', backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 0)', backgroundSize: '20px 20px' }}>
                            {seatLayout.map(seat => {
                                const d = dayAssign[seat.id];
                                const user = d ? activeUsers.find(u => String(u.id) === String(d.userId)) : null;
                                
                                return (
                                    <div 
                                        key={seat.id} 
                                        className={`absolute border-2 rounded p-2 flex flex-col justify-between w-32 h-24 shadow-md bg-white ${isEditMode ? 'cursor-move ring-2 ring-orange-400 ring-offset-2 hover:bg-orange-50' : 'cursor-default'} ${user && !isEditMode ? 'border-blue-400 bg-blue-50/90' : 'border-slate-300'}`}
                                        style={{ left: seat.x, top: seat.y, transform: `rotate(${seat.r || 0}deg)`, transition: dragInfo?.id === seat.id ? 'none' : 'box-shadow 0.2s, background-color 0.2s', zIndex: dragInfo?.id === seat.id ? 50 : 10 }}
                                        onMouseDown={(e) => handleMouseDown(e, seat.id, seat.x, seat.y)}
                                    >
                                        <div className="flex justify-between items-center" style={{ transform: `rotate(-${seat.r || 0}deg)`, transformOrigin: 'center' }}>
                                            {isEditMode ? (
                                                <input type="text" value={seat.label} onChange={(e) => {
                                                    const val = e.target.value;
                                                    setSeatLayout(seatLayout.map(s => s.id === seat.id ? { ...s, label: val } : s));
                                                }} className="text-[10px] font-bold text-slate-700 w-16 bg-transparent border-b border-orange-300 focus:outline-none" onClick={e=>e.stopPropagation()}/>
                                            ) : (
                                                <span className="text-[10px] font-bold text-slate-500 bg-white/80 px-1 rounded">{seat.label || `Seat ${seat.id}`}</span>
                                            )}
                                            
                                            {isEditMode && (
                                                <div className="flex gap-1 bg-white rounded shadow-sm border p-0.5">
                                                    <button onClick={(e) => { e.stopPropagation(); rotateSeat(seat.id); }} className="text-slate-500 hover:text-blue-600 p-0.5"><Icon name="rotate-cw" size={12}/></button>
                                                    <button onClick={(e) => { e.stopPropagation(); removeSeat(seat.id); }} className="text-slate-500 hover:text-red-600 p-0.5"><Icon name="x" size={12}/></button>
                                                </div>
                                            )}
                                        </div>

                                        {!isEditMode ? (
                                            <div className="flex flex-col gap-1 w-full" style={{ transform: `rotate(-${seat.r || 0}deg)`, transformOrigin: 'center' }}>
                                                <select className={`w-full text-xs font-bold border-b pb-0.5 focus:outline-none ${user?'bg-transparent text-blue-900 border-blue-200':'bg-slate-50 border-slate-200 text-slate-600'}`} value={d?.userId||""} onChange={e=>{
                                                    const nd = {...dayAssign}; Object.keys(nd).forEach(k=>{if(nd[k]?.userId===e.target.value)delete nd[k]});
                                                    if(!e.target.value) delete nd[seat.id]; else nd[seat.id] = {userId:e.target.value, taskId:""};
                                                    setAssignments({...assignments, [dk]:nd});
                                                }}>
                                                    <option value="">(空席)</option>
                                                    {activeUsers.map(u=><option key={u.id} value={u.id}>{u.name}</option>)}
                                                </select>
                                                {user && (
                                                    <select className="w-full text-[10px] bg-white border border-blue-200 rounded text-slate-600 focus:outline-none p-0.5" value={d?.taskId||""} onChange={e=>{
                                                        const nd = {...dayAssign};
                                                        nd[seat.id] = { ...nd[seat.id], taskId: e.target.value };
                                                        setAssignments({...assignments, [dk]:nd});
                                                    }}>
                                                        <option value="">-- 作業 --</option>
                                                        {tasks.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}
                                                    </select>
                                                )}
                                            </div>
                                        ) : (
                                            <div className="flex-1 flex items-center justify-center pointer-events-none" style={{ transform: `rotate(-${seat.r || 0}deg)` }}>
                                                <Icon name="move" className="text-orange-300" size={24}/>
                                            </div>
                                        )}
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                    <DatePickerModal isOpen={isDatePickerOpen} onClose={() => setIsDatePickerOpen(false)} currentDate={cur} onSelectDate={setCur} />
                </div>
            );
        };

        const StaffManagement = ({ staffs, setStaffs }) => {
            const [form, setForm] = useState({ name: '', role: '' });
            const add = () => { if(form.name) { setStaffs([...staffs, { id: Date.now(), ...form }]); setForm({name:'', role:''}); } };
            return (
                <div className="max-w-4xl mx-auto p-4 animate-fade-in">
                    <h1 className="text-2xl font-bold mb-6">職員管理</h1>
                    <Card title="新規登録">
                        <div className="flex gap-4 items-end">
                            <div className="flex-1"><label className="block text-sm mb-1">氏名</label><TextInput value={form.name} onChange={e=>setForm({...form, name:e.target.value})} placeholder="例: 鈴木 一郎" /></div>
                            <div className="flex-1"><label className="block text-sm mb-1">役職</label><Select value={form.role} onChange={e=>setForm({...form, role:e.target.value})} options={[{val:'管理者',lbl:'管理者'},{val:'サービス管理責任者',lbl:'サービス管理責任者'},{val:'支援員',lbl:'支援員'}]} placeholder="役職を選択" /></div>
                            <button onClick={add} className="bg-blue-600 text-white px-6 py-2 rounded shadow-sm hover:bg-blue-700">追加</button>
                        </div>
                    </Card>
                    <div className="bg-white rounded shadow-sm border border-slate-200 overflow-hidden mt-6">
                        <table className="w-full text-left"><thead className="bg-slate-50"><tr><th className="p-3 text-slate-600 font-medium">氏名</th><th className="p-3 text-slate-600 font-medium">役職</th><th className="p-3 text-right text-slate-600 font-medium">操作</th></tr></thead><tbody>
                            {staffs.map(s => (<tr key={s.id} className="border-t hover:bg-slate-50"><td className="p-3 font-bold text-slate-700">{s.name}</td><td className="p-3 text-slate-600">{s.role}</td><td className="p-3 text-right"><button onClick={()=>setStaffs(staffs.filter(x=>x.id!==s.id))} className="text-red-500 hover:bg-red-50 p-1 rounded"><Icon name="trash-2" size={16}/></button></td></tr>))}
                            {staffs.length === 0 && <tr><td colSpan="3" className="p-8 text-center text-slate-400">職員が登録されていません</td></tr>}
                        </tbody></table>
                    </div>
                </div>
            );
        };

        const TaskManagement = ({ tasks, setTasks }) => {
            const [form, setForm] = useState({ name: '', description: '', level: '1', deadline: '1週間' });
            const deadlines = ["1週間", "2週間", "3週間", "4週間", "1ヶ月", "2ヶ月"];
            const add = () => { if(form.name) { setTasks([...tasks, { id: Date.now(), ...form }]); setForm({ name: '', description: '', level: '1', deadline: '1週間' }); } };

            return (
                <div className="max-w-4xl mx-auto p-4 animate-fade-in">
                    <h1 className="text-2xl font-bold mb-6">作業一覧</h1>
                    <Card title="新規作業登録">
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm mb-1">作業名</label><TextInput value={form.name} onChange={e=>setForm({...form, name:e.target.value})} placeholder="例: 箱折り" /></div>
                                <div><label className="block text-sm mb-1">レベル (5段階)</label><Select value={form.level} onChange={e=>setForm({...form, level:e.target.value})} options={[1, 2, 3, 4, 5].map(l => ({val:l, lbl:`レベル ${l}`}))} /></div>
                            </div>
                            <div><label className="block text-sm mb-1">内容</label><TextArea value={form.description} onChange={e=>setForm({...form, description:e.target.value})} placeholder="作業の詳細を記入" /></div>
                            <div><label className="block text-sm mb-1">納期</label><Select value={form.deadline} onChange={e=>setForm({...form, deadline:e.target.value})} options={deadlines.map(d => ({val:d, lbl:d}))} /></div>
                            <div className="flex justify-end"><button onClick={add} className="bg-blue-600 text-white px-6 py-2 rounded shadow-sm hover:bg-blue-700">登録</button></div>
                        </div>
                    </Card>
                    <div className="bg-white rounded shadow-sm border border-slate-200 overflow-hidden mt-6">
                        <table className="w-full text-left text-sm"><thead className="bg-slate-50"><tr><th className="p-3 text-slate-600 font-medium">作業名</th><th className="p-3 text-slate-600 font-medium">レベル</th><th className="p-3 text-slate-600 font-medium">納期</th><th className="p-3 text-slate-600 font-medium">内容</th><th className="p-3 text-right text-slate-600 font-medium">操作</th></tr></thead><tbody>
                            {tasks.map(t => (<tr key={t.id} className="border-t hover:bg-slate-50"><td className="p-3 font-bold text-slate-700">{t.name}</td><td className="p-3"><span className="bg-slate-100 px-2 py-1 rounded text-xs">Lv {t.level}</span></td><td className="p-3 text-slate-600">{t.deadline}</td><td className="p-3 text-slate-500 truncate max-w-xs">{t.description}</td><td className="p-3 text-right"><button onClick={()=>setTasks(tasks.filter(x=>x.id!==t.id))} className="text-red-500 hover:bg-red-50 p-1 rounded"><Icon name="trash-2" size={16}/></button></td></tr>))}
                            {tasks.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">登録された作業はありません</td></tr>}
                        </tbody></table>
                    </div>
                </div>
            );
        };

        const UserShiftManagement = ({ users, userShifts, onShiftChange }) => {
            const [cur, setCur] = useState(new Date());
            const dk = formatDateKey(cur);
            return (
                <div className="max-w-4xl mx-auto p-4 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold">利用者シフト管理</h1>
                        <div className="flex items-center gap-2 bg-white px-3 py-1 rounded border shadow-sm"><span className="text-sm text-slate-500 mr-2">対象日:</span><input type="date" value={dk} onChange={e=>setCur(new Date(e.target.value))} className="focus:outline-none font-bold text-slate-700"/></div>
                    </div>
                    <Card title="出勤予定の登録">
                        <div className="divide-y divide-slate-100">
                            {users.map(u => {
                                const s = userShifts[dk]?.[u.id] || {checked:false, time:"10:00-15:00"};
                                return (
                                    <div key={u.id} className="flex items-center justify-between py-3 hover:bg-slate-50 px-2 rounded transition-colors">
                                        <div className="flex items-center gap-3"><input type="checkbox" checked={s.checked} onChange={e=>onShiftChange(cur,u.id,'checked',e.target.checked)} className="w-5 h-5 text-blue-600 rounded border-slate-300 cursor-pointer"/><span className="font-bold text-slate-700">{u.name}</span></div>
                                        {s.checked && <div className="w-48"><Select value={s.time} onChange={e=>onShiftChange(cur,u.id,'time',e.target.value)} options={["10:00-15:00","10:00-12:00","13:00-15:00","10:00-14:00","11:00-15:00"].map(x=>({val:x,lbl:x}))} /></div>}
                                    </div>
                                )
                            })}
                            {users.length === 0 && <div className="p-4 text-center text-slate-400">利用者が登録されていません</div>}
                        </div>
                    </Card>
                </div>
            );
        };

        const StaffShiftManagement = ({ staffs, userShifts, users, staffShifts, onShiftChange }) => {
            const [cur, setCur] = useState(new Date());
            const dk = formatDateKey(cur);
            
            const activeUsersCount = users.filter(u => userShifts[dk]?.[u.id]?.checked).length;
            const activeStaffs = staffs.filter(s => {
                const shift = staffShifts[dk]?.[s.id];
                return typeof shift === 'object' ? shift.checked : !!shift;
            });
            const staffHours = activeStaffs.reduce((sum, s) => {
                const shift = staffShifts[dk]?.[s.id];
                const timeStr = typeof shift === 'object' ? shift.time : shift;
                return sum + calculateWorkHours(timeStr);
            }, 0);
            const fte = staffHours / 8;
            const ratio = fte > 0 ? (activeUsersCount / fte).toFixed(1) : 0;

            return (
                <div className="max-w-4xl mx-auto p-4 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold">職員日次シフト・配置シミュレーション</h1>
                        <div className="flex items-center gap-2 bg-white px-3 py-1 rounded border shadow-sm"><span className="text-sm text-slate-500 mr-2">対象日:</span><input type="date" value={dk} onChange={e=>setCur(new Date(e.target.value))} className="focus:outline-none font-bold text-slate-700"/></div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div className="bg-blue-50 border border-blue-100 p-4 rounded-lg text-center"><div className="text-xs font-bold text-blue-600 mb-1">出勤利用者</div><div className="text-2xl font-bold text-slate-800">{activeUsersCount} 名</div></div>
                        <div className="bg-green-50 border border-green-100 p-4 rounded-lg text-center"><div className="text-xs font-bold text-green-600 mb-1">出勤職員 (常勤換算)</div><div className="text-2xl font-bold text-slate-800">{fte.toFixed(1)} 人</div></div>
                        <div className={`border p-4 rounded-lg text-center ${ratio > 10 ? 'bg-red-50 border-red-100' : 'bg-slate-50 border-slate-200'}`}><div className={`text-xs font-bold mb-1 ${ratio > 10 ? 'text-red-600' : 'text-slate-600'}`}>利用者:職員 比率</div><div className={`text-2xl font-bold ${ratio > 10 ? 'text-red-700' : 'text-slate-800'}`}>{ratio} : 1</div></div>
                    </div>

                    <Card title="出勤予定の登録">
                        <div className="divide-y divide-slate-100">
                            {staffs.map(s => {
                                const shift = staffShifts[dk]?.[s.id];
                                const isChecked = typeof shift === 'object' ? shift.checked : !!shift;
                                const timeStr = typeof shift === 'object' ? (shift.time || "") : (shift || "");

                                return (
                                    <div key={s.id} className="flex items-center justify-between py-3 hover:bg-slate-50 px-2 rounded transition-colors">
                                        <div className="flex items-center gap-3"><input type="checkbox" checked={isChecked} onChange={e=>onShiftChange(cur,s.id, e.target.checked?"09:00-18:00":"")} className="w-5 h-5 text-blue-600 rounded border-slate-300 cursor-pointer"/><span className="font-bold text-slate-700">{s.name}</span><span className="text-xs text-slate-500">({s.role})</span></div>
                                        {isChecked && <div className="w-48"><TextInput value={timeStr} onChange={e=>onShiftChange(cur,s.id,e.target.value)} placeholder="09:00-18:00"/></div>}
                                    </div>
                                )
                            })}
                            {staffs.length === 0 && <div className="p-4 text-center text-slate-400">職員が登録されていません</div>}
                        </div>
                    </Card>
                </div>
            );
        };

        // --- メイン App ---
        const App = () => {
            const [view, setView] = useState("list");
            const [users, setUsers] = useState([]);
            const [staffs, setStaffs] = useState([]);
            const [tasks, setTasks] = useState([]); 
            const [userShifts, setUserShifts] = useState({}); 
            const [staffShifts, setStaffShifts] = useState({}); 
            const [assignments, setAssignments] = useState({});
            const [evaluations, setEvaluations] = useState({});
            const [seatLayout, setSeatLayout] = useState([]);
            
            const [activeUser, setActiveUser] = useState(null);
            const [activeForm, setActiveForm] = useState("summary");
            const [deleteTarget, setDeleteTarget] = useState(null);

            const [user, setUser] = useState(null);
            const [isCloudReady, setIsCloudReady] = useState(false);
            const refs = useRef({ users: null, staffs: null, tasks: null, userShifts: null, staffShifts: null, assignments: null, evaluations: null, seatLayout: null });
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Firebaseの初期化と待機状態の管理（確実に画面が表示されるように修正）
            useEffect(() => {
                let isMounted = true;
                const initFirebase = async () => {
                    if (typeof __firebase_config === 'undefined') {
                        if (isMounted) setIsCloudReady(true);
                        return;
                    }

                    if (!window.firestoreModule) {
                        try {
                            const dynImport = new Function('url', 'return import(url)');
                            const appM = await dynImport("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                            const authM = await dynImport("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                            const fsM = await dynImport("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                            window.firestoreModule = fsM;
                            
                            const firebaseConfig = JSON.parse(__firebase_config);
                            if (Object.keys(firebaseConfig).length > 0) {
                                const app = appM.initializeApp(firebaseConfig);
                                const auth = authM.getAuth(app);
                                window.db = fsM.getFirestore(app);
                                
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await authM.signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await authM.signInAnonymously(auth);
                                }
                                
                                authM.onAuthStateChanged(auth, u => { 
                                    if(isMounted) setUser(u);
                                });
                            }
                        } catch (e) { 
                            console.error("Firebase err", e); 
                        } finally {
                            if(isMounted) setIsCloudReady(true);
                        }
                    } else {
                         try {
                             const authM = await new Function('url', 'return import(url)')("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                             setUser(authM.getAuth().currentUser);
                         } catch (e) {
                             console.error("Firebase Auth err", e);
                         } finally {
                             if(isMounted) setIsCloudReady(true);
                         }
                    }
                };
                initFirebase();
                return () => { isMounted = false; };
            }, []);

            // データの読み込み管理（クラウドの準備完了を待つ）
            useEffect(() => {
                if (!isCloudReady) return;

                const defaultSeatLayout = Array.from({length:12}, (_,i)=>({id:String(i+1), x: (i%4)*160 + 20, y: Math.floor(i/4)*120 + 20, r: 0, label: `席 ${i+1}`}));
                const dummyUser = { ...getInitialUserState(), id: Date.now(), name: "テスト利用者", application: { applicantName: "テスト利用者" } };
                dummyUser.status = determineStatus(dummyUser);

                const loadLocal = (k, setter, proc, initVal) => {
                    let init = initVal; const saved = localStorage.getItem(`knowbe_${k}`);
                    if(saved) try { init = JSON.parse(saved); } catch(e){}
                    const val = JSON.stringify(init); refs.current[k] = val;
                    setter(proc ? proc(init) : init);
                };

                // Firebase設定はあるが、まだ認証完了（userの取得）が済んでいない場合は待機
                if (typeof __firebase_config !== 'undefined' && window.firestoreModule && !user) {
                    return; 
                }

                // ローカル（クラウド無効）環境の場合
                if (typeof __firebase_config === 'undefined' || !window.firestoreModule || !window.db) {
                    loadLocal('users', setUsers, d => Array.isArray(d) ? d.map(mergeUser) : [], [mergeUser(dummyUser)]);
                    loadLocal('staffs', setStaffs, null, [{ id: 1, name: "管理者", role: "管理者" }]);
                    loadLocal('tasks', setTasks, null, []);
                    loadLocal('userShifts', setUserShifts, null, {});
                    loadLocal('staffShifts', setStaffShifts, null, {});
                    loadLocal('assignments', setAssignments, null, {});
                    loadLocal('evaluations', setEvaluations, null, {});
                    loadLocal('seatLayout', setSeatLayout, null, defaultSeatLayout);
                    return;
                }

                // クラウド環境（Firestore連携）の場合
                const { doc, onSnapshot, setDoc } = window.firestoreModule;
                const load = (k, setter, proc, initVal) => {
                    return onSnapshot(doc(window.db, 'artifacts', appId, 'public', 'data', 'store', k), (snap) => {
                        if (snap.exists()) {
                            const val = snap.data().value;
                            if (val !== refs.current[k]) { 
                                refs.current[k] = val; 
                                try { setter(proc ? proc(JSON.parse(val)) : JSON.parse(val)); } catch(e){} 
                            }
                        } else if (refs.current[k] === null) {
                            let init = initVal; const saved = localStorage.getItem(`knowbe_${k}`);
                            if(saved) try { init = JSON.parse(saved); } catch(e){}
                            const val = JSON.stringify(init); refs.current[k] = val;
                            setDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'store', k), { value: val }).catch(console.error);
                            setter(proc ? proc(init) : init);
                        }
                    }, err => console.error(`${k} sync err`, err));
                };
                
                const unsubs = [
                    load('users', setUsers, d => Array.isArray(d) ? d.map(mergeUser) : [], [mergeUser(dummyUser)]),
                    load('staffs', setStaffs, null, [{ id: 1, name: "管理者", role: "管理者" }]),
                    load('tasks', setTasks, null, []), load('userShifts', setUserShifts, null, {}), load('staffShifts', setStaffShifts, null, {}),
                    load('assignments', setAssignments, null, {}), load('evaluations', setEvaluations, null, {}),
                    load('seatLayout', setSeatLayout, null, defaultSeatLayout)
                ];
                return () => unsubs.forEach(u => u());
            }, [isCloudReady, user, appId]);

            const pub = useCallback(async (k, d) => {
                if (!isCloudReady) return;
                const val = JSON.stringify(d);
                if (val !== refs.current[k]) {
                    refs.current[k] = val; localStorage.setItem(`knowbe_${k}`, val);
                    if (user && window.firestoreModule && window.db) {
                        try { await window.firestoreModule.setDoc(window.firestoreModule.doc(window.db, 'artifacts', appId, 'public', 'data', 'store', k), { value: val }); } catch (e) { }
                    }
                }
            }, [isCloudReady, user, appId]);

            useEffect(() => { pub('users', users); }, [users, pub]);
            useEffect(() => { pub('staffs', staffs); }, [staffs, pub]);
            useEffect(() => { pub('tasks', tasks); }, [tasks, pub]);
            useEffect(() => { pub('userShifts', userShifts); }, [userShifts, pub]);
            useEffect(() => { pub('staffShifts', staffShifts); }, [staffShifts, pub]);
            useEffect(() => { pub('assignments', assignments); }, [assignments, pub]);
            useEffect(() => { pub('evaluations', evaluations); }, [evaluations, pub]);
            useEffect(() => { pub('seatLayout', seatLayout); }, [seatLayout, pub]);

            const curUser = users.find(u => u.id === activeUser);

            if (!isCloudReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50">
                        <div className="flex flex-col items-center gap-4">
                            <div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            <p className="text-slate-600 font-bold">起動中...</p>
                        </div>
                    </div>
                );
            }

            const handleCreateUser = () => { 
                const newUserRaw = { ...getInitialUserState(), id: Date.now(), name: "新規利用者" }; 
                const newUser = { ...newUserRaw, status: determineStatus(newUserRaw) };
                setUsers([...users, newUser]); 
                setActiveUser(newUser.id); 
                setView("detail"); 
            };

            const handleDeleteClick = (user) => setDeleteTarget(user);
            const executeDelete = () => { if(deleteTarget){ setUsers(users.filter(u=>u.id!==deleteTarget.id)); setDeleteTarget(null); setView("list"); }};
            
            const exportData = () => { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(users)); a.download = "data.json"; a.click(); };
            const importData = (e) => { const r = new FileReader(); r.onload = (ev) => { if(confirm('上書きしますか？')) setUsers(JSON.parse(ev.target.result).map(u => mergeUser(u))); }; if(e.target.files[0]) r.readAsText(e.target.files[0]); };

            const MenuBtn = ({ v, icon, lbl }) => (
                <button onClick={() => setView(v)} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === v ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name={icon} /><span>{lbl}</span></button>
            );

            return (
                <ErrorBoundary>
                    <div className="flex min-h-screen">
                        <div className="w-64 bg-slate-800 text-white flex-shrink-0 flex flex-col no-print">
                            <div className="p-6 text-xl font-bold border-b border-slate-700 flex items-center gap-2"><div className="w-8 h-8 bg-blue-500 rounded flex items-center justify-center">G</div>Gift Support</div>
                            <nav className="flex-1 p-4 space-y-1">
                                <MenuBtn v="list" icon="users" lbl="利用者一覧" />
                                <MenuBtn v="user_shift" icon="calendar" lbl="利用者シフト" />
                                <MenuBtn v="seat_map" icon="layout-grid" lbl="座席配置" />
                                <MenuBtn v="task_list" icon="clipboard-list" lbl="作業一覧" />
                                <MenuBtn v="staff_shift_monthly" icon="table" lbl="職員シフト表(月)" />
                                <MenuBtn v="staff_shift" icon="calendar-check" lbl="職員配置日次" />
                                <MenuBtn v="staff_list" icon="user-cog" lbl="職員管理" />
                            </nav>
                            <div className="p-4 border-t border-slate-700 space-y-2">
                                <div className="text-xs text-slate-500 uppercase font-bold flex justify-between items-center mb-2">
                                    <span>データ管理</span>
                                    {user && window.db ? <span className="w-2 h-2 rounded-full bg-green-500" title="クラウド同期中"></span> : <span className="w-2 h-2 rounded-full bg-slate-400" title="ローカル保存モード"></span>}
                                </div>
                                <button onClick={exportData} className="flex items-center space-x-3 w-full p-2 rounded hover:bg-slate-700 text-sm"><Icon name="download" size={16}/><span>保存</span></button>
                                <label className="flex items-center space-x-3 w-full p-2 rounded hover:bg-slate-700 cursor-pointer text-sm"><Icon name="upload" size={16}/><span>読込</span><input type="file" className="hidden" onChange={importData} /></label>
                            </div>
                        </div>
                        <div className="flex-1 flex flex-col overflow-hidden">
                            <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm no-print"><div className="font-bold text-slate-600">Gift Support 管理システム</div></header>
                            <main className="flex-1 p-8 overflow-y-auto">
                                {view === "list" && (
                                    <div className="max-w-6xl mx-auto">
                                        <TopicsDashboard users={users} />
                                        <div className="flex justify-between mb-6"><h1 className="text-2xl font-bold">利用者一覧</h1><button onClick={handleCreateUser} className="bg-blue-600 text-white px-4 py-2 rounded shadow-sm hover:bg-blue-700 flex gap-2"><Icon name="plus" />新規登録</button></div>
                                        <div className="bg-white rounded shadow-sm border border-slate-200 overflow-hidden">
                                            <table className="min-w-full divide-y divide-slate-200"><thead className="bg-slate-50"><tr><th className="px-6 py-3 text-left font-medium text-slate-600">氏名</th><th className="px-6 py-3 text-left font-medium text-slate-600">状態</th><th className="px-6 py-3 text-right font-medium text-slate-600">操作</th></tr></thead>
                                            <tbody className="divide-y divide-slate-200">{users.map(u => (<tr key={u.id} className="hover:bg-slate-50"><td className="px-6 py-4 font-bold text-slate-700">{u.name}</td><td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs ${u.status === '利用中' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-800'}`}>{u.status}</span></td><td className="px-6 py-4 text-right"><button onClick={() => {setActiveUser(u.id); setView("detail");}} className="text-blue-600 hover:text-blue-800 mr-4 font-medium">編集</button><button onClick={() => handleDeleteClick(u)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Icon name="trash-2" size={16} /></button></td></tr>))}</tbody></table>
                                            {users.length === 0 && <div className="p-8 text-center text-slate-400">利用者が登録されていません</div>}
                                        </div>
                                    </div>
                                )}
                                {view === "seat_map" && <SeatManagement users={users} staffs={staffs} userShifts={userShifts} staffShifts={staffShifts} tasks={tasks} assignments={assignments} setAssignments={setAssignments} evaluations={evaluations} setEvaluations={setEvaluations} seatLayout={seatLayout} setSeatLayout={setSeatLayout} />}
                                {view === "task_list" && <TaskManagement tasks={tasks} setTasks={setTasks} />}
                                {view === "user_shift" && <UserShiftManagement users={users} userShifts={userShifts} onShiftChange={(d, uid, f, v) => { const dk=formatDateKey(d); const c=userShifts[dk]||{}; const s=c[uid]||{checked:false,time:""}; setUserShifts({...userShifts, [dk]:{...c, [uid]:{...s, [f]:v}}}); }} />}
                                {view === "staff_shift" && <StaffShiftManagement staffs={staffs} users={users} userShifts={userShifts} staffShifts={staffShifts} onShiftChange={(d, sid, v) => { const dk=formatDateKey(d); const c=staffShifts[dk]||{}; setStaffShifts({...staffShifts, [dk]:{...c, [sid]:{checked:!!v, time:v}}}); }} />}
                                {view === "staff_shift_monthly" && <StaffMonthlyShift staffs={staffs} staffShifts={staffShifts} onShiftChange={(d, sid, v) => { const dk=formatDateKey(d); const c=staffShifts[dk]||{}; setStaffShifts({...staffShifts, [dk]:{...c, [sid]:{checked:!!v, time:v}}}); }} />}
                                {view === "staff_list" && <StaffManagement staffs={staffs} setStaffs={setStaffs} />}
                                {view === "detail" && curUser && (
                                    <div className="max-w-5xl mx-auto animate-fade-in">
                                        <div className="mb-6 flex justify-between items-center"><h1 className="text-2xl font-bold text-slate-800">{curUser.name}</h1><div className="flex gap-2"><button onClick={() => window.print()} className="px-4 py-2 border border-slate-300 rounded shadow-sm bg-white hover:bg-slate-50 flex items-center gap-2"><Icon name="printer" size={16}/> 印刷</button><button onClick={() => setView("list")} className="px-4 py-2 border border-slate-300 rounded shadow-sm bg-white hover:bg-slate-50">一覧へ戻る</button></div></div>
                                        <div className="border-b border-slate-200 mb-6 overflow-x-auto"><nav className="flex space-x-6 min-w-max pb-1">
                                            {['要約情報','仮申込書','アセスメント','個別支援計画','モニタリング','終了評価','支援記録','面談記録'].map((lbl, i) => { 
                                                const ids = ['summary','application','assessment','plan','monitoring','termination','daily','interview']; 
                                                return (<button key={ids[i]} onClick={() => setActiveForm(ids[i])} className={`py-2 px-1 border-b-2 font-medium text-sm transition-colors ${activeForm===ids[i] ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-800'}`}>{lbl}</button>); 
                                            })}
                                        </nav></div>
                                        {activeForm === 'summary' && <SummaryView user={curUser} />}
                                        {activeForm === 'application' && <ApplicationForm data={curUser.application} onChange={d => setUsers(users.map(u=>u.id===curUser.id?{...u, application:d, name:d.applicantName||u.name}:u))} staffs={staffs} />}
                                        {activeForm === 'assessment' && <AssessmentForm data={curUser.assessment} onChange={d => setUsers(users.map(u=>u.id===curUser.id?{...u, assessment:d}:u))} />}
                                        {activeForm === 'plan' && <PlanForm data={curUser.plan} onChange={d => setUsers(users.map(u=>u.id===curUser.id?{...u, plan:d}:u))} />}
                                        {activeForm === 'monitoring' && <MonitoringForm data={curUser.monitoring} planData={curUser.plan} staffs={staffs} onChange={d => setUsers(users.map(u=>u.id===curUser.id?{...u, monitoring:d}:u))} />}
                                        {activeForm === 'termination' && <TerminationForm data={curUser.termination} planData={curUser.plan} onChange={d => setUsers(users.map(u=>u.id===curUser.id?{...u, termination:d}:u))} />}
                                        {activeForm === 'daily' && <DailyRecordForm data={curUser.dailyRecords} assessment={curUser.assessment} onChange={d => setUsers(users.map(u=>u.id===curUser.id?{...u, dailyRecords:d}:u))} />}
                                        {activeForm === 'interview' && <InterviewRecordForm data={curUser.interviewRecords} staffs={staffs} onChange={d => setUsers(users.map(u=>u.id===curUser.id?{...u, interviewRecords:d}:u))} />}
                                    </div>
                                )}
                            </main>
                        </div>
                    </div>
                    {deleteTarget && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full"><h3 className="text-lg font-bold mb-4">利用者の削除</h3><p className="mb-6 text-slate-600">本当に「{deleteTarget.name}」を削除しますか？この操作は元に戻せません。</p><div className="flex justify-end gap-2"><button onClick={() => setDeleteTarget(null)} className="px-4 py-2 border border-slate-300 rounded hover:bg-slate-50">キャンセル</button><button onClick={executeDelete} className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 shadow-sm">削除する</button></div></div></div>
                    )}
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
