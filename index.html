<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>就労支援管理システム - Gift Support</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9;
        }
        .font-roboto { font-family: 'Roboto', sans-serif; }

        /* 印刷設定 */
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                width: 100%;
            }
            .no-print { display: none !important; }
            .shadow-sm, .shadow-md, .shadow-lg { box-shadow: none !important; }
            input, textarea, select { border: 1px solid #ccc !important; }
            input:disabled, textarea:disabled { background-color: white !important; color: black !important; }
            /* 印刷時Selectの矢印を消す */
            select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background: none !important; padding-right: 0 !important; }
            .overflow-x-auto { overflow: visible !important; }
            .min-w-full { min-width: 100% !important; }
        }

        /* スクロールバー */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        /* カレンダー用 */
        .resizer-handle { position: absolute; top: 0; right: -4px; bottom: 0; width: 10px; cursor: col-resize; z-index: 60; display: flex; align-items: center; justify-content: center; }
        .resizer-handle:hover .resizer-bar, .resizer-handle.resizing .resizer-bar { background-color: #3b82f6; height: 100%; }
        .resizer-bar { width: 4px; height: 24px; background-color: #d1d5db; border-radius: 2px; transition: all 0.2s; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="portal-root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { createPortal } = ReactDOM;

        // --- エラー境界 ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("ErrorBoundary caught:", error, errorInfo); }
            render() {
                if (this.state.hasError) return (
                    <div className="min-h-screen flex items-center justify-center bg-red-50 p-6">
                        <div className="bg-white p-8 rounded shadow-lg border border-red-200 max-w-lg w-full text-center">
                            <h1 className="text-xl font-bold text-red-600 mb-4">システムエラーが発生しました</h1>
                            <p className="text-gray-600 mb-6 text-sm">{this.state.error && this.state.error.toString()}</p>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">データをリセットして復旧</button>
                        </div>
                    </div>
                );
                return this.props.children;
            }
        }

        // --- 共通コンポーネント ---
        const Icon = React.memo(({ name, size = 18, className = "", onClick, style }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide && window.lucide.createIcons) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    try { window.lucide.createIcons({ root: ref.current, attrs: { width: size, height: size, class: className } }); } catch (e) {}
                }
            }, [name, size, className]);
            return <span ref={ref} onClick={onClick} style={{ display: 'inline-flex', alignItems: 'center', verticalAlign: 'middle', minWidth: size, minHeight: size, cursor: onClick ? 'pointer' : 'inherit', ...style }} />;
        });

        const ModalPortal = ({ children }) => {
            const el = document.getElementById('portal-root');
            return el ? createPortal(children, el) : null;
        };

        const SimpleBarChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="h-full flex items-center justify-center text-slate-400 text-xs">データなし</div>;
            const maxVal = Math.max(...data.map(d => d.users), 1);
            return (
                <div className="w-full h-full flex items-end gap-1 pt-4 pb-1 px-1 relative">
                    {data.map((d, i) => (
                        <div key={i} className="flex-1 flex flex-col items-center group relative h-full justify-end">
                            <div className="w-full bg-blue-500 rounded-t hover:bg-blue-600 transition-all relative" style={{ height: `${(d.users / maxVal) * 100}%` }}>
                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 hidden group-hover:block bg-slate-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-10">{d.time} : {d.users}名</div>
                            </div>
                        </div>
                    ))}
                    <div className="absolute bottom-0 left-0 right-0 h-px bg-slate-200"></div>
                </div>
            );
        };

        // --- ユーティリティ ---
        const checkDeadlineAlert = (targetDateStr, completedDateStr, label) => {
            if (!targetDateStr) return { isAlert: false, message: '', type: null };
            if (completedDateStr) return { isAlert: false, message: '', type: null }; 
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const targetDate = new Date(targetDateStr);
            if (isNaN(targetDate.getTime())) return { isAlert: false, message: '', type: null };
            targetDate.setHours(0, 0, 0, 0);
            const alertStartDate = new Date(targetDate); alertStartDate.setDate(targetDate.getDate() - 30);
            if (today > targetDate) {
                const diffDays = Math.floor((today - targetDate) / (1000 * 60 * 60 * 24));
                return { isAlert: true, message: `${label}の期限を${diffDays}日過ぎています`, type: 'danger' };
            } else if (today >= alertStartDate) {
                const diffDays = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));
                return { isAlert: true, message: `${label}まであと${diffDays}日です`, type: 'warning' };
            }
            return { isAlert: false, message: '', type: null };
        };

        const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

        const determineStatus = (user) => {
            if (user.plan?.periodStart && user.plan?.periodEnd && user.plan?.approver) return "利用中";
            // scheduleが存在しない場合も考慮して安全にアクセス
            const schedule = user.application?.schedule || {};
            if (schedule.trial1 || schedule.trial2 || schedule.trial3) return "体験利用中";
            if (user.application?.receptionDate && user.application?.applicantName) return "見学対応中";
            return "未定"; 
        };

        const calculateWorkHours = (timeStr) => {
            if (!timeStr || !timeStr.includes('-')) return 0;
            try {
                const [start, end] = timeStr.split('-');
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);
                if (isNaN(startH) || isNaN(endH)) return 0;
                const startTime = startH + (startM || 0) / 60;
                const endTime = endH + (endM || 0) / 60;
                let duration = endTime - startTime;
                if (duration < 0) duration += 24;
                if (duration > 6) duration -= 1; // 6時間超で1時間休憩
                return Math.max(0, duration);
            } catch (e) { return 0; }
        };

        const stripHtmlTags = (str) => str ? str.replace(/<br\s*\/?>/gi, '\n').replace(/<\/p>/gi, '\n').replace(/<[^>]*>/g, '') : '';

        // --- 初期データ生成関数 ---
        const getInitialUserState = () => ({
            id: null, name: "新規利用者", status: "未定", 
            application: { 
                applicantName: "", applicantNameKana: "", gender: "", dob: "", age: "", address: "", phone: "", email: "", disabilityType: [], disabilityName: "", disabilityGrade: "", hasExperience: "", todayQuestion: "", visitReason: [], futureGoal: "", desiredService: [], concerns: [], goals: [], isVisitingHospital: "", hospitalName: "", consultedDoctor: "", howDidYouKnow: [], 
                schedule: { 
                    trial1: "", trial1Time: "", 
                    trial2: "", trial2Time: "", 
                    trial3: "", trial3Time: "", 
                    certificateDate: "", contractDate: "" 
                } 
            },
            assessment: { createDate: "", writer: "", referrer: "", commuteMethod: "", emergencyContact: { name: "", relation: "", tel: "" }, certificates: { mental: { status: "", note: "" }, rehabilitation: { status: "", note: "" }, physical: { status: "", note: "" }, devDisability: { has: "", note: "" } }, financial: { pension: { has: "", note: "" }, welfare: { has: "", note: "" } }, medical: { hospital: "", diagnosis: "", medication: "", doctor: "", psw: "", visitFrequency: "" }, workHistory: [{ company: "", content: "", period: "", type: "", days: "", hours: "", salary: "", reason: "" }], likesDislikes: { work: "", person: "" }, onsetAge: "", diagnosisAge: "", hospitalizationHistory: "", medicalAdvice: "", medicationManagement: "", symptomStability: "", currentMentalState: "", triggers: "", coping: "", lifeSituation: "", familySituation: "", personality: "", upbringing: "", dailyLife: { wakeTime: "", sleepTime: "", commSkill: "", literacy: "", numeracy: "", strengths: "", challenges: "", concerns: "" }, familyStructure: [{ name: "", relation: "", age: "", note: "" }], checklist: { health: { physical: { score: 0, note: "" }, medication: { score: 0, note: "" }, diet: { score: 0, note: "" } }, daily: { rhythm: { score: 0, note: "" }, appearance: { score: 0, note: "" }, cleanliness: { score: 0, note: "" }, money: { score: 0, note: "" }, mobility: { score: 0, note: "" } }, social: { expression: { score: 0, note: "" }, communication: { score: 0, note: "" }, emotion: { score: 0, note: "" }, cooperation: { score: 0, note: "" } }, work: { understanding: { score: 0, note: "" }, intention: { score: 0, note: "" }, motivation: { score: 0, note: "" }, endurance: { score: 0, note: "" }, familySupport: { score: 0, note: "" } } }, basicHabits: { greeting: { has: false, note: "" }, reporting: { has: false, note: "" }, attendance: { has: false, note: "" }, discipline: { has: false, note: "" } }, desiredSupport: { items: [], detail: "" }, overallOpinion: { desiredWork: "", readiness: "", suitability: "", futureTasks: "", remarks: "" } },
            plan: { periodStart: "", periodEnd: "", monitoringDate: "", userDesire: "", familyDesire: "", needs: "", longTermGoal: "", shortTermGoal: "", supportContent: "", staff: "", approver: "", explainDate: "" },
            monitoring: { date: "", interviewer: "", location: "", currentStatus: "", needs: "", anxiety: "", satisfaction: "", futureTasks: "", feedback: "" },
            termination: { date: "", goals: [{ id: 1, target: "", achievement: "", overall: "", satisfaction: "", nextOpinion: "" }, { id: 2, target: "", achievement: "", overall: "", satisfaction: "", nextOpinion: "" }, { id: 3, target: "", achievement: "", overall: "", satisfaction: "", nextOpinion: "" }, { id: 4, target: "", achievement: "", overall: "", satisfaction: "", nextOpinion: "" }] }
        });

        // データを安全にマージする関数 (不足項目を補完)
        const mergeUserData = (loadedUser) => {
            const initial = getInitialUserState();
            // 特にネストが深い application.schedule を重点的に補完
            const mergedApplication = {
                ...initial.application,
                ...(loadedUser.application || {}),
                schedule: {
                    ...initial.application.schedule,
                    ...((loadedUser.application && loadedUser.application.schedule) || {})
                }
            };

            const mergedUser = {
                ...initial,
                ...loadedUser,
                application: mergedApplication,
                assessment: { ...initial.assessment, ...(loadedUser.assessment || {}) },
                plan: { ...initial.plan, ...(loadedUser.plan || {}) },
                monitoring: { ...initial.monitoring, ...(loadedUser.monitoring || {}) },
                termination: { ...initial.termination, ...(loadedUser.termination || {}) },
            };
            
            // ステータス再計算
            mergedUser.status = determineStatus(mergedUser);
            return mergedUser;
        };

        // --- UI部品 ---
        const Card = ({ title, children, className = "" }) => (
            <div className={`bg-white rounded-lg shadow-sm border border-slate-200 mb-6 ${className}`}>
                {title && <div className="px-6 py-4 border-b border-slate-100"><h3 className="text-lg font-bold text-slate-800">{title}</h3></div>}
                <div className="p-6">{children}</div>
            </div>
        );
        const InputGroup = ({ label, children, required }) => (
            <div className="mb-4"><label className="block text-sm font-medium text-slate-600 mb-1">{label} {required && <span className="text-red-500">*</span>}</label>{children}</div>
        );
        const TextInput = ({ value, onChange, placeholder, type = "text", disabled, className = "" }) => (
            <input type={type} className={`w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${disabled ? "bg-slate-100 text-slate-500" : "bg-white border-slate-300"} ${className}`} value={value || ""} onChange={onChange} placeholder={placeholder} disabled={disabled} />
        );
        const TextArea = ({ value, onChange, rows = 3, placeholder, disabled, className = "" }) => (
            <textarea className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm ${disabled ? "bg-slate-100 text-slate-500" : "bg-white border-slate-300"} ${className}`} rows={rows} value={value || ""} onChange={onChange} placeholder={placeholder} disabled={disabled} />
        );
        const StaffSelect = ({ value, onChange, options = [], placeholder = "選択", disabled }) => (
            <div className="relative">
                <select className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm appearance-none bg-white ${disabled ? "bg-slate-100" : "bg-white border-slate-300"} pr-8`} value={value || ""} onChange={onChange} disabled={disabled}>
                    <option value="">{placeholder}</option>
                    {options.map(s => <option key={s.id} value={s.name}>{s.name} {s.role ? `(${s.role})` : ''}</option>)}
                    {value && !options.find(s => s.name === value) && <option value={value}>{value} (未登録)</option>}
                </select>
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon name="chevron-down" size={16} /></div>
            </div>
        );
        const Checkbox = ({ label, checked, onChange, disabled }) => (
            <label className={`flex items-center space-x-2 mr-4 mb-2 ${disabled ? 'opacity-60' : 'cursor-pointer'}`}>
                <input type="checkbox" checked={checked} onChange={onChange} disabled={disabled} className="w-4 h-4 text-blue-600 rounded border-slate-300" />
                <span className="text-sm text-slate-700">{label}</span>
            </label>
        );
        const Radio = ({ label, name, value, checked, onChange }) => (
            <label className="flex items-center space-x-2 cursor-pointer mr-4">
                <input type="radio" name={name} value={value} checked={checked} onChange={onChange} className="w-4 h-4 text-blue-600 border-slate-300" />
                <span className="text-sm text-slate-700">{label}</span>
            </label>
        );
        const SectionHeader = ({ text }) => <h4 className="text-md font-bold text-slate-700 mt-6 mb-3 border-l-4 border-blue-500 pl-3">{text}</h4>;
        const AutoFillDisplay = ({ label, value }) => (
             <div className="mb-4"><label className="block text-xs font-bold text-blue-600 mb-1 flex items-center">{label} <span className="ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-normal">自動反映</span></label><div className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-md text-sm text-slate-700 min-h-[38px] flex items-center">{value || "（未入力）"}</div></div>
        );
        const AlertBanner = ({ alert, dateLabel, date }) => {
            if (!alert || !alert.isAlert) return null;
            return (
                <div className={`mb-4 p-4 rounded-md border flex items-start gap-3 shadow-sm ${alert.type === 'danger' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-yellow-50 border-yellow-200 text-yellow-800'}`}>
                    <Icon name="bell" className={`flex-shrink-0 ${alert.type === 'danger' ? 'text-red-500' : 'text-yellow-600'}`} />
                    <div><div className="font-bold">期限の確認が必要です</div><div className="text-sm mt-1">{alert.message}（{dateLabel}: {date}）</div></div>
                </div>
            );
        };

        // --- モーダル・カレンダー系コンポーネント ---
        const DatePickerModal = ({ isOpen, onClose, currentDate, onSelectDate }) => {
            if(!isOpen) return null;
            return (
                <ModalPortal><div className="fixed inset-0 bg-black/30 z-[1000] flex items-center justify-center" onClick={onClose}>
                    <div className="bg-white p-4 rounded shadow-lg" onClick={e=>e.stopPropagation()}>
                        <input type="date" value={formatDateKey(currentDate)} onChange={e => { onSelectDate(new Date(e.target.value)); onClose(); }} />
                    </div>
                </div></ModalPortal>
            );
        };

        const CreateEventModal = ({ isOpen, onClose, defaultStart, defaultResourceId, editingEvent, onSave, onDelete }) => {
            const [form, setForm] = useState({ title: '', date: '', start: '09:00', end: '10:00' });
            useEffect(() => {
                if(isOpen) {
                    if(editingEvent) {
                        const s = new Date(editingEvent.start); const e = new Date(editingEvent.end);
                        setForm({ title: editingEvent.title, date: formatDateKey(s), start: s.toTimeString().slice(0,5), end: e.toTimeString().slice(0,5) });
                    } else {
                        const d = new Date(defaultStart);
                        setForm({ title: '', date: formatDateKey(d), start: d.toTimeString().slice(0,5), end: new Date(d.getTime()+3600000).toTimeString().slice(0,5) });
                    }
                }
            }, [isOpen, editingEvent, defaultStart]);

            if(!isOpen) return null;
            const handleSubmit = () => {
                onSave({
                    id: editingEvent ? editingEvent.id : Date.now().toString(),
                    resourceId: editingEvent ? editingEvent.resourceId : defaultResourceId,
                    title: form.title,
                    start: new Date(`${form.date}T${form.start}`).toISOString(),
                    end: new Date(`${form.date}T${form.end}`).toISOString()
                });
                onClose();
            };

            return (
                <ModalPortal><div className="fixed inset-0 bg-black/30 z-[1000] flex items-center justify-center">
                    <div className="bg-white p-6 rounded w-96 space-y-4">
                        <h3 className="font-bold text-lg">{editingEvent ? '予定編集' : '予定作成'}</h3>
                        <input className="w-full border p-2 rounded" placeholder="タイトル" value={form.title} onChange={e=>setForm({...form, title:e.target.value})} />
                        <input type="date" className="w-full border p-2 rounded" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} />
                        <div className="flex gap-2">
                            <input type="time" className="w-full border p-2 rounded" value={form.start} onChange={e=>setForm({...form, start:e.target.value})} />
                            <input type="time" className="w-full border p-2 rounded" value={form.end} onChange={e=>setForm({...form, end:e.target.value})} />
                        </div>
                        <div className="flex justify-end gap-2">
                            {editingEvent && <button onClick={()=>{onDelete(editingEvent.id); onClose();}} className="text-red-500">削除</button>}
                            <button onClick={onClose}>キャンセル</button>
                            <button onClick={handleSubmit} className="bg-blue-500 text-white px-4 py-2 rounded">保存</button>
                        </div>
                    </div>
                </div></ModalPortal>
            );
        };
        
        const SchedulerGrid = ({ viewMode, currentDate, resources, onEventClick, onCellClick, sidebarWidth }) => {
            const days = useMemo(() => {
                const d = new Date(currentDate);
                if (viewMode === 'week') { d.setDate(d.getDate() - d.getDay()); return Array.from({length: 7}, (_, i) => { const t = new Date(d); t.setDate(t.getDate() + i); return t; }); }
                return [new Date(d)];
            }, [currentDate, viewMode]);
            const startHour = 8; const hours = Array.from({ length: 13 }, (_, i) => i + startHour); 

            return (
                <div className="flex flex-col h-full overflow-hidden relative">
                    <div className="flex-1 flex flex-col overflow-auto custom-scrollbar relative">
                        <div className="flex border-b bg-gray-50 sticky top-0 z-[60] min-w-[1000px]">
                            <div className="flex-shrink-0 border-r bg-gray-100 sticky left-0 z-[60] p-2 font-bold text-gray-500" style={{ width: sidebarWidth }}>
                                {viewMode === 'day' && <span>{currentDate.getDate()} ({['日','月','火','水','木','金','土'][currentDate.getDay()]})</span>}
                            </div>
                            <div className="flex-1 flex">
                                {viewMode === 'week' ? days.map((d, i) => <div key={i} className="flex-1 p-2 text-center text-sm border-r font-medium">{d.getDate()} ({['日','月','火','水','木','金','土'][d.getDay()]})</div>)
                                : hours.map(h => <div key={h} className="flex-1 border-r py-2 text-center text-sm text-gray-500">{h}:00</div>)}
                            </div>
                        </div>
                        <div className="min-w-[1000px] relative">
                            {resources.map(res => (
                                <div key={res.id} className="flex border-b min-h-[80px] hover:bg-gray-50">
                                    <div className="flex-shrink-0 p-2 border-r bg-white sticky left-0 z-40" style={{ width: sidebarWidth }}>
                                        <div className="font-bold text-sm">{res.name}</div><div className="text-xs text-gray-500">{res.role}</div>
                                    </div>
                                    <div className="flex-1 relative w-full">
                                        {viewMode === 'week' ? (
                                            <div className="flex h-full">{days.map((day, di) => (
                                                <div key={di} className="flex-1 border-r h-full p-1 cursor-pointer hover:bg-blue-50/50" onClick={() => onCellClick(res.id, new Date(day.setHours(9,0,0,0)))}>
                                                    {res.events.filter(e => new Date(e.start).getDate() === day.getDate()).map(e => (
                                                        <div key={e.id} onClick={(ev) => {ev.stopPropagation(); onEventClick(e);}} className="bg-blue-500 text-white text-xs p-1 rounded mb-1 truncate">{e.title}</div>
                                                    ))}
                                                </div>
                                            ))}</div>
                                        ) : (
                                            <div className="flex h-full relative">
                                                {hours.map(h => <div key={h} className="flex-1 border-r h-full" />)}
                                                {res.events.map(e => {
                                                    const s = new Date(e.start); const en = new Date(e.end);
                                                    const startH = s.getHours() + s.getMinutes()/60; const endH = en.getHours() + en.getMinutes()/60;
                                                    if(endH < 8 || startH > 20) return null;
                                                    const left = ((Math.max(startH, 8) - 8) / 13) * 100; const width = ((Math.min(endH, 21) - Math.max(startH, 8)) / 13) * 100;
                                                    return <div key={e.id} onClick={(ev) => {ev.stopPropagation(); onEventClick(e);}} className="absolute top-1 bottom-1 bg-blue-500 text-white text-xs p-1 rounded truncate cursor-pointer" style={{left: `${left}%`, width: `${width}%`}}>{e.title}</div>
                                                })}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };


        // --- 要約情報ビュー ---
        const SummaryView = ({ user }) => {
            const { application, assessment, plan, monitoring, termination } = user;
            const monitoringAlert = checkDeadlineAlert(plan?.monitoringDate, monitoring?.date, "モニタリング");
            const terminationAlert = checkDeadlineAlert(plan?.periodEnd, termination?.date, "終了評価");

            const InfoItem = ({ label, value, important = false }) => (
                <div className="mb-3"><div className={`text-xs font-bold mb-1 ${important ? 'text-red-600' : 'text-slate-500'}`}>{label} {important && <span className="text-xs bg-red-100 text-red-600 px-1 rounded ml-1">重要</span>}</div><div className={`text-sm ${value ? 'text-slate-800' : 'text-slate-400 italic'}`}>{value || "（情報なし）"}</div></div>
            );

            return (
                <div className="animate-fade-in">
                    {monitoringAlert.isAlert && <AlertBanner alert={monitoringAlert} dateLabel="予定日" date={plan.monitoringDate} />}
                    {terminationAlert.isAlert && <AlertBanner alert={terminationAlert} dateLabel="計画終了日" date={plan.periodEnd} />}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div className="space-y-6">
                            <Card title="基本情報・緊急連絡先" className="border-l-4 border-l-blue-500">
                                <div className="flex justify-between items-start mb-4"><div><h2 className="text-2xl font-bold text-slate-800">{application.applicantName} <span className="text-sm font-normal text-slate-500">({application.applicantNameKana})</span></h2><div className="flex gap-2 mt-1"><span className="text-sm bg-slate-100 px-2 py-0.5 rounded text-slate-600">{application.gender}</span><span className="text-sm bg-slate-100 px-2 py-0.5 rounded text-slate-600">{application.age}歳</span>{(application.disabilityType || []).map(t => (<span key={t} className="text-sm bg-blue-100 px-2 py-0.5 rounded text-blue-700">{t}</span>))}</div></div><div className="text-right"><div className="text-sm font-bold text-slate-500">障害等級</div><div className="text-lg">{application.disabilityGrade || "-"}</div></div></div>
                                <div className="grid grid-cols-2 gap-4 bg-red-50 p-4 rounded-md border border-red-100 mb-4"><div><div className="text-xs font-bold text-red-700 mb-1">緊急連絡先</div><div className="font-bold text-slate-800">{assessment.emergencyContact.name} <span className="text-sm font-normal">({assessment.emergencyContact.relation})</span></div><div className="text-slate-700">{assessment.emergencyContact.tel}</div></div><div><div className="text-xs font-bold text-red-700 mb-1">診断名・病名</div><div className="font-bold text-slate-800">{assessment.medical.diagnosis || application.disabilityName || "（未記入）"}</div></div></div>
                                <InfoItem label="通院先・主治医" value={`${assessment.medical.hospital} / ${assessment.medical.doctor}`} /><InfoItem label="服薬状況・管理" value={assessment.medical.medication} />
                            </Card>
                            <Card title="特性・配慮事項 (Attention)" className="border-l-4 border-l-orange-400"><InfoItem label="調子を崩す前兆（サイン）" value={assessment.triggers} important /><InfoItem label="調子を崩した時の対処法" value={assessment.coping} important /><div className="my-4 border-t border-slate-100"></div><InfoItem label="得意なこと・強み" value={assessment.dailyLife.strengths || assessment.workHistory.map(w => w.content).join(", ")} /><InfoItem label="苦手なこと・課題" value={assessment.dailyLife.challenges} /><InfoItem label="コミュニケーションの特性" value={assessment.dailyLife.commSkill} /></Card>
                        </div>
                        <div className="space-y-6">
                            <Card title="支援目標・方針 (Goal)" className="border-l-4 border-l-green-500"><InfoItem label="本人の希望（将来の目標）" value={plan.userDesire || application.futureGoal} /><div className="bg-green-50 p-3 rounded mb-3"><InfoItem label="短期目標（〜6ヶ月）" value={plan.shortTermGoal} /></div><InfoItem label="長期目標（約1年）" value={plan.longTermGoal} /><InfoItem label="具体的な支援内容" value={plan.supportContent} /></Card>
                            <Card title="直近の状況・評価 (Status)" className="border-l-4 border-l-indigo-500">
                                 <div className="mb-4"><div className="text-xs font-bold text-slate-500 mb-1">直近のモニタリング ({monitoring.date || "実施なし"})</div><div className="bg-slate-50 p-3 rounded border border-slate-100"><div className="text-sm mb-2"><span className="font-bold">現状:</span> {monitoring.currentStatus || "記録なし"}</div><div className="text-sm mb-2"><span className="font-bold">満足度:</span> {monitoring.satisfaction || "-"}</div><div className="text-sm"><span className="font-bold">今後の課題:</span> {monitoring.futureTasks || "-"}</div></div></div>
                                {termination.date && (<div className="mb-4"><div className="text-xs font-bold text-slate-500 mb-1">終了評価 ({termination.date})</div><div className="bg-slate-50 p-3 rounded border border-slate-100"><div className="text-sm">{termination.goals.map(g => g.overall).filter(o => o).join(" / ") || "全体評価の記述なし"}</div></div></div>)}
                                <InfoItem label="事業所に望む支援（アセスメントより）" value={assessment.desiredSupport.detail || assessment.desiredSupport.items.join(", ")} />
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 職員シフト表(月) (超コンパクト版) ---
        const StaffMonthlyShift = ({ staffs, staffShifts, onShiftChange }) => {
            const [currentMonth, setCurrentMonth] = useState(new Date());

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = [];
                const lastDay = new Date(year, month + 1, 0).getDate();
                for (let i = 1; i <= lastDay; i++) {
                    days.push(new Date(year, month, i));
                }
                return days;
            };

            const days = getDaysInMonth(currentMonth);
            const weekDays = ["日","月","火","水","木","金","土"];

            const shiftOptions = [
                { value: "", label: "休", color: "bg-slate-50 text-slate-400" },
                { value: "09:00-18:00", label: "09:00-18:00", color: "bg-blue-100 text-blue-700" },
                { value: "09:00-13:00", label: "09:00-13:00", color: "bg-green-100 text-green-700" },
                { value: "13:00-18:00", label: "13:00-18:00", color: "bg-orange-100 text-orange-700" },
                { value: "10:00-16:00", label: "10:00-16:00", color: "bg-purple-100 text-purple-700" },
            ];

            const getShiftColor = (time) => {
                const opt = shiftOptions.find(o => o.value === time);
                return opt ? opt.color : "bg-white text-gray-700 font-normal";
            };

            const calculateDailyTotal = (date) => {
                const dateKey = formatDateKey(date);
                let total = 0;
                staffs.forEach(staff => { 
                    const shift = (staffShifts[dateKey] && staffShifts[dateKey][staff.id]); 
                    if (shift && shift.time) total += calculateWorkHours(shift.time); 
                });
                return total;
            };

            const handleChange = (date, staffId, value) => {
                if (value === "MANUAL_INPUT") {
                    const dateKey = formatDateKey(date);
                    const currentShift = (staffShifts[dateKey] && staffShifts[dateKey][staffId]);
                    const defaultVal = currentShift ? currentShift.time : "";
                    const input = prompt("シフト時間を入力してください (例: 09:30-17:30)", defaultVal);
                    
                    if (input !== null) {
                        onShiftChange(date, staffId, input);
                    } else {
                        onShiftChange(date, staffId, defaultVal);
                    }
                } else {
                    onShiftChange(date, staffId, value);
                }
            };

            return (
                <div className="w-full animate-fade-in p-2">
                    <div className="flex justify-between items-center mb-2 no-print">
                        <h1 className="text-xl font-bold text-slate-800">職員シフト表(月)</h1>
                        <div className="flex items-center gap-2">
                            <button onClick={() => window.print()} className="px-3 py-1 border rounded-md bg-white hover:bg-slate-50 text-sm flex items-center gap-1"><Icon name="printer" size={14} /> 印刷</button>
                            <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1))} className="p-1 hover:bg-slate-200 rounded"><Icon name="chevron-left" /></button>
                            <span className="text-lg font-bold">{currentMonth.getFullYear()}年 {currentMonth.getMonth() + 1}月</span>
                            <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1))} className="p-1 hover:bg-slate-200 rounded"><Icon name="chevron-right" /></button>
                        </div>
                    </div>

                    <div className="bg-white border border-slate-200 rounded-lg overflow-x-auto shadow-sm w-full print:border-none print:shadow-none">
                        <table className="divide-y divide-slate-200 border-collapse table-fixed w-full" style={{ minWidth: '1200px' }}>
                            <thead className="bg-slate-50">
                                <tr>
                                    <th className="p-1 text-left font-bold text-slate-500 sticky left-0 bg-slate-50 z-10 w-[90px] border-r border-b text-[10px] leading-tight">職員名</th>
                                    {days.map(d => (
                                        <th key={d.getDate()} className={`p-0 text-center font-bold w-[36px] border-r border-b text-[10px] leading-tight ${d.getDay()===0?'text-red-500 bg-red-50':d.getDay()===6?'text-blue-500 bg-blue-50':'text-slate-500'}`}>
                                            {d.getDate()}<br/>{weekDays[d.getDay()]}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-slate-200">
                                {staffs.map(staff => (
                                    <tr key={staff.id} className="h-6">
                                        <td className="p-1 font-medium text-slate-900 sticky left-0 bg-white z-10 border-r border-b text-[9px] truncate max-w-[90px]" title={`${staff.name} (${staff.role})`}>
                                            {staff.name}
                                        </td>
                                        {days.map(date => {
                                            const dateKey = formatDateKey(date);
                                            const shift = (staffShifts[dateKey] && staffShifts[dateKey][staff.id]) || { time: "", checked: false };
                                            const currentTime = shift.time;
                                            
                                            const isCustom = currentTime && !shiftOptions.some(o => o.value === currentTime);

                                            return (
                                                <td key={date.toISOString()} className={`p-0 border-r border-b relative group`}>
                                                    <select
                                                        className={`w-full h-full text-center appearance-none focus:outline-none cursor-pointer font-bold text-[9px] px-0 py-0 ${getShiftColor(currentTime)}`}
                                                        style={{ textOverflow: 'clip', letterSpacing: '-0.5px' }}
                                                        value={currentTime}
                                                        onChange={(e) => handleChange(date, staff.id, e.target.value)}
                                                        title={currentTime || '休'}
                                                    >
                                                        {shiftOptions.map(opt => (
                                                            <option key={opt.label} value={opt.value}>{opt.label}</option>
                                                        ))}
                                                        {isCustom && <option value={currentTime}>{currentTime}</option>}
                                                        <option value="MANUAL_INPUT" className="text-gray-500">手動...</option>
                                                    </select>
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                                {staffs.length === 0 && (
                                    <tr><td colSpan={days.length + 1} className="px-6 py-4 text-center text-slate-400 text-xs">職員が登録されていません</td></tr>
                                )}
                            </tbody>
                            <tfoot className="bg-slate-100 font-bold text-slate-600">
                                <tr className="h-6">
                                    <td className="p-1 sticky left-0 bg-slate-100 z-10 border-r border-t text-[9px]">稼働(h)</td>
                                    {days.map(date => { const total = calculateDailyTotal(date); return (<td key={date.toISOString()} className="text-center p-0 border-r border-t text-[10px]">{total > 0 ? total : '-'}</td>); })}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        };

        // --- シフト配置シミュレーション ---
        const StaffShiftManagement = ({ staffs, userShifts, users, staffShifts, onShiftChange }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);

            const handleDateClick = (date) => { setSelectedDate(date); setIsModalOpen(true); };
            const dateKey = selectedDate ? formatDateKey(selectedDate) : null;
            
            // 集計ロジック
            const dayUserShifts = userShifts[dateKey] || {};
            const activeUsers = Object.values(dayUserShifts).filter(s => s.checked).length;
            
            const safeStaffShifts = staffShifts || {};
            const dayStaffShifts = safeStaffShifts[dateKey] || {};
            const activeStaffs = Object.values(dayStaffShifts).filter(s => s.checked);
            let staffHours = 0;
            activeStaffs.forEach(s => staffHours += calculateWorkHours(s.time));
            const fte = staffHours / 8;
            const ratio = fte > 0 ? (activeUsers / fte).toFixed(1) : 0;

            const getCalendarDays = () => {
                const year = currentDate.getFullYear(); const month = currentDate.getMonth();
                const days = [];
                const firstDay = new Date(year, month, 1).getDay();
                const lastDay = new Date(year, month+1, 0).getDate();
                for(let i=0; i<firstDay; i++) days.push(null);
                for(let i=1; i<=lastDay; i++) days.push(new Date(year, month, i));
                return days;
            };

            const handleShiftChange = (sid, field, val) => {
                const time = field === 'time' ? val : (val ? "09:00-18:00" : "");
                onShiftChange(selectedDate, sid, time);
            };

            return (
                <div className="max-w-6xl mx-auto p-4 animate-fade-in">
                    <div className="flex justify-between mb-6"><h1 className="text-2xl font-bold">配置シミュレーション</h1><div><button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1))} className="p-2"><Icon name="chevron-left"/></button><span className="mx-2 font-bold">{currentDate.getFullYear()}年{currentDate.getMonth()+1}月</span><button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1))} className="p-2"><Icon name="chevron-right"/></button></div></div>
                    <div className="bg-white rounded border grid grid-cols-7 text-center">
                        {['日','月','火','水','木','金','土'].map(d=><div key={d} className="p-2 font-bold bg-slate-50 border-b">{d}</div>)}
                        {getCalendarDays().map((d,i) => (
                            <div key={i} className={`h-24 border-b border-r p-1 ${d?'cursor-pointer hover:bg-slate-50':''}`} onClick={()=>d&&handleDateClick(d)}>
                                {d && <span className="text-sm font-bold">{d.getDate()}</span>}
                            </div>
                        ))}
                    </div>
                    {isModalOpen && selectedDate && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                                <div className="p-4 border-b flex justify-between"><h3 className="font-bold text-lg">{selectedDate.toLocaleDateString()} 詳細</h3><button onClick={()=>setIsModalOpen(false)}><Icon name="x"/></button></div>
                                <div className="p-6 overflow-y-auto flex-1 grid grid-cols-2 gap-6">
                                    <div className="space-y-4">
                                        <div className="bg-slate-50 p-4 rounded border">
                                            <h4 className="font-bold mb-2">配置状況</h4>
                                            <div className="flex justify-between"><span>利用者数</span><span className="font-bold text-xl">{activeUsers}名</span></div>
                                            <div className="flex justify-between"><span>職員数(常勤換算)</span><span className="font-bold text-xl">{fte.toFixed(1)}</span></div>
                                            <div className="flex justify-between border-t pt-2 mt-2"><span>比率 (利用者:職員)</span><span className={`font-bold ${activeUsers/fte > 10 ? 'text-red-600':'text-green-600'}`}>{ratio} : 1</span></div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 className="font-bold mb-2">職員シフト</h4>
                                        <div className="space-y-2">
                                            {staffs.map(s => {
                                                const shift = (safeStaffShifts[dateKey] && safeStaffShifts[dateKey][s.id]) || { checked: false, time: "" };
                                                return (
                                                    <div key={s.id} className="flex items-center justify-between p-2 border rounded">
                                                        <div className="flex items-center gap-2"><input type="checkbox" checked={shift.checked} onChange={e=>handleShiftChange(s.id, 'checked', e.target.checked)} /><span>{s.name}</span></div>
                                                        {shift.checked && <input className="border rounded px-1 w-28 text-center" value={shift.time} onChange={e=>handleShiftChange(s.id, 'time', e.target.value)} />}
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 職員管理 ---
        const StaffManagement = ({ staffs, setStaffs }) => {
            const [form, setForm] = useState({ name: '', role: '' });
            const add = () => { if(form.name) { setStaffs([...staffs, { id: Date.now(), ...form }]); setForm({name:'', role:''}); } };
            return (
                <div className="max-w-4xl mx-auto p-4 animate-fade-in">
                    <h1 className="text-2xl font-bold mb-6">職員管理</h1>
                    <Card title="新規登録">
                        <div className="flex gap-4 items-end">
                            <div className="flex-1"><label className="block text-sm mb-1">氏名</label><TextInput value={form.name} onChange={e=>setForm({...form, name:e.target.value})} /></div>
                            <div className="flex-1"><label className="block text-sm mb-1">役職</label><StaffSelect value={form.role} onChange={e=>setForm({...form, role:e.target.value})} options={["管理者","サビ管","支援員"].map(r=>({id:r,name:r}))} /></div>
                            <button onClick={add} className="bg-blue-600 text-white px-4 py-2 rounded">追加</button>
                        </div>
                    </Card>
                    <div className="bg-white rounded border overflow-hidden">
                        <table className="w-full text-left"><thead className="bg-slate-50"><tr><th className="p-3">氏名</th><th className="p-3">役職</th><th className="p-3 text-right">操作</th></tr></thead><tbody>
                            {staffs.map(s => (<tr key={s.id} className="border-t"><td className="p-3">{s.name}</td><td className="p-3">{s.role}</td><td className="p-3 text-right"><button onClick={()=>setStaffs(staffs.filter(x=>x.id!==s.id))} className="text-red-500"><Icon name="trash-2" size={16}/></button></td></tr>))}
                        </tbody></table>
                    </div>
                </div>
            );
        };

        // --- 作業管理 ---
        const TaskManagement = ({ tasks, setTasks }) => {
            const [form, setForm] = useState({ name: '', description: '', level: '1', deadline: '1週間' });
            const deadlines = ["1週間", "2週間", "3週間", "4週間", "1ヶ月", "2ヶ月"];
            const add = () => { if(form.name) { setTasks([...tasks, { id: Date.now(), ...form }]); setForm({ name: '', description: '', level: '1', deadline: '1週間' }); } };

            return (
                <div className="max-w-4xl mx-auto p-4 animate-fade-in">
                    <h1 className="text-2xl font-bold mb-6">作業一覧</h1>
                    <Card title="新規作業登録">
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm mb-1">作業名</label><TextInput value={form.name} onChange={e=>setForm({...form, name:e.target.value})} placeholder="例: 箱折り" /></div>
                                <div>
                                    <label className="block text-sm mb-1">レベル (5段階)</label>
                                    <div className="relative">
                                        <select className="w-full px-3 py-2 border rounded-md appearance-none bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" value={form.level} onChange={e=>setForm({...form, level:e.target.value})}>
                                            <option value="">選択</option>
                                            {[1, 2, 3, 4, 5].map(l => (<option key={l} value={l}>{l}</option>))}
                                        </select>
                                        <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-500"><Icon name="chevron-down" size={16}/></div>
                                    </div>
                                </div>
                            </div>
                            <div><label className="block text-sm mb-1">内容</label><TextArea value={form.description} onChange={e=>setForm({...form, description:e.target.value})} /></div>
                            <div>
                                <label className="block text-sm mb-1">納期</label>
                                <div className="relative">
                                    <select className="w-full px-3 py-2 border rounded-md appearance-none bg-white" value={form.deadline} onChange={e=>setForm({...form, deadline:e.target.value})}>
                                        {deadlines.map(d => <option key={d} value={d}>{d}</option>)}
                                    </select>
                                    <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-500"><Icon name="chevron-down" size={16}/></div>
                                </div>
                            </div>
                            <div className="flex justify-end"><button onClick={add} className="bg-blue-600 text-white px-6 py-2 rounded">登録</button></div>
                        </div>
                    </Card>
                    <div className="bg-white rounded border overflow-hidden mt-6">
                        <table className="w-full text-left text-sm"><thead className="bg-slate-50"><tr><th className="p-3">作業名</th><th className="p-3">レベル</th><th className="p-3">納期</th><th className="p-3">内容</th><th className="p-3 text-right">操作</th></tr></thead><tbody>
                            {tasks.map(t => (<tr key={t.id} className="border-t"><td className="p-3 font-bold">{t.name}</td><td className="p-3"><span className="bg-slate-100 px-2 py-1 rounded text-xs">{t.level}</span></td><td className="p-3">{t.deadline}</td><td className="p-3 text-slate-500 truncate max-w-xs">{t.description}</td><td className="p-3 text-right"><button onClick={()=>setTasks(tasks.filter(x=>x.id!==t.id))} className="text-red-500"><Icon name="trash-2" size={16}/></button></td></tr>))}
                            {tasks.length === 0 && <tr><td colSpan="5" className="p-6 text-center text-slate-400">登録された作業はありません</td></tr>}
                        </tbody></table>
                    </div>
                </div>
            );
        };

        // --- 座席配置管理コンポーネント ---
        const SeatManagement = ({ users, staffs, userShifts, staffShifts, tasks }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [assignments, setAssignments] = useState({}); // { "YYYY-MM-DD": { seatId: { userId: "...", taskId: "..." } } }
            const [evaluations, setEvaluations] = useState({}); // { "YYYY-MM-DD": 3.5 }
            const [isDatePickerOpen, setIsDatePickerOpen] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem("knowbe_seat_assignments");
                if (saved) { 
                    try { 
                        const parsed = JSON.parse(saved);
                        // マイグレーション
                        Object.keys(parsed).forEach(dKey => {
                            Object.keys(parsed[dKey]).forEach(sKey => {
                                const val = parsed[dKey][sKey];
                                if (typeof val !== 'object' || val === null) {
                                    parsed[dKey][sKey] = { userId: String(val), taskId: "" };
                                }
                            });
                        });
                        setAssignments(parsed); 
                    } catch(e) {} 
                }
                const savedEvals = localStorage.getItem("knowbe_seat_evaluations");
                if (savedEvals) { try { setEvaluations(JSON.parse(savedEvals)); } catch(e) {} }
            }, []);

            useEffect(() => {
                localStorage.setItem("knowbe_seat_assignments", JSON.stringify(assignments));
            }, [assignments]);
            useEffect(() => {
                localStorage.setItem("knowbe_seat_evaluations", JSON.stringify(evaluations));
            }, [evaluations]);

            const dateKey = formatDateKey(currentDate);
            const activeUsers = useMemo(() => {
                const dayShifts = userShifts[dateKey] || {};
                return users.filter(u => dayShifts[u.id] && dayShifts[u.id].checked);
            }, [users, userShifts, dateKey]);

            const activeStaffs = useMemo(() => {
                const dayShifts = staffShifts[dateKey] || {};
                return staffs.filter(s => dayShifts[s.id] && dayShifts[s.id].checked);
            }, [staffs, staffShifts, dateKey]);

            const dayAssignments = assignments[dateKey] || {};
            const seats = Array.from({ length: 20 }, (_, i) => i + 1);

            const handleAssignUser = (seatId, userId) => {
                const newDay = { ...dayAssignments };
                Object.keys(newDay).forEach(k => {
                    if (newDay[k]?.userId === userId) delete newDay[k];
                });

                if (!userId) {
                    delete newDay[seatId];
                } else {
                    newDay[seatId] = { userId, taskId: "" }; // 新規配置時はタスクなし
                }
                setAssignments({ ...assignments, [dateKey]: newDay });
            };

            const handleAssignTask = (seatId, taskId) => {
                const newDay = { ...dayAssignments };
                if (newDay[seatId]) {
                    newDay[seatId] = { ...newDay[seatId], taskId };
                    setAssignments({ ...assignments, [dateKey]: newDay });
                }
            };

            // AIシミュレーション実行
            const runAiSimulation = () => {
                // 1. 過去の高評価(3.5以上)の日付を取得
                const goodDates = Object.keys(evaluations).filter(date => evaluations[date] >= 3.5);
                
                if (goodDates.length === 0) {
                    alert("学習データが不足しています。\n評価3.5以上のデータが蓄積されるまでお待ちください。");
                    return;
                }

                // 2. 利用者ごとの「得意な席（過去に座った席）」スコアを算出
                const userSeatScores = {}; // { userId: { seatId: score } }
                
                goodDates.forEach(date => {
                    const dailyAssign = assignments[date];
                    if (!dailyAssign) return;
                    
                    Object.entries(dailyAssign).forEach(([seatId, data]) => {
                        const userId = data.userId;
                        if (!userSeatScores[userId]) userSeatScores[userId] = {};
                        // 評価値をスコアとして加算（高評価の日ほど重みが増す）
                        userSeatScores[userId][seatId] = (userSeatScores[userId][seatId] || 0) + evaluations[date];
                    });
                });

                // 3. 当日出勤メンバーへの割り当て
                const proposal = {};
                const usedSeats = new Set();
                
                // スコアが高い順にソートした希望リストを作成
                const userPreferences = activeUsers.map(u => {
                    const scores = userSeatScores[u.id] || {};
                    // スコア降順に座席IDを並べる
                    const preferredSeats = Object.keys(scores).sort((a, b) => scores[b] - scores[a]);
                    return { userId: String(u.id), preferredSeats };
                });
                
                // 割り当て実行
                userPreferences.forEach(({ userId, preferredSeats }) => {
                    let assigned = false;
                    // 希望順に空き席を探す
                    for (const seatId of preferredSeats) {
                        if (!usedSeats.has(seatId)) {
                            proposal[seatId] = { userId, taskId: "" };
                            usedSeats.add(seatId);
                            assigned = true;
                            break;
                        }
                    }
                    // 希望席がない場合は空いている席へ（若い番号順）
                    if (!assigned) {
                         for (let i = 1; i <= 20; i++) {
                             const seatId = String(i);
                             if (!usedSeats.has(seatId)) {
                                 proposal[seatId] = { userId, taskId: "" };
                                 usedSeats.add(seatId);
                                 assigned = true;
                                 break;
                             }
                         }
                    }
                });
                
                setAssignments({ ...assignments, [dateKey]: proposal });
                alert(`AIによる配置提案を適用しました。\n(参照データ: ${goodDates.length}日分)`);
            };

            const assignedUserIds = Object.values(dayAssignments).map(a => String(a.userId));
            const currentEval = evaluations[dateKey] || "";

            return (
                <div className="max-w-6xl mx-auto p-4 animate-fade-in">
                    <div className="flex justify-between items-center mb-6 no-print">
                        <div className="flex items-center gap-4">
                            <h1 className="text-2xl font-bold text-slate-800">座席配置 & 作業割当</h1>
                            <button onClick={runAiSimulation} className="bg-purple-600 text-white px-4 py-2 rounded-full text-sm hover:bg-purple-700 shadow-sm flex items-center gap-2 transition-transform active:scale-95">
                                <Icon name="wand-2" size={16} /> AI配置提案
                            </button>
                        </div>
                        
                        <div className="flex items-center gap-6">
                            {/* 評価入力エリア */}
                            <div className="flex items-center gap-2 bg-yellow-50 px-3 py-1 rounded-full border border-yellow-200">
                                <span className="text-sm font-bold text-yellow-800">本日の配置評価:</span>
                                <select 
                                    className="bg-transparent font-bold text-yellow-900 focus:outline-none cursor-pointer"
                                    value={currentEval}
                                    onChange={(e) => setEvaluations({ ...evaluations, [dateKey]: Number(e.target.value) })}
                                >
                                    <option value="">-</option>
                                    <option value="5">5.0 (完璧)</option>
                                    <option value="4.5">4.5</option>
                                    <option value="4">4.0 (良)</option>
                                    <option value="3.5">3.5</option>
                                    <option value="3">3.0 (普通)</option>
                                    <option value="2">2.0</option>
                                    <option value="1">1.0 (要改善)</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-2">
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() - 1))} className="p-2 hover:bg-slate-200 rounded"><Icon name="chevron-left" /></button>
                                <span className="text-xl font-bold cursor-pointer" onClick={() => setIsDatePickerOpen(true)}>{currentDate.toLocaleDateString('ja-JP')}</span>
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + 1))} className="p-2 hover:bg-slate-200 rounded"><Icon name="chevron-right" /></button>
                            </div>
                        </div>
                    </div>

                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="w-full lg:w-1/4 space-y-4 no-print">
                            <div className="bg-white p-4 rounded shadow border border-slate-200">
                                <h3 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                    <Icon name="users" size={16}/> 出勤利用者 ({activeUsers.length}名)
                                </h3>
                                <div className="space-y-1 max-h-80 overflow-y-auto pr-1">
                                    {activeUsers.map(u => {
                                        const isAssigned = assignedUserIds.includes(String(u.id));
                                        return (
                                            <div key={u.id} className={`text-sm p-2 rounded flex justify-between items-center ${isAssigned ? 'bg-green-50 text-green-700' : 'bg-slate-50 text-slate-700'}`}>
                                                <span>{u.name}</span>
                                                {isAssigned && <Icon name="check" size={14} />}
                                            </div>
                                        );
                                    })}
                                    {activeUsers.length === 0 && <div className="text-xs text-slate-400">予定なし</div>}
                                </div>
                            </div>
                            
                            <div className="bg-white p-4 rounded shadow border border-slate-200">
                                <h3 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                    <Icon name="briefcase" size={16}/> 出勤職員 ({activeStaffs.length}名)
                                </h3>
                                <div className="space-y-1 max-h-60 overflow-y-auto pr-1">
                                    {activeStaffs.map(s => (
                                        <div key={s.id} className="text-sm p-2 rounded bg-blue-50 text-blue-700">
                                            {s.name} <span className="text-xs opacity-70">({s.role})</span>
                                        </div>
                                    ))}
                                    {activeStaffs.length === 0 && <div className="text-xs text-slate-400">予定なし</div>}
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 bg-white p-6 rounded shadow border border-slate-200">
                            <div className="flex justify-between mb-4">
                                <h3 className="font-bold text-lg text-slate-800">作業室レイアウト</h3>
                                <button onClick={() => window.print()} className="px-3 py-1 border rounded hover:bg-slate-50 text-sm flex items-center gap-1 no-print"><Icon name="printer" size={14}/> 印刷</button>
                            </div>
                            
                            {/* 20席のグリッド (4列 x 5行) */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {seats.map(seatId => {
                                    const data = dayAssignments[seatId];
                                    const user = data ? activeUsers.find(u => String(u.id) === String(data.userId)) : null;
                                    
                                    return (
                                        <div key={seatId} className={`border-2 rounded-lg p-2 flex flex-col justify-center min-h-[110px] relative ${user ? 'border-blue-200 bg-blue-50/30' : 'border-dashed border-slate-200 bg-slate-50'}`}>
                                            <span className="absolute top-1 left-2 text-[10px] font-bold text-slate-400">Seat {seatId}</span>
                                            
                                            <select 
                                                className={`w-full text-center text-sm p-1 bg-transparent font-bold mb-1 focus:outline-none ${user ? 'text-slate-800' : 'text-slate-400'}`}
                                                value={data?.userId || ""}
                                                onChange={(e) => handleAssignUser(seatId, e.target.value)}
                                            >
                                                <option value="">(空席)</option>
                                                {activeUsers.map(u => (
                                                    <option key={u.id} value={u.id}>
                                                        {u.name}
                                                    </option>
                                                ))}
                                            </select>

                                            {user && (
                                                <div className="mt-1 border-t border-blue-100 pt-1">
                                                    <select 
                                                        className="w-full text-xs p-1 bg-white border border-blue-200 rounded text-slate-600 focus:outline-none"
                                                        value={data?.taskId || ""}
                                                        onChange={(e) => handleAssignTask(seatId, e.target.value)}
                                                    >
                                                        <option value="">-- 作業選択 --</option>
                                                        {tasks.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                                    </select>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                            <div className="mt-4 text-center text-sm text-slate-400 border-t pt-2">入口</div>
                        </div>
                    </div>

                    <DatePickerModal isOpen={isDatePickerOpen} onClose={() => setIsDatePickerOpen(false)} currentDate={currentDate} onSelectDate={setCurrentDate} />
                </div>
            );
        };

        // --- 利用者シフト管理 ---
        const UserShiftManagement = ({ users, userShifts, onShiftChange }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);

            // シフト時間の選択肢
            const timeOptions = [
                "10:00-11:00", "10:00-12:00", "10:00-14:00", "10:00-15:00",
                "11:00-12:00", "13:00-14:00", "13:00-15:00", "14:00-15:00"
            ];

            const getDays = () => {
                const year = currentDate.getFullYear(); const month = currentDate.getMonth();
                const days = []; const first = new Date(year, month, 1).getDay(); const last = new Date(year, month+1, 0).getDate();
                for(let i=0; i<first; i++) days.push(null);
                for(let i=1; i<=last; i++) days.push(new Date(year, month, i));
                return days;
            };

            const handleDateClick = (d) => { setSelectedDate(d); setIsModalOpen(true); };
            
            const handleShift = (uid, field, val) => {
                onShiftChange(selectedDate, uid, field, val);
            };

            const getShiftCount = (date) => { 
                if (!date) return 0; 
                const s = userShifts[formatDateKey(date)]; 
                return s ? Object.values(s).filter(v => v.checked).length : 0; 
            };
            
            const weekDays = ["日", "月", "火", "水", "木", "金", "土"];

            return (
                <div className="max-w-6xl mx-auto p-4 animate-fade-in">
                    <div className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold text-slate-800">利用者シフト管理</h1><div className="flex items-center gap-4"><button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1))} className="p-2"><Icon name="chevron-left"/></button><span className="mx-2 font-bold">{currentDate.getFullYear()}年{currentDate.getMonth()+1}月</span><button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1))} className="p-2"><Icon name="chevron-right"/></button></div></div>
                    <div className="bg-white rounded border grid grid-cols-7 text-center">
                        {['日','月','火','水','木','金','土'].map(d=><div key={d} className="p-2 font-bold bg-slate-50 border-b">{d}</div>)}
                        {getDays().map((d,i) => (
                            <div key={i} className={`h-24 border-b border-r p-1 ${d?'hover:bg-slate-50 cursor-pointer':''}`} onClick={()=>d&&handleDateClick(d)}>
                                {d && (
                                    <>
                                        <span className="text-sm font-bold">{d.getDate()}</span>
                                        {getShiftCount(d) > 0 && <div className="mt-1"><span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">{getShiftCount(d)}名</span></div>}
                                        {/* 簡易的にシフト時間を表示 (先頭2件のみ) */}
                                        <div className="mt-1 space-y-0.5 overflow-hidden h-12">
                                            {userShifts[formatDateKey(d)] && Object.entries(userShifts[formatDateKey(d)]).filter(([_,v])=>v.checked).slice(0, 2).map(([uid, v]) => {
                                                const user = users.find(u => u.id.toString() === uid);
                                                return user ? <div key={uid} className="text-[10px] bg-white border rounded px-1 truncate text-left">{user.name} {v.time.split('-')[0]}</div> : null;
                                            })}
                                        </div>
                                    </>
                                )}
                            </div>
                        ))}
                    </div>
                    {isModalOpen && selectedDate && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
                                <div className="p-4 border-b flex justify-between"><h3 className="font-bold">{selectedDate.toLocaleDateString()} シフト</h3><button onClick={()=>setIsModalOpen(false)}><Icon name="x"/></button></div>
                                <div className="p-4 overflow-y-auto flex-1 space-y-2">
                                    {users.map(u => {
                                        const k = formatDateKey(selectedDate);
                                        const cur = userShifts[k] || {};
                                        const s = cur[u.id] || { checked: false, time: "10:00-15:00" };
                                        return (
                                            <div key={u.id} className="flex items-center justify-between p-2 border rounded hover:bg-slate-50">
                                                <div className="flex items-center gap-2">
                                                    <input type="checkbox" checked={s.checked} onChange={e=>handleShift(u.id, 'checked', e.target.checked)} className="w-5 h-5 text-blue-600 rounded" />
                                                    <span className="font-medium">{u.name}</span>
                                                </div>
                                                {s.checked && (
                                                    <div className="relative">
                                                        <select 
                                                            className="border rounded px-3 py-1 text-sm appearance-none bg-white pr-8" 
                                                            value={s.time} 
                                                            onChange={e=>handleShift(u.id, 'time', e.target.value)}
                                                        >
                                                            {timeOptions.map(t => <option key={t} value={t}>{t.replace('-', '～')}</option>)}
                                                        </select>
                                                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon name="chevron-down" size={14}/></div>
                                                    </div>
                                                )}
                                            </div>
                                        )
                                    })}
                                </div>
                                <div className="p-4 border-t flex justify-end">
                                    <button onClick={()=>setIsModalOpen(false)} className="bg-blue-600 text-white px-4 py-2 rounded">完了</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- メインアプリケーション ---
        const App = () => {
            const [view, setView] = useState("list");
            const [users, setUsers] = useState([]);
            const [staffs, setStaffs] = useState([]);
            const [tasks, setTasks] = useState([]); // 作業一覧
            const [userShifts, setUserShifts] = useState({}); 
            const [staffShifts, setStaffShifts] = useState({}); 
            const [activeUser, setActiveUser] = useState(null);
            const [activeForm, setActiveForm] = useState("summary");
            const [deleteTarget, setDeleteTarget] = useState(null);

            useEffect(() => {
                const savedUsers = localStorage.getItem("knowbe_users");
                if (savedUsers) {
                    try {
                        const parsed = JSON.parse(savedUsers);
                        const migrated = Array.isArray(parsed) ? parsed.map(u => mergeUserData(u)) : [];
                        setUsers(migrated);
                    } catch(e) { console.error("Data load error", e); }
                } else {
                    const initialApp = { ...getInitialUserState().application, applicantName: "飯嶋 卓也", applicantNameKana: "イイジマ タクヤ", interviewer: "小野 美和子", dob: "1986-12-23" };
                    let dummy = { ...getInitialUserState(), id: Date.now(), name: "飯嶋 卓也", application: initialApp };
                    dummy.status = determineStatus(dummy);
                    setUsers([dummy]);
                }
                const savedStaffs = localStorage.getItem("knowbe_staffs");
                if (savedStaffs) { try { setStaffs(JSON.parse(savedStaffs)); } catch(e) {} } else {
                    setStaffs([{ id: 1, name: "小野 美和子", role: "管理者", type: "full" }, { id: 2, name: "山田 太郎", role: "サービス管理責任者", type: "full" }]);
                }
                const savedTasks = localStorage.getItem("knowbe_tasks");
                if (savedTasks) { try { setTasks(JSON.parse(savedTasks)); } catch(e) {} } else {
                    setTasks([{id: 1, name: "箱折り", level: "1", deadline: "1週間", description: "紙箱を組み立てる作業"}, {id: 2, name: "封入", level: "3", deadline: "2週間", description: "チラシを封筒に入れる"}]);
                }
                const savedUserShifts = localStorage.getItem("knowbe_shifts");
                if (savedUserShifts) { try { setUserShifts(JSON.parse(savedUserShifts)); } catch(e) {} }
                const savedStaffShifts = localStorage.getItem("knowbe_staff_shifts");
                if (savedStaffShifts) { try { setStaffShifts(JSON.parse(savedStaffShifts)); } catch(e) {} }
            }, []);

            useEffect(() => { localStorage.setItem("knowbe_users", JSON.stringify(users)); }, [users]);
            useEffect(() => { localStorage.setItem("knowbe_staffs", JSON.stringify(staffs)); }, [staffs]);
            useEffect(() => { localStorage.setItem("knowbe_tasks", JSON.stringify(tasks)); }, [tasks]);
            useEffect(() => { localStorage.setItem("knowbe_shifts", JSON.stringify(userShifts)); }, [userShifts]);
            useEffect(() => { localStorage.setItem("knowbe_staff_shifts", JSON.stringify(staffShifts)); }, [staffShifts]);

            const handleCreateUser = () => { 
                const newUserRaw = { ...getInitialUserState(), id: Date.now(), name: "新規利用者" }; 
                const newUser = { ...newUserRaw, status: determineStatus(newUserRaw) };
                setUsers([...users, newUser]); 
                setActiveUser(newUser.id); 
                setView("detail"); 
            };
            const handleUpdateUser = (updatedData) => {
                const name = updatedData.application.applicantName || updatedData.name || "名称未設定";
                const status = determineStatus(updatedData);
                const finalData = { ...updatedData, name, status };
                
                const newShifts = { ...userShifts };
                const schedule = finalData.application.schedule;
                const updateShift = (dateStr, timeStr) => {
                    if (dateStr && timeStr) {
                        const date = new Date(dateStr);
                        const dateKey = formatDateKey(date);
                        if (!newShifts[dateKey]) newShifts[dateKey] = {};
                        newShifts[dateKey][finalData.id] = { time: timeStr.replace('～', '-'), checked: true };
                    }
                };
                updateShift(schedule.trial1, schedule.trial1Time);
                updateShift(schedule.trial2, schedule.trial2Time);
                updateShift(schedule.trial3, schedule.trial3Time);
                setUserShifts(newShifts);
                localStorage.setItem("knowbe_shifts", JSON.stringify(newShifts));

                setUsers(users.map(u => u.id === finalData.id ? finalData : u));
                setActiveUser(finalData.id); 
            };
            
            const handleStaffShiftUpdate = (date, sid, val) => {
                const k = formatDateKey(date);
                const cur = staffShifts[k] || {};
                const newShift = { 
                    time: val, 
                    checked: !!val 
                };
                const newShifts = { ...staffShifts, [k]: { ...cur, [sid]: newShift } };
                setStaffShifts(newShifts);
            };

            const handleUserShiftUpdate = (date, userId, field, value) => {
                if (!date) return;
                const dateKey = formatDateKey(date);
                const currentDayShifts = userShifts[dateKey] || {};
                const currentShift = currentDayShifts[userId] || { checked: false, time: "10:00-15:00" };
                
                let newShift = { ...currentShift };

                if (field === 'checked') {
                    newShift.checked = value;
                    if (value && !newShift.time) newShift.time = "10:00-15:00";
                } else if (field === 'time') {
                    newShift.time = value.replace('～', '-'); 
                    if (value) newShift.checked = true;
                }

                const newUserShifts = {
                    ...userShifts,
                    [dateKey]: {
                        ...currentDayShifts,
                        [userId]: newShift
                    }
                };
                setUserShifts(newUserShifts);
                localStorage.setItem("knowbe_shifts", JSON.stringify(newUserShifts));
            };

            const handleDeleteClick = (user) => setDeleteTarget(user);
            const executeDelete = () => { if(deleteTarget){ setUsers(users.filter(u=>u.id!==deleteTarget.id)); setDeleteTarget(null); setView("list"); }};
            const currentUser = useMemo(() => users.find(u => u.id === activeUser), [users, activeUser]);
            
            const exportData = () => { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(users)); a.download = "data.json"; a.click(); };
            const importData = (e) => { const r = new FileReader(); r.onload = (ev) => { if(confirm('上書きしますか？')) setUsers(JSON.parse(ev.target.result).map(u => mergeUserData(u))); }; if(e.target.files[0]) r.readAsText(e.target.files[0]); };

            return (
                <ErrorBoundary>
                <div className="flex min-h-screen">
                    <div className="w-64 bg-slate-800 text-white flex-shrink-0 flex flex-col no-print">
                        <div className="p-6 text-xl font-bold border-b border-slate-700 flex items-center gap-2"><div className="w-8 h-8 bg-blue-500 rounded flex items-center justify-center">G</div>Gift Support</div>
                        <nav className="flex-1 p-4 space-y-1">
                            <button onClick={() => setView("list")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "list" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="users" /><span>利用者一覧</span></button>
                            <button onClick={() => setView("user_shift")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "user_shift" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="calendar" /><span>利用者シフト</span></button>
                            <button onClick={() => setView("seat_map")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "seat_map" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="layout-grid" /><span>座席配置</span></button>
                            <button onClick={() => setView("task_list")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "task_list" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="clipboard-list" /><span>作業一覧</span></button>
                            <button onClick={() => setView("staff_shift")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "staff_shift" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="calendar-check" /><span>職員配置シミュ</span></button>
                            <button onClick={() => setView("staff_shift_monthly")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "staff_shift_monthly" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="table" /><span>職員シフト表(月)</span></button>
                            <button onClick={() => setView("staff_list")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "staff_list" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="user-cog" /><span>職員情報</span></button>
                            <button onClick={() => setView("schedule")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "schedule" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="calendar-days" /><span>スケジュール</span></button>
                            <div className="pt-4 pb-2 px-3 text-xs text-slate-500 uppercase font-bold">データ管理</div>
                            <button onClick={exportData} className="flex items-center space-x-3 w-full p-3 rounded hover:bg-slate-700"><Icon name="download" /><span>保存</span></button>
                            <label className="flex items-center space-x-3 w-full p-3 rounded hover:bg-slate-700 cursor-pointer"><Icon name="upload" /><span>読込</span><input type="file" className="hidden" onChange={importData} /></label>
                        </nav>
                    </div>
                    <div className="flex-1 flex flex-col">
                        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm no-print">
                            <div className="text-sm font-medium text-slate-600">ホーム {view === 'staff_shift' && '> 職員配置シミュレーション'} {view === 'staff_shift_monthly' && '> 職員シフト表(月)'} {view === 'seat_map' && '> 座席配置'} {view === 'task_list' && '> 作業一覧'}</div>
                            <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">A</div>
                        </header>
                        <main className="flex-1 p-8 overflow-y-auto">
                            {view === "list" && (
                                <div className="max-w-6xl mx-auto">
                                    <div className="flex justify-between mb-6"><h1 className="text-2xl font-bold">利用者一覧</h1><button onClick={handleCreateUser} className="bg-blue-600 text-white px-4 py-2 rounded flex gap-2"><Icon name="plus" />新規登録</button></div>
                                    <div className="bg-white rounded shadow overflow-hidden">
                                        <table className="min-w-full divide-y divide-slate-200"><thead className="bg-slate-50"><tr><th className="px-6 py-3 text-left">氏名</th><th className="px-6 py-3 text-left">状態</th><th className="px-6 py-3 text-right">操作</th></tr></thead>
                                        <tbody className="divide-y divide-slate-200">{users.map(u => (<tr key={u.id}><td className="px-6 py-4">{u.name}</td><td className="px-6 py-4">{u.status}</td><td className="px-6 py-4 text-right"><button onClick={() => {setActiveUser(u.id); setView("detail");}} className="text-blue-600 mr-4">編集</button><button onClick={() => handleDeleteClick(u)} className="text-red-500"><Icon name="trash-2" size={16} /></button></td></tr>))}</tbody></table>
                                    </div>
                                </div>
                            )}
                            {view === "schedule" && <StaffScheduleManager staffs={staffs} />}
                            {view === "seat_map" && <SeatManagement users={users} staffs={staffs} userShifts={userShifts} staffShifts={staffShifts} tasks={tasks} />}
                            {view === "task_list" && <TaskManagement tasks={tasks} setTasks={setTasks} />}
                            {view === "user_shift" && <UserShiftManagement users={users} userShifts={userShifts} onShiftChange={handleUserShiftUpdate} />}
                            {view === "staff_shift" && <StaffShiftManagement staffs={staffs} users={users} userShifts={userShifts} staffShifts={staffShifts} onShiftChange={handleStaffShiftUpdate} />}
                            {view === "staff_shift_monthly" && <StaffMonthlyShift staffs={staffs} staffShifts={staffShifts} onShiftChange={handleStaffShiftUpdate} />}
                            {view === "staff_list" && <StaffManagement staffs={staffs} setStaffs={setStaffs} />}
                            {view === "detail" && currentUser && (
                                <div className="max-w-5xl mx-auto">
                                    <div className="mb-6 flex justify-between">
                                        <h1 className="text-2xl font-bold">{currentUser.name}</h1>
                                        <button onClick={() => window.print()} className="px-4 py-2 border rounded bg-white"><Icon name="printer" /> 印刷</button>
                                    </div>
                                    <div className="border-b mb-6"><nav className="flex space-x-8">{['要約情報','仮申込書','アセスメント','個別支援計画','モニタリング','終了評価'].map((label, idx) => { const ids = ['summary','application','assessment','plan','monitoring','termination']; return (<button key={ids[idx]} onClick={() => setActiveForm(ids[idx])} className={`py-4 border-b-2 ${activeForm===ids[idx] ? 'border-blue-500 text-blue-600' : 'border-transparent'}`}>{label}</button>); })}</nav></div>
                                    {activeForm === 'summary' && <SummaryView user={currentUser} />}
                                    {activeForm === 'application' && <ApplicationForm data={currentUser.application} onChange={d => handleUpdateUser({...currentUser, application: d})} staffList={staffs} />}
                                    {activeForm === 'assessment' && <AssessmentForm data={currentUser.assessment} onChange={d => handleUpdateUser({...currentUser, assessment: d})} applicationData={currentUser.application} staffList={staffs} />}
                                    {activeForm === 'plan' && <PlanForm data={currentUser.plan} onChange={d => handleUpdateUser({...currentUser, plan: d})} applicationData={currentUser.application} staffList={staffs} />}
                                    {activeForm === 'monitoring' && <MonitoringForm data={currentUser.monitoring} onChange={d => handleUpdateUser({...currentUser, monitoring: d})} applicationData={currentUser.application} planData={currentUser.plan} staffList={staffs} />}
                                    {activeForm === 'termination' && <TerminationForm data={currentUser.termination} onChange={d => handleUpdateUser({...currentUser, termination: d})} applicationData={currentUser.application} planData={currentUser.plan} />}
                                </div>
                            )}
                        </main>
                    </div>
                    {deleteTarget && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded shadow-xl"><p>削除しますか？</p><div className="flex justify-end gap-2 mt-4"><button onClick={() => setDeleteTarget(null)} className="px-4 py-2 border rounded">キャンセル</button><button onClick={executeDelete} className="px-4 py-2 bg-red-600 text-white rounded">削除</button></div></div></div>
                    )}
                </div>
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
