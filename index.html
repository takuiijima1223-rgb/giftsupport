<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>就労支援管理システム - Gift Support</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }

        /* 印刷時のスタイル調整 */
        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
            body { background-color: white; }
            .shadow-sm, .shadow-md, .shadow-lg { box-shadow: none !important; }
            input, textarea, select { border: 1px solid #ccc !important; }
            input:disabled, textarea:disabled { background-color: white !important; color: black !important; }
            select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background: none; }
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .animate-fade-in-modal {
            animation: fadeIn 0.2s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- エラー境界コンポーネント ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) {
                this.setState({ error, errorInfo });
                console.error("App Error:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-50 p-6">
                            <div className="bg-white p-8 rounded-lg shadow-lg max-w-2xl w-full border border-red-100">
                                <h1 className="text-2xl font-bold text-red-600 mb-4">システムエラーが発生しました</h1>
                                <p className="text-slate-600 mb-4">
                                    予期せぬエラーが発生しました。再読み込みを行ってください。<br/>
                                    エラー詳細: {this.state.error && this.state.error.toString()}
                                </p>
                                <button onClick={() => window.location.reload()} className="bg-blue-600 text-white px-6 py-2 rounded">再読み込み</button>
                                <button onClick={() => { if(confirm('データをリセットしますか？保存されていないデータは消去されます。')) { localStorage.clear(); window.location.reload(); } }} className="text-red-500 underline ml-4">データリセット</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- アイコンラッパー ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide && window.lucide.createIcons) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    try { window.lucide.createIcons({ root: ref.current, attrs: { width: size, height: size, class: className } }); } catch (e) {}
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center', verticalAlign: 'middle', minWidth: size, minHeight: size }} />;
        };

        // --- シンプル棒グラフコンポーネント (Recharts代替) ---
        const SimpleBarChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="h-full flex items-center justify-center text-slate-400 text-sm">データなし</div>;
            const maxVal = Math.max(...data.map(d => d.users), 1);
            return (
                <div className="w-full h-full flex items-end gap-1 pt-6 pb-2 px-2 relative">
                    {data.map((d, i) => (
                        <div key={i} className="flex-1 flex flex-col items-center group relative h-full justify-end">
                            <div className="w-full bg-blue-500 rounded-t hover:bg-blue-600 transition-all relative" style={{ height: `${(d.users / maxVal) * 100}%` }}>
                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 hidden group-hover:block bg-slate-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-10 pointer-events-none">{d.time} : {d.users}名</div>
                            </div>
                        </div>
                    ))}
                    <div className="absolute bottom-2 left-0 right-0 h-px bg-slate-200"></div>
                </div>
            );
        };

        // --- ユーティリティ ---
        const checkDeadlineAlert = (targetDateStr, completedDateStr, label) => {
            if (!targetDateStr) return { isAlert: false, message: '', type: null };
            if (completedDateStr) return { isAlert: false, message: '', type: null }; 
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const targetDate = new Date(targetDateStr);
            if (isNaN(targetDate.getTime())) return { isAlert: false, message: '', type: null };
            targetDate.setHours(0, 0, 0, 0);
            const alertStartDate = new Date(targetDate); alertStartDate.setDate(targetDate.getDate() - 30);
            if (today > targetDate) {
                const diffDays = Math.floor((today - targetDate) / (1000 * 60 * 60 * 24));
                return { isAlert: true, message: `${label}の期限を${diffDays}日過ぎています`, type: 'danger' };
            } else if (today >= alertStartDate) {
                const diffDays = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));
                return { isAlert: true, message: `${label}まであと${diffDays}日です`, type: 'warning' };
            }
            return { isAlert: false, message: '', type: null };
        };

        const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

        const determineStatus = (user) => {
            if (user.plan?.periodStart && user.plan?.periodEnd && user.plan?.approver) return "利用中";
            const schedule = user.application?.schedule || {};
            if (schedule.trial1 || schedule.trial2 || schedule.trial3) return "体験利用中";
            if (user.application?.receptionDate && user.application?.applicantName) return "見学対応中";
            return "未定"; 
        };

        const getInitialUserState = () => ({
            id: null, name: "新規利用者", status: "未定", 
            application: { 
                applicantName: "", applicantNameKana: "", gender: "", dob: "", age: "", address: "", phone: "", email: "", disabilityType: [], disabilityName: "", disabilityGrade: "", hasExperience: "", todayQuestion: "", visitReason: [], futureGoal: "", desiredService: [], concerns: [], goals: [], isVisitingHospital: "", hospitalName: "", consultedDoctor: "", howDidYouKnow: [], 
                schedule: { 
                    trial1: "", trial1Time: "", 
                    trial2: "", trial2Time: "", 
                    trial3: "", trial3Time: "", 
                    certificateDate: "", contractDate: "" 
                } 
            },
            assessment: { createDate: "", writer: "", referrer: "", commuteMethod: "", emergencyContact: { name: "", relation: "", tel: "" }, certificates: { mental: { status: "", note: "" }, rehabilitation: { status: "", note: "" }, physical: { status: "", note: "" }, devDisability: { has: "", note: "" } }, financial: { pension: { has: "", note: "" }, welfare: { has: "", note: "" } }, medical: { hospital: "", diagnosis: "", medication: "", doctor: "", psw: "", visitFrequency: "" }, workHistory: [{ company: "", content: "", period: "", type: "", days: "", hours: "", salary: "", reason: "" }], likesDislikes: { work: "", person: "" }, onsetAge: "", diagnosisAge: "", hospitalizationHistory: "", medicalAdvice: "", medicationManagement: "", symptomStability: "", currentMentalState: "", triggers: "", coping: "", lifeSituation: "", familySituation: "", personality: "", upbringing: "", dailyLife: { wakeTime: "", sleepTime: "", commSkill: "", literacy: "", numeracy: "", strengths: "", challenges: "", concerns: "" }, familyStructure: [{ name: "", relation: "", age: "", note: "" }], checklist: { health: { physical: { score: 0, note: "" }, medication: { score: 0, note: "" }, diet: { score: 0, note: "" } }, daily: { rhythm: { score: 0, note: "" }, appearance: { score: 0, note: "" }, cleanliness: { score: 0, note: "" }, money: { score: 0, note: "" }, mobility: { score: 0, note: "" } }, social: { expression: { score: 0, note: "" }, communication: { score: 0, note: "" }, emotion: { score: 0, note: "" }, cooperation: { score: 0, note: "" } }, work: { understanding: { score: 0, note: "" }, intention: { score: 0, note: "" }, motivation: { score: 0, note: "" }, endurance: { score: 0, note: "" }, familySupport: { score: 0, note: "" } } }, basicHabits: { greeting: { has: false, note: "" }, reporting: { has: false, note: "" }, attendance: { has: false, note: "" }, discipline: { has: false, note: "" } }, desiredSupport: { items: [], detail: "" }, overallOpinion: { desiredWork: "", readiness: "", suitability: "", futureTasks: "", remarks: "" } },
            plan: { periodStart: "", periodEnd: "", monitoringDate: "", userDesire: "", familyDesire: "", needs: "", longTermGoal: "", shortTermGoal: "", supportContent: "", staff: "", approver: "", explainDate: "" },
            monitoring: { date: "", interviewer: "", location: "", currentStatus: "", needs: "", anxiety: "", satisfaction: "", futureTasks: "", feedback: "" },
            termination: { date: "", goals: [{ id: 1, target: "", achievement: "", overall: "", satisfaction: "", nextOpinion: "" }, { id: 2, target: "", achievement: "", overall: "", satisfaction: "", nextOpinion: "" }, { id: 3, target: "", achievement: "", overall: "", satisfaction: "", nextOpinion: "" }, { id: 4, target: "", achievement: "", overall: "", satisfaction: "", nextOpinion: "" }] }
        });

        // --- 共通UIコンポーネント ---
        const Card = ({ title, children, className = "" }) => (
            <div className={`bg-white rounded-lg shadow-sm border border-slate-200 mb-6 ${className}`}>
                {title && <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center"><h3 className="text-lg font-bold text-slate-800">{title}</h3></div>}
                <div className="p-6">{children}</div>
            </div>
        );
        const InputGroup = ({ label, children, required }) => (
            <div className="mb-4"><label className="block text-sm font-medium text-slate-600 mb-1">{label} {required && <span className="text-red-500">*</span>}</label>{children}</div>
        );
        const TextInput = ({ value, onChange, placeholder, type = "text", disabled, className = "" }) => (
            <input type={type} className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm ${disabled ? "bg-slate-100 text-slate-500 cursor-not-allowed" : "bg-white border-slate-300"} ${className}`} value={value || ""} onChange={onChange} placeholder={placeholder} disabled={disabled} />
        );
        const TextArea = ({ value, onChange, rows = 3, placeholder, disabled, className = "" }) => (
            <textarea className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm ${disabled ? "bg-slate-100 text-slate-500 cursor-not-allowed" : "bg-white border-slate-300"} ${className}`} rows={rows} value={value || ""} onChange={onChange} placeholder={placeholder} disabled={disabled} />
        );
        const StaffSelect = ({ value, onChange, options = [], placeholder = "選択", disabled }) => (
            <div className="relative">
                <select className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm appearance-none bg-white ${disabled ? "bg-slate-100 cursor-not-allowed" : "border-slate-300"}`} value={value || ""} onChange={onChange} disabled={disabled}>
                    <option value="">{placeholder}</option>
                    {options.map(s => <option key={s.id} value={s.name}>{s.name} {s.role ? `(${s.role})` : ''}</option>)}
                    {value && !options.find(s => s.name === value) && <option value={value}>{value} (未登録)</option>}
                </select>
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon name="chevron-down" size={16} /></div>
            </div>
        );
        const Checkbox = ({ label, checked, onChange, disabled }) => (
            <label className={`flex items-center space-x-2 mr-4 mb-2 ${disabled ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}`}>
                <input type="checkbox" checked={checked} onChange={onChange} disabled={disabled} className="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500" />
                <span className="text-sm text-slate-700">{label}</span>
            </label>
        );
        const Radio = ({ label, name, value, checked, onChange }) => (
            <label className="flex items-center space-x-2 cursor-pointer mr-4">
                <input type="radio" name={name} value={value} checked={checked} onChange={onChange} className="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500" />
                <span className="text-sm text-slate-700">{label}</span>
            </label>
        );
        const SectionHeader = ({ text }) => <h4 className="text-md font-bold text-slate-700 mt-6 mb-3 border-l-4 border-blue-500 pl-3">{text}</h4>;
        const AutoFillDisplay = ({ label, value }) => (
             <div className="mb-4"><label className="block text-xs font-bold text-blue-600 mb-1 flex items-center">{label} <span className="ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-normal">自動反映</span></label><div className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-md text-sm text-slate-700 min-h-[38px] flex items-center">{value || "（未入力）"}</div></div>
        );
        const AlertBanner = ({ alert, dateLabel, date }) => {
            if (!alert || !alert.isAlert) return null;
            return (
                <div className={`mb-4 p-4 rounded-md border flex items-start gap-3 shadow-sm ${alert.type === 'danger' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-yellow-50 border-yellow-200 text-yellow-800'}`}>
                    <Icon name="bell" className={`flex-shrink-0 ${alert.type === 'danger' ? 'text-red-500' : 'text-yellow-600'}`} />
                    <div><div className="font-bold">期限の確認が必要です</div><div className="text-sm mt-1">{alert.message}（{dateLabel}: {date}）</div></div>
                </div>
            );
        };

        // --- 要約情報ビュー ---
        const SummaryView = ({ user }) => {
            const { application, assessment, plan, monitoring, termination } = user;
            const monitoringAlert = checkDeadlineAlert(plan?.monitoringDate, monitoring?.date, "モニタリング");
            const terminationAlert = checkDeadlineAlert(plan?.periodEnd, termination?.date, "終了評価");

            const InfoItem = ({ label, value, important = false }) => (
                <div className="mb-3">
                    <div className={`text-xs font-bold mb-1 ${important ? 'text-red-600' : 'text-slate-500'}`}>
                        {label} {important && <span className="text-xs bg-red-100 text-red-600 px-1 rounded ml-1">重要</span>}
                    </div>
                    <div className={`text-sm ${value ? 'text-slate-800' : 'text-slate-400 italic'}`}>
                        {value || "（情報なし）"}
                    </div>
                </div>
            );

            return (
                <div className="animate-fade-in">
                    {monitoringAlert.isAlert && <AlertBanner alert={monitoringAlert} dateLabel="予定日" date={plan.monitoringDate} />}
                    {terminationAlert.isAlert && <AlertBanner alert={terminationAlert} dateLabel="計画終了日" date={plan.periodEnd} />}

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div className="space-y-6">
                            <Card title="基本情報・緊急連絡先" className="border-l-4 border-l-blue-500">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h2 className="text-2xl font-bold text-slate-800">{application.applicantName} <span className="text-sm font-normal text-slate-500">({application.applicantNameKana})</span></h2>
                                        <div className="flex gap-2 mt-1">
                                            <span className="text-sm bg-slate-100 px-2 py-0.5 rounded text-slate-600">{application.gender}</span>
                                            <span className="text-sm bg-slate-100 px-2 py-0.5 rounded text-slate-600">{application.age}歳</span>
                                            {(application.disabilityType || []).map(t => (
                                                <span key={t} className="text-sm bg-blue-100 px-2 py-0.5 rounded text-blue-700">{t}</span>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-sm font-bold text-slate-500">障害等級</div>
                                        <div className="text-lg">{application.disabilityGrade || "-"}</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 bg-red-50 p-4 rounded-md border border-red-100 mb-4">
                                    <div>
                                        <div className="text-xs font-bold text-red-700 mb-1">緊急連絡先</div>
                                        <div className="font-bold text-slate-800">{assessment.emergencyContact.name} <span className="text-sm font-normal">({assessment.emergencyContact.relation})</span></div>
                                        <div className="text-slate-700">{assessment.emergencyContact.tel}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs font-bold text-red-700 mb-1">診断名・病名</div>
                                        <div className="font-bold text-slate-800">{assessment.medical.diagnosis || application.disabilityName || "（未記入）"}</div>
                                    </div>
                                </div>
                                <InfoItem label="通院先・主治医" value={`${assessment.medical.hospital} / ${assessment.medical.doctor}`} />
                                <InfoItem label="服薬状況・管理" value={assessment.medical.medication} />
                            </Card>
                            <Card title="特性・配慮事項 (Attention)" className="border-l-4 border-l-orange-400">
                                <InfoItem label="調子を崩す前兆（サイン）" value={assessment.triggers} important />
                                <InfoItem label="調子を崩した時の対処法" value={assessment.coping} important />
                                <div className="my-4 border-t border-slate-100"></div>
                                <InfoItem label="得意なこと・強み" value={assessment.dailyLife.strengths || assessment.workHistory.map(w => w.content).join(", ")} />
                                <InfoItem label="苦手なこと・課題" value={assessment.dailyLife.challenges} />
                                <InfoItem label="コミュニケーションの特性" value={assessment.dailyLife.commSkill} />
                            </Card>
                        </div>
                        <div className="space-y-6">
                            <Card title="支援目標・方針 (Goal)" className="border-l-4 border-l-green-500">
                                <InfoItem label="本人の希望（将来の目標）" value={plan.userDesire || application.futureGoal} />
                                <div className="bg-green-50 p-3 rounded mb-3">
                                    <InfoItem label="短期目標（〜6ヶ月）" value={plan.shortTermGoal} />
                                </div>
                                <InfoItem label="長期目標（約1年）" value={plan.longTermGoal} />
                                <InfoItem label="具体的な支援内容" value={plan.supportContent} />
                            </Card>
                            <Card title="直近の状況・評価 (Status)" className="border-l-4 border-l-indigo-500">
                                 <div className="mb-4">
                                    <div className="text-xs font-bold text-slate-500 mb-1">直近のモニタリング ({monitoring.date || "実施なし"})</div>
                                    <div className="bg-slate-50 p-3 rounded border border-slate-100">
                                        <div className="text-sm mb-2"><span className="font-bold">現状:</span> {monitoring.currentStatus || "記録なし"}</div>
                                        <div className="text-sm mb-2"><span className="font-bold">満足度:</span> {monitoring.satisfaction || "-"}</div>
                                        <div className="text-sm"><span className="font-bold">今後の課題:</span> {monitoring.futureTasks || "-"}</div>
                                    </div>
                                </div>
                                {termination.date && (
                                    <div className="mb-4">
                                        <div className="text-xs font-bold text-slate-500 mb-1">終了評価 ({termination.date})</div>
                                        <div className="bg-slate-50 p-3 rounded border border-slate-100">
                                            <div className="text-sm">
                                                {termination.goals.map(g => g.overall).filter(o => o).join(" / ") || "全体評価の記述なし"}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <InfoItem label="事業所に望む支援（アセスメントより）" value={assessment.desiredSupport.detail || assessment.desiredSupport.items.join(", ")} />
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 職員シフト表(月) コンポーネント ---
        const StaffMonthlyShift = ({ staffs, staffShifts, onShiftChange }) => {
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const getDaysInMonth = (date) => {
                const year = date.getFullYear(); const month = date.getMonth(); const days = []; const lastDay = new Date(year, month + 1, 0).getDate();
                for (let i = 1; i <= lastDay; i++) { days.push(new Date(year, month, i)); } return days;
            };
            const days = getDaysInMonth(currentMonth);
            const shiftOptions = [ { value: "", label: "休", color: "bg-slate-50 text-slate-400" }, { value: "09:00-18:00", label: "フル", color: "bg-blue-100 text-blue-700" }, { value: "09:00-13:00", label: "AM", color: "bg-green-100 text-green-700" }, { value: "13:00-18:00", label: "PM", color: "bg-orange-100 text-orange-700" }, { value: "10:00-16:00", label: "短", color: "bg-purple-100 text-purple-700" } ];
            const getShiftColor = (time) => { const opt = shiftOptions.find(o => o.value === time); return opt ? opt.color : "bg-gray-100 text-gray-700"; };

            return (
                <div className="max-w-full mx-auto animate-fade-in p-4 overflow-x-auto">
                    <div className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold text-slate-800">職員シフト表(月)</h1><div className="flex items-center gap-4"><button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1))} className="p-2 hover:bg-slate-200 rounded"><Icon name="chevron-left" /></button><span className="text-xl font-bold">{currentMonth.getFullYear()}年 {currentMonth.getMonth() + 1}月</span><button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1))} className="p-2 hover:bg-slate-200 rounded"><Icon name="chevron-right" /></button></div></div>
                    <div className="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm inline-block min-w-full"><table className="min-w-full divide-y divide-slate-200"><thead className="bg-slate-50"><tr><th className="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase sticky left-0 bg-slate-50 z-10 w-40 border-r">職員名</th>{days.map(d => (<th key={d.getDate()} className={`px-2 py-3 text-center text-xs font-bold min-w-[40px] border-r ${d.getDay() === 0 ? 'text-red-500' : d.getDay() === 6 ? 'text-blue-500' : 'text-slate-500'}`}>{d.getDate()}<br/>{["日","月","火","水","木","金","土"][d.getDay()]}</th>))}</tr></thead><tbody className="bg-white divide-y divide-slate-200">{staffs.map(staff => (<tr key={staff.id}><td className="px-4 py-3 text-sm font-medium text-slate-900 sticky left-0 bg-white z-10 border-r">{staff.name}<div className="text-[10px] text-slate-400 font-normal">{staff.role}</div></td>{days.map(date => { const dateKey = formatDateKey(date); const shift = (staffShifts[dateKey] && staffShifts[dateKey][staff.id]) || { time: "", checked: false }; return (<td key={date.toISOString()} className="p-0 border-r h-12 relative group"><select className={`w-full h-full text-center text-xs appearance-none focus:outline-none cursor-pointer font-bold ${getShiftColor(shift.time)}`} value={shift.checked ? shift.time : ""} onChange={(e) => onShiftChange(date, staff.id, e.target.value)}>{shiftOptions.map(opt => (<option key={opt.label} value={opt.value}>{opt.label}</option>))}</select></td>); })}</tr>))}{staffs.length === 0 && (<tr><td colSpan={days.length + 1} className="px-6 py-8 text-center text-slate-400">職員が登録されていません</td></tr>)}</tbody></table></div>
                </div>
            );
        };

        // --- シフト管理 (職員用・加算判定付き) ---
        const StaffShiftManagement = ({ staffs, userShifts, users }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [staffShifts, setStaffShifts] = useState({}); 
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem("knowbe_staff_shifts");
                if (saved) { try { setStaffShifts(JSON.parse(saved)); } catch(e) {} }
            }, []);

            useEffect(() => { localStorage.setItem("knowbe_staff_shifts", JSON.stringify(staffShifts)); }, [staffShifts]);

            const getCalendarDays = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const days = [];
                for (let i = 0; i < firstDay.getDay(); i++) days.push(null);
                for (let i = 1; i <= lastDay.getDate(); i++) days.push(new Date(year, month, i));
                return days;
            };

            const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const handleDateClick = (date) => { setSelectedDate(date); setIsModalOpen(true); };

            const handleShiftChange = (staffId, field, value) => {
                if (!selectedDate) return;
                const dateKey = formatDateKey(selectedDate);
                const current = staffShifts[dateKey] || {};
                const shift = current[staffId] || { time: "09:00-18:00", checked: false };
                const updated = { ...shift, [field]: value };
                setStaffShifts({ ...staffShifts, [dateKey]: { ...current, [staffId]: updated } });
            };

            const calculateUserPeak = (dateKey) => {
                const dayUserShifts = userShifts[dateKey] || {};
                const activeUsers = Object.values(dayUserShifts).filter(s => s.checked);
                const timeSlots = {};
                activeUsers.forEach(u => {
                    const [start, end] = (u.time || "10:00-15:00").split("-");
                    let current = parseInt(start.split(":")[0]) * 60 + parseInt(start.split(":")[1]);
                    const endMin = parseInt(end.split(":")[0]) * 60 + parseInt(end.split(":")[1]);
                    while (current < endMin) {
                        timeSlots[current] = (timeSlots[current] || 0) + 1;
                        current += 30;
                    }
                });
                let maxUsers = 0;
                let peakTime = "";
                Object.entries(timeSlots).forEach(([time, count]) => {
                    if (count > maxUsers) {
                        maxUsers = count;
                        const h = Math.floor(time / 60);
                        const m = time % 60;
                        peakTime = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    }
                });
                return { maxUsers, peakTime, timeSlots };
            };

            const calculateStaffFTE = (dateKey) => {
                const dayShifts = staffShifts[dateKey] || {};
                const activeStaffs = Object.entries(dayShifts).filter(([_, s]) => s.checked);
                let totalHours = 0;
                let qualifiedCount = 0;
                activeStaffs.forEach(([id, s]) => {
                    const staff = staffs.find(st => st.id === parseInt(id));
                    const [start, end] = (s.time || "09:00-18:00").split("-");
                    const startH = parseInt(start.split(":")[0]) + parseInt(start.split(":")[1])/60;
                    const endH = parseInt(end.split(":")[0]) + parseInt(end.split(":")[1])/60;
                    let duration = endH - startH;
                    if (duration > 6) duration -= 1;
                    totalHours += duration;
                    if (staff && staff.qualifications && staff.qualifications.length > 0) {
                         qualifiedCount++;
                    }
                });
                return { fte: totalHours / 8, count: activeStaffs.length, qualifiedCount };
            };

            const getDaySummary = (date) => {
                if (!date) return null;
                const dateKey = formatDateKey(date);
                const { maxUsers } = calculateUserPeak(dateKey);
                const { count } = calculateStaffFTE(dateKey);
                return { maxUsers, staffCount: count };
            };

            const weekDays = ["日", "月", "火", "水", "木", "金", "土"];
            
            const dateKey = selectedDate ? formatDateKey(selectedDate) : null;
            const { maxUsers, peakTime, timeSlots } = selectedDate ? calculateUserPeak(dateKey) : { maxUsers: 0, peakTime: "", timeSlots: {} };
            const { fte, count, qualifiedCount } = selectedDate ? calculateStaffFTE(dateKey) : { fte: 0, count: 0, qualifiedCount: 0 };
            
            const chartData = selectedDate ? Object.keys(timeSlots).sort((a,b)=>a-b).map(t => ({
                time: `${Math.floor(t/60)}:${String(t%60).padStart(2,'0')}`,
                users: timeSlots[t]
            })) : [];

            const ratio = maxUsers > 0 ? (maxUsers / fte).toFixed(1) : 0;
            const isSafe75 = maxUsers === 0 || (maxUsers / fte) <= 7.5;
            const isSafe10 = maxUsers === 0 || (maxUsers / fte) <= 10;

            return (
                <div className="max-w-6xl mx-auto animate-fade-in p-4">
                     <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-slate-800">職員シフト管理・配置シミュレーション</h1>
                        <div className="flex items-center gap-4">
                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))} className="p-2 hover:bg-slate-200 rounded"><Icon name="chevron-left" /></button>
                            <span className="text-xl font-bold">{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</span>
                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))} className="p-2 hover:bg-slate-200 rounded"><Icon name="chevron-right" /></button>
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-lg shadow border border-slate-200 mb-8">
                        <div className="grid grid-cols-7 border-b border-slate-200 bg-slate-50">{weekDays.map((day, i) => (<div key={i} className={`p-3 text-center font-bold ${i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : 'text-slate-600'}`}>{day}</div>))}</div>
                        <div className="grid grid-cols-7">
                            {getCalendarDays().map((date, i) => {
                                const summary = getDaySummary(date);
                                return (
                                <div key={i} className={`min-h-[100px] border-b border-r border-slate-100 p-2 relative ${date ? 'hover:bg-slate-50 cursor-pointer' : 'bg-slate-50'}`} onClick={() => date && handleDateClick(date)}>
                                    {date && (<>
                                        <span className={`text-sm font-medium ${date.getDay() === 0 ? 'text-red-500' : date.getDay() === 6 ? 'text-blue-500' : 'text-slate-700'}`}>{date.getDate()}</span>
                                        {summary.staffCount > 0 && (
                                            <div className="mt-2 space-y-1">
                                                <div className="text-xs bg-green-100 text-green-800 px-1.5 py-0.5 rounded inline-block">職員: {summary.staffCount}名</div>
                                                {summary.maxUsers > 0 && <div className="text-xs text-slate-500">利用者Max: {summary.maxUsers}名</div>}
                                            </div>
                                        )}
                                    </>)}
                                </div>
                            )})}
                        </div>
                    </div>

                    {isModalOpen && selectedDate && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fade-in-modal">
                            <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                                <div className="p-4 border-b border-slate-200 flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-slate-800">{selectedDate.getFullYear()}年{selectedDate.getMonth() + 1}月{selectedDate.getDate()}日 の配置状況</h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x" size={24} /></button>
                                </div>
                                
                                <div className="p-6 overflow-y-auto flex-1">
                                    {/* 配置シミュレーションエリア */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                        <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                            <h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><Icon name="users" size={16} /> 利用者状況 (予測)</h4>
                                            <div className="flex justify-between items-end mb-2">
                                                <div className="text-sm text-slate-500">最大利用者数</div>
                                                <div className="text-2xl font-bold text-slate-800">{maxUsers} <span className="text-sm font-normal">名</span></div>
                                            </div>
                                            <div className="flex justify-between items-end mb-4">
                                                <div className="text-sm text-slate-500">ピーク時間帯</div>
                                                <div className="text-lg font-medium text-slate-800">{peakTime ? `${peakTime}〜` : "-"}</div>
                                            </div>
                                            <div className="h-32 w-full">
                                                <SimpleBarChart data={chartData} />
                                            </div>
                                        </div>

                                        <div className="bg-white p-4 rounded-lg border-2 border-blue-100">
                                            <h4 className="font-bold text-blue-800 mb-3 flex items-center gap-2"><Icon name="check-circle" size={16} /> 人員配置判定</h4>
                                            
                                            <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-100">
                                                <span className="text-sm text-slate-600">職員数 (常勤換算)</span>
                                                <span className="text-xl font-bold">{fte.toFixed(1)}</span>
                                            </div>
                                            <div className="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                                                <span className="text-sm text-slate-600">現在の比率 (利用者:職員)</span>
                                                <span className="text-xl font-bold">{maxUsers > 0 ? `${ratio} : 1` : "-"}</span>
                                            </div>

                                            <div className="space-y-2">
                                                <div className={`flex justify-between items-center p-2 rounded ${isSafe75 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                                    <span className="text-sm font-bold">7.5 : 1 基準</span>
                                                    <span>{isSafe75 ? "達成 ◎" : "不足"}</span>
                                                </div>
                                                <div className={`flex justify-between items-center p-2 rounded ${isSafe10 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                                    <span className="text-sm font-bold">10 : 1 基準</span>
                                                    <span>{isSafe10 ? "達成 ◎" : "不足"}</span>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-4 pt-2 border-t border-slate-100 text-xs text-slate-500">
                                                <div className="flex justify-between"><span>有資格者数:</span> <span>{qualifiedCount} 名</span></div>
                                                <div className="mt-1">※加算要件の目安として参照ください</div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 職員シフト入力 */}
                                    <h4 className="font-bold text-slate-700 mb-3">職員シフト登録</h4>
                                    <div className="space-y-2">
                                        {staffs.map(staff => {
                                            const dateKey = formatDateKey(selectedDate);
                                            const shift = (staffShifts[dateKey] && staffShifts[dateKey][staff.id]) || { time: "09:00-18:00", checked: false };
                                            return (
                                                <div key={staff.id} className={`flex items-center justify-between p-3 rounded border ${shift.checked ? 'bg-green-50 border-green-200' : 'border-slate-200'}`}>
                                                    <div className="flex items-center gap-3">
                                                        <input type="checkbox" checked={shift.checked} onChange={(e) => handleShiftChange(staff.id, 'checked', e.target.checked)} className="w-5 h-5 text-green-600 rounded border-slate-300 focus:ring-green-500 cursor-pointer" />
                                                        <div>
                                                            <div className={`font-medium ${shift.checked ? 'text-green-900' : 'text-slate-600'}`}>{staff.name}</div>
                                                            <div className="text-xs text-slate-400">{staff.role} {staff.type === 'full' ? '[常勤]' : '[非常勤]'}</div>
                                                        </div>
                                                    </div>
                                                    {shift.checked && (
                                                        <div className="flex items-center gap-2">
                                                            <Icon name="clock" size={16} className="text-slate-400" />
                                                            <select className="border border-slate-300 rounded px-2 py-1 text-sm bg-white" value={shift.time} onChange={(e) => handleShiftChange(staff.id, 'time', e.target.value)}>
                                                                <option value="09:00-18:00">09:00-18:00 (フル)</option>
                                                                <option value="09:00-13:00">09:00-13:00 (AM)</option>
                                                                <option value="13:00-18:00">13:00-18:00 (PM)</option>
                                                                <option value="10:00-16:00">10:00-16:00 (短時間)</option>
                                                            </select>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        {staffs.length === 0 && <div className="text-center text-slate-400">職員が登録されていません</div>}
                                    </div>
                                </div>
                                <div className="p-4 border-t border-slate-200 flex justify-end"><button onClick={() => setIsModalOpen(false)} className="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors shadow-sm">完了</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 職員管理画面 (拡張版) ---
        const StaffManagement = ({ staffs, setStaffs }) => {
            const [formData, setFormData] = useState({ name: "", role: "", type: "full", qualifications: [] }); 
            const [editingId, setEditingId] = useState(null);
            const [deleteTarget, setDeleteTarget] = useState(null);

            const roleOptions = ["サービス管理責任者", "生活支援員", "施設長", "職業訓練指導員", "管理者"];
            const qualOptions = ["社会福祉士", "介護福祉士", "精神保健福祉士", "公認心理師", "作業療法士"];

            const handleSubmit = () => {
                if (!formData.name) return;
                if (editingId) { setStaffs(staffs.map(s => s.id === editingId ? { ...s, ...formData } : s)); setEditingId(null); } 
                else { setStaffs([...staffs, { id: Date.now(), ...formData }]); }
                setFormData({ name: "", role: "", type: "full", qualifications: [] });
            };

            const handleEdit = (staff) => { setEditingId(staff.id); setFormData({ name: staff.name, role: staff.role, type: staff.type || "full", qualifications: staff.qualifications || [] }); };
            const handleCancel = () => { setEditingId(null); setFormData({ name: "", role: "", type: "full", qualifications: [] }); };
            const handleDeleteClick = (staff) => setDeleteTarget(staff);
            const executeDelete = () => { if (deleteTarget) { setStaffs(staffs.filter(s => s.id !== deleteTarget.id)); if (editingId === deleteTarget.id) handleCancel(); setDeleteTarget(null); } };

            const toggleQual = (q) => {
                const current = formData.qualifications || [];
                if (current.includes(q)) setFormData({...formData, qualifications: current.filter(x => x !== q)});
                else setFormData({...formData, qualifications: [...current, q]});
            };

            return (
                <div className="max-w-4xl mx-auto animate-fade-in">
                    <h1 className="text-2xl font-bold text-slate-800 mb-6">職員情報管理</h1>
                    <Card title={editingId ? "職員情報の編集" : "新規登録"}>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label className="block text-sm font-medium text-slate-600 mb-1">職員名</label><TextInput value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })} placeholder="例: 小野 美和子" /></div>
                            <div><label className="block text-sm font-medium text-slate-600 mb-1">役職</label><StaffSelect value={formData.role} onChange={e => setFormData({ ...formData, role: e.target.value })} options={roleOptions.map(r => ({ id: r, name: r }))} placeholder="選択" /></div>
                        </div>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-slate-600 mb-1">雇用形態 (常勤換算用)</label>
                            <div className="flex gap-4">
                                <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={formData.type === 'full'} onChange={() => setFormData({...formData, type: 'full'})} className="text-blue-600" /> 常勤 (専従)</label>
                                <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={formData.type === 'part'} onChange={() => setFormData({...formData, type: 'part'})} className="text-blue-600" /> 非常勤/兼務</label>
                            </div>
                        </div>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-slate-600 mb-1">保有資格 (加算判定用)</label>
                            <div className="flex flex-wrap gap-3">
                                {qualOptions.map(q => (
                                    <label key={q} className="flex items-center gap-2 cursor-pointer bg-slate-50 px-2 py-1 rounded border border-slate-200">
                                        <input type="checkbox" checked={(formData.qualifications || []).includes(q)} onChange={() => toggleQual(q)} className="text-blue-600 rounded" />
                                        <span className="text-sm">{q}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div className="flex gap-2 justify-end">{editingId && (<button onClick={handleCancel} className="px-4 py-2 border border-slate-300 rounded-md text-slate-600 hover:bg-slate-50">キャンセル</button>)}<button onClick={handleSubmit} className={`text-white px-6 py-2 rounded-md shadow-sm ${editingId ? "bg-green-600 hover:bg-green-700" : "bg-blue-600 hover:bg-blue-700"}`}>{editingId ? "更新" : "追加"}</button></div>
                    </Card>

                    <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                        <table className="min-w-full divide-y divide-slate-200"><thead className="bg-slate-50"><tr><th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">氏名</th><th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">役職・資格</th><th className="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase">操作</th></tr></thead><tbody className="divide-y divide-slate-200">{staffs.map(staff => (<tr key={staff.id} className={editingId === staff.id ? "bg-blue-50" : ""}><td className="px-6 py-4"><div className="text-sm font-medium text-slate-900">{staff.name}</div><div className="text-xs text-slate-500">{staff.type === 'full' ? '常勤' : '非常勤'}</div></td><td className="px-6 py-4 text-sm text-slate-500"><div>{staff.role}</div><div className="text-xs text-slate-400">{(staff.qualifications || []).join(", ")}</div></td><td className="px-6 py-4 text-right"><button onClick={() => handleEdit(staff)} className="text-blue-600 hover:text-blue-800 mr-3"><Icon name="pencil" size={16} /></button><button onClick={() => handleDeleteClick(staff)} className="text-red-500 hover:text-red-700"><Icon name="trash-2" size={16} /></button></td></tr>))}{staffs.length === 0 && (<tr><td colSpan="3" className="px-6 py-8 text-center text-slate-400">登録された職員はいません</td></tr>)}</tbody></table>
                    </div>
                    {deleteTarget && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fade-in-modal"><div className="bg-white rounded-lg shadow-xl max-w-sm w-full p-6"><h3 className="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2"><Icon name="alert-triangle" className="text-red-500" />削除の確認</h3><p className="text-slate-600 mb-6">職員「<span className="font-bold">{deleteTarget.name}</span>」を削除しますか？</p><div className="flex justify-end gap-3"><button onClick={() => setDeleteTarget(null)} className="px-4 py-2 border border-slate-300 rounded-md text-slate-700">キャンセル</button><button onClick={executeDelete} className="px-4 py-2 bg-red-600 text-white rounded-md shadow-sm">削除する</button></div></div></div>
                    )}
                </div>
            );
        };

        // --- 利用者シフト管理 ---
        const UserShiftManagement = ({ users }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [shifts, setShifts] = useState({});
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);

            useEffect(() => { const saved = localStorage.getItem("knowbe_shifts"); if (saved) { try { setShifts(JSON.parse(saved)); } catch(e) {} } }, []);
            useEffect(() => { localStorage.setItem("knowbe_shifts", JSON.stringify(shifts)); }, [shifts]);

            const getCalendarDays = () => {
                const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const days = [];
                for (let i = 0; i < firstDay.getDay(); i++) days.push(null); for (let i = 1; i <= lastDay.getDate(); i++) days.push(new Date(year, month, i)); return days;
            };
            const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const handleDateClick = (date) => { setSelectedDate(date); setIsModalOpen(true); };
            const handleShiftChange = (userId, field, value) => {
                if (!selectedDate) return; const dateKey = formatDateKey(selectedDate); const current = shifts[dateKey] || {}; const shift = current[userId] || { time: "10:00-15:00", checked: false };
                setShifts({ ...shifts, [dateKey]: { ...current, [userId]: { ...shift, [field]: value } } });
            };
            const getShiftCount = (date) => { if (!date) return 0; const s = shifts[formatDateKey(date)]; return s ? Object.values(s).filter(v => v.checked).length : 0; };
            const weekDays = ["日", "月", "火", "水", "木", "金", "土"];

            return (
                <div className="max-w-6xl mx-auto animate-fade-in p-4">
                    <div className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold text-slate-800">利用者シフト管理</h1><div className="flex items-center gap-4"><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))} className="p-2 hover:bg-slate-200 rounded"><Icon name="chevron-left" /></button><span className="text-xl font-bold">{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</span><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))} className="p-2 hover:bg-slate-200 rounded"><Icon name="chevron-right" /></button></div></div>
                    <div className="bg-white rounded-lg shadow border border-slate-200"><div className="grid grid-cols-7 border-b border-slate-200 bg-slate-50">{weekDays.map((d, i) => (<div key={i} className="p-3 text-center font-bold text-slate-600">{d}</div>))}</div><div className="grid grid-cols-7">{getCalendarDays().map((d, i) => (<div key={i} className={`min-h-[100px] border-b border-r border-slate-100 p-2 ${d ? 'hover:bg-slate-50 cursor-pointer' : 'bg-slate-50'}`} onClick={() => d && handleDateClick(d)}>{d && (<><span className="text-sm font-medium">{d.getDate()}</span>{getShiftCount(d) > 0 && <div className="mt-2"><span className="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full">{getShiftCount(d)}名</span></div>}</>)}</div>))}</div></div>
                    {isModalOpen && selectedDate && (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fade-in-modal"><div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col"><div className="p-4 border-b border-slate-200 flex justify-between items-center"><h3 className="text-lg font-bold">{selectedDate.getDate()}日のシフト</h3><button onClick={() => setIsModalOpen(false)}><Icon name="x" /></button></div><div className="p-4 overflow-y-auto flex-1"><div className="space-y-2">{users.map(u => { const key = formatDateKey(selectedDate); const s = (shifts[key] && shifts[key][u.id]) || { time: "10:00-15:00", checked: false }; return (<div key={u.id} className="flex items-center justify-between p-3 rounded border"><div className="flex items-center gap-3"><input type="checkbox" checked={s.checked} onChange={e => handleShiftChange(u.id, 'checked', e.target.checked)} className="w-5 h-5 text-blue-600" /><span>{u.name}</span></div>{s.checked && <select className="border rounded px-2 py-1 text-sm" value={s.time} onChange={e => handleShiftChange(u.id, 'time', e.target.value)}><option value="10:00-15:00">10:00-15:00</option><option value="10:00-12:00">10:00-12:00</option><option value="13:00-15:00">13:00-15:00</option></select>}</div>); })}</div></div><div className="p-4 border-t border-slate-200 flex justify-end"><button onClick={() => setIsModalOpen(false)} className="bg-blue-600 text-white px-6 py-2 rounded">完了</button></div></div></div>)}
                </div>
            );
        };

        // --- 仮申込書フォーム (UI更新) ---
        const ApplicationForm = ({ data, onChange, staffList }) => {
            const update = (field, value) => onChange({ ...data, [field]: value });
            // schedule内の特定のキーを更新するためのラッパー
            const updateSchedule = (field, value) => onChange({ 
                ...data, 
                schedule: { ...data.schedule, [field]: value } 
            });
            const handleCheckbox = (field, item) => { const current = data[field] || []; if (current.includes(item)) update(field, current.filter(i => i !== item)); else update(field, [...current, item]); };

            // シフト時間の選択肢
            const timeOptions = [
                "10:00～11:00", "10:00～12:00", "10:00～14:00", "10:00～15:00",
                "11:00～12:00", "11:00～14:00", "11:00～15:00",
                "13:00～14:00", "13:00～15:00", "14:00～15:00"
            ];

            return (
                <div>
                    <Card title="基本情報・連絡先">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><InputGroup label="受付日"><TextInput type="date" value={data.receptionDate} onChange={e => update('receptionDate', e.target.value)} /></InputGroup><InputGroup label="見学対応者（スタッフ）"><StaffSelect value={data.interviewer} onChange={e => update('interviewer', e.target.value)} options={staffList} /></InputGroup>
                            <div className="col-span-1 md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 bg-blue-50 p-4 rounded-md border border-blue-100"><InputGroup label="お名前（利用者）" required><TextInput value={data.applicantName} onChange={e => update('applicantName', e.target.value)} placeholder="例：飯嶋 卓也" className="font-bold" /></InputGroup><InputGroup label="フリガナ"><TextInput value={data.applicantNameKana} onChange={e => update('applicantNameKana', e.target.value)} placeholder="例：イイジマ タクヤ" /></InputGroup><InputGroup label="生年月日"><TextInput type="date" value={data.dob} onChange={e => update('dob', e.target.value)} /></InputGroup><InputGroup label="年齢"><TextInput type="number" value={data.age} onChange={e => update('age', e.target.value)} /></InputGroup></div>
                            <InputGroup label="性別"><div className="flex mt-2">{['男性', '女性', 'その他'].map(g => (<Radio key={g} label={g} name="gender" value={g} checked={data.gender === g} onChange={() => update('gender', g)} />))}</div></InputGroup><InputGroup label="住所"><TextInput value={data.address} onChange={e => update('address', e.target.value)} /></InputGroup><InputGroup label="電話番号"><TextInput value={data.phone} onChange={e => update('phone', e.target.value)} /></InputGroup><InputGroup label="メールアドレス"><TextInput value={data.email} onChange={e => update('email', e.target.value)} /></InputGroup>
                        </div>
                    </Card>
                    <Card title="障害・手帳情報">
                         <div className="mb-4"><label className="block text-sm font-medium mb-2">障害種別</label><div className="flex flex-wrap">{['身体障害', '知的障害', '精神障害'].map(t => (<Checkbox key={t} label={t} checked={(data.disabilityType || []).includes(t)} onChange={() => handleCheckbox('disabilityType', t)} />))}</div></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><InputGroup label="病名・障害名"><TextInput value={data.disabilityName} onChange={e => update('disabilityName', e.target.value)} /></InputGroup><InputGroup label="障害等級"><TextInput value={data.disabilityGrade} onChange={e => update('disabilityGrade', e.target.value)} /></InputGroup></div>
                    </Card>
                    <Card title="アンケート">
                        <InputGroup label="障がい者施設のご利用経験、またはご存じでしたか？"><div className="flex"><Radio label="はい" name="exp" checked={data.hasExperience === 'はい'} onChange={() => update('hasExperience', 'はい')} /><Radio label="いいえ" name="exp" checked={data.hasExperience === 'いいえ'} onChange={() => update('hasExperience', 'いいえ')} /></div></InputGroup><InputGroup label="本日詳しく聞きたいことはなんですか？"><TextArea value={data.todayQuestion} onChange={e => update('todayQuestion', e.target.value)} /></InputGroup><InputGroup label="見学に来た理由や、現在の悩み（複数選択可）"><div className="flex flex-wrap">{['生活リズム', '得意不得意不明', '日中の居場所', '交友関係', '不眠', '人間関係', '仕事の悩み'].map(i => (<Checkbox key={i} label={i} checked={(data.concerns || []).includes(i)} onChange={() => handleCheckbox('concerns', i)} />))}</div></InputGroup><InputGroup label="今後どのようなことを頑張りたいか"><TextArea value={data.futureGoal} onChange={e => update('futureGoal', e.target.value)} /></InputGroup>
                    </Card>
                    <Card title="今後の予定管理">
                        <div className="grid grid-cols-1 gap-4">
                            {/* 体験1 */}
                            <InputGroup label="体験1回目">
                                <div className="flex gap-2">
                                    <TextInput type="date" value={data.schedule.trial1} onChange={e => updateSchedule('trial1', e.target.value)} className="flex-1" />
                                    <div className="relative flex-1">
                                        <select
                                            className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm appearance-none bg-white"
                                            value={data.schedule.trial1Time}
                                            onChange={e => updateSchedule('trial1Time', e.target.value)}
                                        >
                                            <option value="">時間選択</option>
                                            {timeOptions.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon name="chevron-down" size={16} /></div>
                                    </div>
                                </div>
                            </InputGroup>
                            
                            {/* 体験2 */}
                            <InputGroup label="体験2回目">
                                <div className="flex gap-2">
                                    <TextInput type="date" value={data.schedule.trial2} onChange={e => updateSchedule('trial2', e.target.value)} className="flex-1" />
                                    <div className="relative flex-1">
                                        <select
                                            className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm appearance-none bg-white"
                                            value={data.schedule.trial2Time}
                                            onChange={e => updateSchedule('trial2Time', e.target.value)}
                                        >
                                            <option value="">時間選択</option>
                                            {timeOptions.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon name="chevron-down" size={16} /></div>
                                    </div>
                                </div>
                            </InputGroup>

                            {/* 体験3 */}
                            <InputGroup label="体験3回目">
                                <div className="flex gap-2">
                                    <TextInput type="date" value={data.schedule.trial3} onChange={e => updateSchedule('trial3', e.target.value)} className="flex-1" />
                                    <div className="relative flex-1">
                                        <select
                                            className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm appearance-none bg-white"
                                            value={data.schedule.trial3Time}
                                            onChange={e => updateSchedule('trial3Time', e.target.value)}
                                        >
                                            <option value="">時間選択</option>
                                            {timeOptions.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icon name="chevron-down" size={16} /></div>
                                    </div>
                                </div>
                            </InputGroup>

                            {/* 他の項目 */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <InputGroup label="受給者証発行日"><TextInput type="date" value={data.schedule.certificateDate} onChange={e => updateSchedule('certificateDate', e.target.value)} /></InputGroup>
                                <InputGroup label="契約予定日"><TextInput type="date" value={data.schedule.contractDate} onChange={e => updateSchedule('contractDate', e.target.value)} /></InputGroup>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- アセスメントフォーム (復活・省略なし) ---
        const AssessmentForm = ({ data, onChange, applicationData, staffList }) => {
            const [tab, setTab] = useState(0);
            const tabs = ["基本情報", "就労・生活歴", "日常生活", "就労評価(チェック)", "総合所見"];
            const update = (field, value) => onChange({ ...data, [field]: value });
            const updateNested = (parent, field, value) => onChange({ ...data, [parent]: { ...data[parent], [field]: value } });
            
            const RatingRow = ({ label, category, field }) => {
                const val = data.checklist[category][field];
                const setVal = (newVal) => { onChange({ ...data, checklist: { ...data.checklist, [category]: { ...data.checklist[category], [field]: { ...val, ...newVal } } } }); };
                return (<div className="border-b border-slate-100 py-3"><div className="flex justify-between items-center mb-2"><span className="font-medium text-slate-700">{label}</span><select className="border rounded p-1 text-sm bg-slate-50" value={val.score} onChange={(e) => setVal({ score: parseInt(e.target.value) })}><option value="0">-</option><option value="1">1. 出来る</option><option value="2">2. 少し支援が必要</option><option value="3">3. 支援が必要</option><option value="4">4. 出来ない</option></select></div><TextInput placeholder="特記事項・支援ポイント" value={val.note} onChange={(e) => setVal({ note: e.target.value })} /></div>);
            };

            return (
                <div>
                    <div className="flex space-x-1 bg-slate-200 p-1 rounded-lg mb-6 overflow-x-auto">{tabs.map((t, i) => (<button key={i} onClick={() => setTab(i)} className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors whitespace-nowrap ${tab === i ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-600 hover:bg-slate-300'}`}>{t}</button>))}</div>
                    {tab === 0 && (<Card title="基本情報（フェイスシート）"><div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded mb-6 border border-slate-200"><AutoFillDisplay label="氏名" value={applicationData.applicantName} /><AutoFillDisplay label="生年月日" value={applicationData.dob} /><AutoFillDisplay label="住所" value={applicationData.address} /><AutoFillDisplay label="TEL" value={applicationData.phone} /></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><InputGroup label="作成日"><TextInput type="date" value={data.createDate} onChange={e => update('createDate', e.target.value)} /></InputGroup><InputGroup label="記入者"><StaffSelect value={data.writer} onChange={e => update('writer', e.target.value)} options={staffList} /></InputGroup><InputGroup label="通所方法"><TextInput value={data.commuteMethod} onChange={e => update('commuteMethod', e.target.value)} /></InputGroup><div className="md:col-span-2 p-4 bg-slate-50 rounded-md border border-slate-200"><h5 className="font-bold text-slate-700 mb-2">緊急連絡先</h5><div className="grid grid-cols-3 gap-2"><TextInput placeholder="氏名" value={data.emergencyContact.name} onChange={e => updateNested('emergencyContact', 'name', e.target.value)} /><TextInput placeholder="続柄" value={data.emergencyContact.relation} onChange={e => updateNested('emergencyContact', 'relation', e.target.value)} /><TextInput placeholder="TEL" value={data.emergencyContact.tel} onChange={e => updateNested('emergencyContact', 'tel', e.target.value)} /></div></div><div className="md:col-span-2"><SectionHeader text="受給状況・手帳" /><div className="grid grid-cols-1 gap-2"><InputGroup label="精神保健福祉手帳"><div className="flex gap-2"><TextInput placeholder="状態（申請中など）" value={data.certificates.mental.status} onChange={e => updateNested('certificates', 'mental', { ...data.certificates.mental, status: e.target.value })} /><TextInput placeholder="補足事項" value={data.certificates.mental.note} onChange={e => updateNested('certificates', 'mental', { ...data.certificates.mental, note: e.target.value })} /></div></InputGroup><InputGroup label="年金・生活保護"><div className="flex gap-2"><TextInput placeholder="年金補足" value={data.financial.pension.note} onChange={e => updateNested('financial', 'pension', { ...data.financial.pension, note: e.target.value })} /><TextInput placeholder="生保補足" value={data.financial.welfare.note} onChange={e => updateNested('financial', 'welfare', { ...data.financial.welfare, note: e.target.value })} /></div></InputGroup></div></div><div className="md:col-span-2"><SectionHeader text="医療情報" /><div className="grid grid-cols-2 gap-4"><InputGroup label="通院先"><TextInput value={data.medical.hospital} onChange={e => updateNested('medical', 'hospital', e.target.value)} /></InputGroup><InputGroup label="診断名"><TextInput value={data.medical.diagnosis} onChange={e => updateNested('medical', 'diagnosis', e.target.value)} /></InputGroup><InputGroup label="主治医"><TextInput value={data.medical.doctor} onChange={e => updateNested('medical', 'doctor', e.target.value)} /></InputGroup><InputGroup label="通院頻度"><TextInput value={data.medical.visitFrequency} onChange={e => updateNested('medical', 'visitFrequency', e.target.value)} /></InputGroup></div></div></div></Card>)}
                    {tab === 1 && (<Card title="就労・生活歴"><SectionHeader text="職歴" />{data.workHistory.map((work, idx) => (<div key={idx} className="bg-slate-50 p-3 rounded mb-3 border border-slate-200"><div className="grid grid-cols-2 gap-2 mb-2"><TextInput placeholder="会社名" value={work.company} onChange={e => {const list = [...data.workHistory]; list[idx].company = e.target.value; update('workHistory', list);}} /><TextInput placeholder="雇用形態" value={work.type} onChange={e => {const list = [...data.workHistory]; list[idx].type = e.target.value; update('workHistory', list);}} /></div><TextArea placeholder="仕事内容" rows={2} value={work.content} onChange={e => {const list = [...data.workHistory]; list[idx].content = e.target.value; update('workHistory', list);}} /></div>))}<button className="text-sm text-blue-600 hover:text-blue-800 font-medium mb-6" onClick={() => update('workHistory', [...data.workHistory, { company: "", content: "", period: "", type: "", days: "", hours: "", salary: "", reason: "" }])}>+ 職歴を追加</button><SectionHeader text="病歴・障害履歴" /><div className="grid grid-cols-1 gap-4"><InputGroup label="発病時期"><TextInput value={data.onsetAge} onChange={e => update('onsetAge', e.target.value)} /></InputGroup><InputGroup label="現在の精神状況（症状と程度）"><TextArea value={data.currentMentalState} onChange={e => update('currentMentalState', e.target.value)} /></InputGroup><InputGroup label="調子を崩す前兆（誘因）"><TextArea value={data.triggers} onChange={e => update('triggers', e.target.value)} /></InputGroup><InputGroup label="調子を崩した時の対処"><TextArea value={data.coping} onChange={e => update('coping', e.target.value)} /></InputGroup><InputGroup label="性格・行動面の特徴"><TextArea value={data.personality} onChange={e => update('personality', e.target.value)} /></InputGroup><InputGroup label="生い立ち・生育歴"><TextArea value={data.upbringing} onChange={e => update('upbringing', e.target.value)} /></InputGroup></div></Card>)}
                    {tab === 2 && (<Card title="日常生活の状況"><div className="grid grid-cols-2 gap-4 mb-4"><InputGroup label="起床時間"><TextInput type="time" value={data.dailyLife.wakeTime} onChange={e => updateNested('dailyLife', 'wakeTime', e.target.value)} /></InputGroup><InputGroup label="就寝時間"><TextInput type="time" value={data.dailyLife.sleepTime} onChange={e => updateNested('dailyLife', 'sleepTime', e.target.value)} /></InputGroup></div><InputGroup label="コミュニケーション・意思伝達"><TextArea value={data.dailyLife.commSkill} onChange={e => updateNested('dailyLife', 'commSkill', e.target.value)} /></InputGroup><InputGroup label="文章理解"><TextArea value={data.dailyLife.literacy} onChange={e => updateNested('dailyLife', 'literacy', e.target.value)} /></InputGroup><InputGroup label="時計・計算の理解"><TextArea value={data.dailyLife.numeracy} onChange={e => updateNested('dailyLife', 'numeracy', e.target.value)} /></InputGroup><SectionHeader text="家族構成" />{data.familyStructure.map((fam, idx) => (<div key={idx} className="flex gap-2 mb-2"><TextInput placeholder="氏名" value={fam.name} onChange={e => {const list = [...data.familyStructure]; list[idx].name = e.target.value; update('familyStructure', list);}} /><TextInput placeholder="続柄" value={fam.relation} onChange={e => {const list = [...data.familyStructure]; list[idx].relation = e.target.value; update('familyStructure', list);}} /><TextInput placeholder="年齢" className="w-20" value={fam.age} onChange={e => {const list = [...data.familyStructure]; list[idx].age = e.target.value; update('familyStructure', list);}} /><TextInput placeholder="職業・備考" value={fam.note} onChange={e => {const list = [...data.familyStructure]; list[idx].note = e.target.value; update('familyStructure', list);}} /></div>))}<button className="text-sm text-blue-600 hover:text-blue-800 font-medium" onClick={() => update('familyStructure', [...data.familyStructure, { name: "", relation: "", age: "", note: "" }])}>+ 家族を追加</button></Card>)}
                    {tab === 3 && (<Card title="アセスメント（就労分野シート）"><div className="bg-blue-50 p-4 rounded mb-6 text-sm text-slate-700"><strong>評価基準:</strong> 1.出来る / 2.少し支援が必要 / 3.支援が必要 / 4.出来ない</div><SectionHeader text="1. 健康管理" /><RatingRow label="1. 体調管理" category="health" field="physical" /><RatingRow label="2. 服薬管理" category="health" field="medication" /><RatingRow label="3. 食事管理" category="health" field="diet" /><SectionHeader text="2. 日常生活管理" /><RatingRow label="1. 生活リズム" category="daily" field="rhythm" /><RatingRow label="2. 身だしなみ" category="daily" field="appearance" /><RatingRow label="3. 清潔保持" category="daily" field="cleanliness" /><RatingRow label="4. 金銭管理" category="daily" field="money" /><RatingRow label="5. 移動" category="daily" field="mobility" /><SectionHeader text="3. 対人技能" /><RatingRow label="1. 意思伝達" category="social" field="expression" /><RatingRow label="2. 意思疎通" category="social" field="communication" /><RatingRow label="3. 感情コントロール" category="social" field="emotion" /><RatingRow label="4. 協調性" category="social" field="cooperation" /><SectionHeader text="4. 就労" /><RatingRow label="1. 就労理解" category="work" field="understanding" /><RatingRow label="2. 就労意思" category="work" field="intention" /><RatingRow label="3. 就労意欲" category="work" field="motivation" /><RatingRow label="4. 体力・精神力" category="work" field="endurance" /></Card>)}
                    {tab === 4 && (<Card title="総合所見・支援方針"><SectionHeader text="基本的労働習慣の所見" /><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div className="flex items-center justify-between border-b pb-2"><span>あいさつ</span><Checkbox label="有" checked={data.basicHabits.greeting.has} onChange={e => updateNested('basicHabits', 'greeting', { ...data.basicHabits.greeting, has: e.target.checked })} /></div><div className="flex items-center justify-between border-b pb-2"><span>報告・連絡・相談</span><Checkbox label="有" checked={data.basicHabits.reporting.has} onChange={e => updateNested('basicHabits', 'reporting', { ...data.basicHabits.reporting, has: e.target.checked })} /></div><div className="flex items-center justify-between border-b pb-2"><span>毎日の通所</span><Checkbox label="有" checked={data.basicHabits.attendance.has} onChange={e => updateNested('basicHabits', 'attendance', { ...data.basicHabits.attendance, has: e.target.checked })} /></div></div><SectionHeader text="当該事業所に望む支援" /><div className="flex flex-wrap mb-2">{['就職先の確保', '実習先の確保', '職場定着', '生活支援'].map(item => (<Checkbox key={item} label={item} checked={data.desiredSupport.items.includes(item)} onChange={() => {const current = data.desiredSupport.items;const newItems = current.includes(item) ? current.filter(i => i !== item) : [...current, item];updateNested('desiredSupport', 'items', newItems);}} />))}</div><TextArea placeholder="その他の具体的内容" value={data.desiredSupport.detail} onChange={e => updateNested('desiredSupport', 'detail', e.target.value)} /><SectionHeader text="総合所見" /><InputGroup label="本人が希望している就労内容"><TextArea value={data.overallOpinion.desiredWork} onChange={e => updateNested('overallOpinion', 'desiredWork', e.target.value)} /></InputGroup><InputGroup label="本人が自覚している就労準備性"><TextArea value={data.overallOpinion.readiness} onChange={e => updateNested('overallOpinion', 'readiness', e.target.value)} /></InputGroup><InputGroup label="今後必要となる力（課題）"><TextArea value={data.overallOpinion.futureTasks} onChange={e => updateNested('overallOpinion', 'futureTasks', e.target.value)} /></InputGroup></Card>)}
                </div>
            );
        };

        // --- 個別支援計画書フォーム (復活・省略なし) ---
        const PlanForm = ({ data, onChange, applicationData, staffList }) => {
            const handlePeriodStartChange = (val) => {
                const newData = { ...data, periodStart: val };
                if (val) { const date = new Date(val); date.setMonth(date.getMonth() + 6); const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); newData.monitoringDate = `${y}-${m}-${d}`; }
                onChange(newData);
            };
            const update = (field, value) => onChange({ ...data, [field]: value });

            return (
                <Card title="個別支援計画">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded mb-6 border border-slate-200"><AutoFillDisplay label="利用者氏名" value={applicationData.applicantName} /><AutoFillDisplay label="生年月日" value={applicationData.dob} /></div>
                    <div className="grid grid-cols-3 gap-4 mb-4"><InputGroup label="計画期間（開始）"><TextInput type="date" value={data.periodStart} onChange={e => handlePeriodStartChange(e.target.value)} /></InputGroup><InputGroup label="計画期間（終了）"><TextInput type="date" value={data.periodEnd} onChange={e => update('periodEnd', e.target.value)} /></InputGroup><InputGroup label="モニタリング予定日（次回）"><TextInput type="date" value={data.monitoringDate} onChange={e => update('monitoringDate', e.target.value)} className="font-bold bg-yellow-50 border-yellow-200" placeholder="自動計算されます" /></InputGroup></div>
                    <SectionHeader text="【1】本人の意向・課題等の整理" /><InputGroup label="本人の希望"><TextArea value={data.userDesire} onChange={e => update('userDesire', e.target.value)} /></InputGroup><InputGroup label="家族の意向"><TextArea value={data.familyDesire} onChange={e => update('familyDesire', e.target.value)} /></InputGroup><InputGroup label="解決すべき課題（ニーズ）"><TextArea value={data.needs} onChange={e => update('needs', e.target.value)} /></InputGroup>
                    <SectionHeader text="【2】目標設定" /><InputGroup label="長期目標（約1年）"><TextArea value={data.longTermGoal} onChange={e => update('longTermGoal', e.target.value)} /></InputGroup><InputGroup label="短期目標（〜6ヶ月）"><TextArea value={data.shortTermGoal} onChange={e => update('shortTermGoal', e.target.value)} /></InputGroup>
                    <SectionHeader text="【3】具体的な支援内容" /><InputGroup label="支援内容"><TextArea rows={6} value={data.supportContent} onChange={e => update('supportContent', e.target.value)} /></InputGroup>
                    <div className="grid grid-cols-3 gap-4 mt-6"><InputGroup label="作成担当者"><StaffSelect value={data.staff} onChange={e => update('staff', e.target.value)} options={staffList} /></InputGroup><InputGroup label="承認者"><StaffSelect value={data.approver} onChange={e => update('approver', e.target.value)} options={staffList} /></InputGroup><InputGroup label="説明日"><TextInput type="date" value={data.explainDate} onChange={e => update('explainDate', e.target.value)} /></InputGroup></div>
                </Card>
            );
        };

        // --- モニタリング記録票フォーム (復活・省略なし) ---
        const MonitoringForm = ({ data, onChange, applicationData, planData, staffList }) => {
            const update = (field, value) => onChange({ ...data, [field]: value });
            const alert = checkDeadlineAlert(planData?.monitoringDate, data.date, "モニタリング");
            return (
                <Card title="モニタリング記録">
                    <AlertBanner alert={alert} dateLabel="予定日" date={planData?.monitoringDate} />
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded mb-6 border border-slate-200"><AutoFillDisplay label="利用者名" value={applicationData.applicantName} /><AutoFillDisplay label="実施予定日（計画書より）" value={planData?.monitoringDate} /></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><InputGroup label="面談日"><TextInput type="date" value={data.date} onChange={e => update('date', e.target.value)} /></InputGroup><InputGroup label="担当者"><StaffSelect value={data.interviewer} onChange={e => update('interviewer', e.target.value)} options={staffList} /></InputGroup><InputGroup label="面談場所"><TextInput value={data.location} onChange={e => update('location', e.target.value)} /></InputGroup></div>
                    <SectionHeader text="評価・振り返り" /><InputGroup label="現状"><TextArea value={data.currentStatus} onChange={e => update('currentStatus', e.target.value)} /></InputGroup><InputGroup label="現状のニーズ"><TextArea value={data.needs} onChange={e => update('needs', e.target.value)} /></InputGroup><InputGroup label="現状に対する不安など"><TextArea value={data.anxiety} onChange={e => update('anxiety', e.target.value)} /></InputGroup><InputGroup label="現状に対する満足度"><TextArea value={data.satisfaction} onChange={e => update('satisfaction', e.target.value)} /></InputGroup>
                    <SectionHeader text="今後の方針" /><InputGroup label="今後の課題及び解決方法"><TextArea value={data.futureTasks} onChange={e => update('futureTasks', e.target.value)} /></InputGroup><InputGroup label="個別支援計画書に対するフィードバック"><TextArea value={data.feedback} onChange={e => update('feedback', e.target.value)} /></InputGroup>
                </Card>
            );
        };

        // --- 終了評価票フォーム (復活・省略なし) ---
        const TerminationForm = ({ data, onChange, applicationData, planData }) => {
            const update = (field, value) => onChange({ ...data, [field]: value });
            const handleRowChange = (id, field, value) => { const newGoals = data.goals.map(row => row.id === id ? { ...row, [field]: value } : row); update('goals', newGoals); };
            const alert = checkDeadlineAlert(planData?.periodEnd, data.date, "終了評価");
            return (
                <Card title="終了評価（終了時評価票）">
                    <AlertBanner alert={alert} dateLabel="計画終了日" date={planData?.periodEnd} />
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded mb-6 border border-slate-200"><AutoFillDisplay label="ご利用者名" value={applicationData.applicantName} /><AutoFillDisplay label="実施予定日（計画終了日）" value={planData?.periodEnd} /></div>
                    <div className="mb-6"><InputGroup label="実施日"><TextInput type="date" value={data.date} onChange={e => update('date', e.target.value)} className="w-48" /></InputGroup></div>
                    <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-200 border border-slate-200 rounded-lg"><thead className="bg-slate-50"><tr><th className="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase w-10">No.</th><th className="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase w-48">到達目標</th><th className="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase w-32">達成状況の評価</th><th className="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase">全体的評価</th><th className="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase">満足度などご利用者様意見</th><th className="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase">次回目標設定への意見など</th></tr></thead><tbody className="bg-white divide-y divide-slate-200">{data.goals.map((row) => (<tr key={row.id}><td className="px-3 py-4 text-center text-sm font-bold text-slate-500">{row.id}</td><td className="px-2 py-2 align-top"><TextArea rows={3} value={row.target} onChange={e => handleRowChange(row.id, 'target', e.target.value)} /></td><td className="px-2 py-2 align-top"><TextArea rows={3} value={row.achievement} onChange={e => handleRowChange(row.id, 'achievement', e.target.value)} placeholder="例：ほぼ達成" /></td><td className="px-2 py-2 align-top"><TextArea rows={3} value={row.overall} onChange={e => handleRowChange(row.id, 'overall', e.target.value)} /></td><td className="px-2 py-2 align-top"><TextArea rows={3} value={row.satisfaction} onChange={e => handleRowChange(row.id, 'satisfaction', e.target.value)} /></td><td className="px-2 py-2 align-top"><TextArea rows={3} value={row.nextOpinion} onChange={e => handleRowChange(row.id, 'nextOpinion', e.target.value)} /></td></tr>))}</tbody></table></div>
                </Card>
            );
        };

        // --- メイン ---
        const App = () => {
            const [view, setView] = useState("list");
            const [users, setUsers] = useState([]);
            const [staffs, setStaffs] = useState([]);
            const [userShifts, setUserShifts] = useState({}); // 連携用ステート追加
            const [activeUser, setActiveUser] = useState(null);
            const [activeForm, setActiveForm] = useState("summary");
            const [deleteTarget, setDeleteTarget] = useState(null);

            useEffect(() => {
                const savedUsers = localStorage.getItem("knowbe_users");
                if (savedUsers) {
                    try {
                        const parsed = JSON.parse(savedUsers);
                        // マイグレーション等は省略（既存ロジック）
                        const migrated = Array.isArray(parsed) ? parsed.map(u => {
                            // 既存データを復元しつつ、ステータスを自動判定で更新
                            const migratedUser = {
                                ...getInitialUserState(), 
                                ...u, 
                                plan: { ...getInitialUserState().plan, ...(u.plan || {}) },
                                monitoring: { ...getInitialUserState().monitoring, ...(u.monitoring || {}) },
                                termination: u.termination || getInitialUserState().termination,
                                application: { ...getInitialUserState().application, ...(u.application || {}), applicantName: u.application?.applicantName || u.name || "" }
                            };
                            // ステータス再判定
                            migratedUser.status = determineStatus(migratedUser);
                            return migratedUser;
                        }) : [];
                        setUsers(migrated);
                    } catch(e) { console.error("Data load error", e); }
                } else {
                    // 初期データ作成時もステータス判定（初期値ベースなので体験利用中になるはずだが念のため）
                    const initialApp = { ...getInitialUserState().application, applicantName: "飯嶋 卓也", applicantNameKana: "イイジマ タクヤ", interviewer: "小野 美和子", dob: "1986-12-23" };
                    let dummy = { ...getInitialUserState(), id: Date.now(), name: "飯嶋 卓也", application: initialApp };
                    dummy.status = determineStatus(dummy);
                    setUsers([dummy]);
                }
                const savedStaffs = localStorage.getItem("knowbe_staffs");
                if (savedStaffs) { try { setStaffs(JSON.parse(savedStaffs)); } catch(e) {} } else {
                    setStaffs([{ id: 1, name: "小野 美和子", role: "管理者", type: "full" }, { id: 2, name: "山田 太郎", role: "サービス管理責任者", type: "full" }]);
                }
                const savedUserShifts = localStorage.getItem("knowbe_shifts");
                if (savedUserShifts) { try { setUserShifts(JSON.parse(savedUserShifts)); } catch(e) {} }
            }, []);

            useEffect(() => { localStorage.setItem("knowbe_users", JSON.stringify(users)); }, [users]);
            useEffect(() => { localStorage.setItem("knowbe_staffs", JSON.stringify(staffs)); }, [staffs]);

            const handleCreateUser = () => { 
                const newUserRaw = { ...getInitialUserState(), id: Date.now(), name: "新規利用者" }; 
                // 新規作成時もステータス判定
                const newUser = { ...newUserRaw, status: determineStatus(newUserRaw) };
                setUsers([...users, newUser]); 
                setActiveUser(newUser.id); 
                setView("detail"); 
            };
            const handleUpdateUser = (updatedData) => {
                const name = updatedData.application.applicantName || updatedData.name || "名称未設定";
                
                // 更新時にステータスを自動判定
                const status = determineStatus(updatedData);

                const finalData = { ...updatedData, name, status };
                
                // --- 追加: 体験利用日程をシフトに反映 ---
                const newShifts = { ...userShifts };
                const schedule = finalData.application.schedule;
                const updateShift = (dateStr, timeStr) => {
                    if (dateStr && timeStr) {
                        const date = new Date(dateStr);
                        const dateKey = formatDateKey(date);
                        if (!newShifts[dateKey]) newShifts[dateKey] = {};
                        newShifts[dateKey][finalData.id] = { time: timeStr.replace('～', '-'), checked: true };
                    }
                };
                updateShift(schedule.trial1, schedule.trial1Time);
                updateShift(schedule.trial2, schedule.trial2Time);
                updateShift(schedule.trial3, schedule.trial3Time);
                setUserShifts(newShifts);
                localStorage.setItem("knowbe_shifts", JSON.stringify(newShifts));

                setUsers(users.map(u => u.id === finalData.id ? finalData : u));
                setActiveUser(finalData.id); 
            };
            const handleDeleteClick = (user) => setDeleteTarget(user);
            const executeDelete = () => { if(deleteTarget){ setUsers(users.filter(u=>u.id!==deleteTarget.id)); setDeleteTarget(null); setView("list"); }};
            const currentUser = useMemo(() => users.find(u => u.id === activeUser), [users, activeUser]);
            
            const exportData = () => { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(users)); a.download = "data.json"; a.click(); };
            const importData = (e) => { const r = new FileReader(); r.onload = (ev) => { if(confirm('上書きしますか？')) setUsers(JSON.parse(ev.target.result)); }; if(e.target.files[0]) r.readAsText(e.target.files[0]); };

            return (
                <ErrorBoundary>
                <div className="flex min-h-screen">
                    <div className="w-64 bg-slate-800 text-white flex-shrink-0 flex flex-col no-print">
                        <div className="p-6 text-xl font-bold border-b border-slate-700 flex items-center gap-2"><div className="w-8 h-8 bg-blue-500 rounded flex items-center justify-center">G</div>Gift Support</div>
                        <nav className="flex-1 p-4 space-y-1">
                            <button onClick={() => setView("list")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "list" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="users" /><span>利用者一覧</span></button>
                            <button onClick={() => setView("user_shift")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "user_shift" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="calendar" /><span>利用者シフト</span></button>
                            <button onClick={() => setView("staff_shift")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "staff_shift" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="calendar-check" /><span>職員シフト・配置</span></button>
                            <button onClick={() => setView("staff_shift_monthly")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "staff_shift_monthly" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="table" /><span>職員シフト表(月)</span></button>
                            <button onClick={() => setView("staff_list")} className={`flex items-center space-x-3 w-full p-3 rounded transition ${view === "staff_list" ? "bg-slate-700" : "hover:bg-slate-700"}`}><Icon name="user-cog" /><span>職員情報</span></button>
                            <div className="pt-4 pb-2 px-3 text-xs text-slate-500 uppercase font-bold">データ管理</div>
                            <button onClick={exportData} className="flex items-center space-x-3 w-full p-3 rounded hover:bg-slate-700"><Icon name="download" /><span>保存</span></button>
                            <label className="flex items-center space-x-3 w-full p-3 rounded hover:bg-slate-700 cursor-pointer"><Icon name="upload" /><span>読込</span><input type="file" className="hidden" onChange={importData} /></label>
                        </nav>
                    </div>
                    <div className="flex-1 flex flex-col">
                        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm no-print">
                            <div className="text-sm font-medium text-slate-600">ホーム {view === 'staff_shift' && '> 職員配置シミュレーション'} {view === 'staff_shift_monthly' && '> 職員シフト表(月)'}</div>
                            <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">A</div>
                        </header>
                        <main className="flex-1 p-8 overflow-y-auto">
                            {view === "list" && (
                                <div className="max-w-6xl mx-auto">
                                    <div className="flex justify-between mb-6"><h1 className="text-2xl font-bold">利用者一覧</h1><button onClick={handleCreateUser} className="bg-blue-600 text-white px-4 py-2 rounded flex gap-2"><Icon name="plus" />新規登録</button></div>
                                    <div className="bg-white rounded shadow overflow-hidden">
                                        <table className="min-w-full divide-y divide-slate-200"><thead className="bg-slate-50"><tr><th className="px-6 py-3 text-left">氏名</th><th className="px-6 py-3 text-left">状態</th><th className="px-6 py-3 text-right">操作</th></tr></thead>
                                        <tbody className="divide-y divide-slate-200">{users.map(u => (<tr key={u.id}><td className="px-6 py-4">{u.name}</td><td className="px-6 py-4">{u.status}</td><td className="px-6 py-4 text-right"><button onClick={() => {setActiveUser(u.id); setView("detail");}} className="text-blue-600 mr-4">編集</button><button onClick={() => handleDeleteClick(u)} className="text-red-500"><Icon name="trash-2" size={16} /></button></td></tr>))}</tbody></table>
                                    </div>
                                </div>
                            )}
                            {view === "user_shift" && <UserShiftManagement users={users} />}
                            {view === "staff_shift" && <StaffShiftManagement staffs={staffs} users={users} userShifts={userShifts} />}
                            {view === "staff_shift_monthly" && <StaffMonthlyShift staffs={staffs} staffShifts={JSON.parse(localStorage.getItem("knowbe_staff_shifts") || "{}")} onShiftChange={(date, staffId, timeValue) => { const dateKey = formatDateKey(date); const saved = JSON.parse(localStorage.getItem("knowbe_staff_shifts") || "{}"); const currentDay = saved[dateKey] || {}; saved[dateKey] = { ...currentDay, [staffId]: { time: timeValue || "09:00-18:00", checked: !!timeValue } }; localStorage.setItem("knowbe_staff_shifts", JSON.stringify(saved)); }} />}
                            {view === "staff_list" && <StaffManagement staffs={staffs} setStaffs={setStaffs} />}
                            {view === "detail" && currentUser && (
                                <div className="max-w-5xl mx-auto">
                                    <div className="mb-6 flex justify-between">
                                        <h1 className="text-2xl font-bold">{currentUser.name}</h1>
                                        <button onClick={() => window.print()} className="px-4 py-2 border rounded bg-white"><Icon name="printer" /> 印刷</button>
                                    </div>
                                    <div className="border-b mb-6"><nav className="flex space-x-8">{['要約情報','仮申込書','アセスメント','個別支援計画','モニタリング','終了評価'].map((label, idx) => { const ids = ['summary','application','assessment','plan','monitoring','termination']; return (<button key={ids[idx]} onClick={() => setActiveForm(ids[idx])} className={`py-4 border-b-2 ${activeForm===ids[idx] ? 'border-blue-500 text-blue-600' : 'border-transparent'}`}>{label}</button>); })}</nav></div>
                                    {activeForm === 'summary' && <SummaryView user={currentUser} />}
                                    {activeForm === 'application' && <ApplicationForm data={currentUser.application} onChange={d => handleUpdateUser({...currentUser, application: d})} staffList={staffs} />}
                                    {activeForm === 'assessment' && <AssessmentForm data={currentUser.assessment} onChange={d => handleUpdateUser({...currentUser, assessment: d})} applicationData={currentUser.application} staffList={staffs} />}
                                    {activeForm === 'plan' && <PlanForm data={currentUser.plan} onChange={d => handleUpdateUser({...currentUser, plan: d})} applicationData={currentUser.application} staffList={staffs} />}
                                    {activeForm === 'monitoring' && <MonitoringForm data={currentUser.monitoring} onChange={d => handleUpdateUser({...currentUser, monitoring: d})} applicationData={currentUser.application} planData={currentUser.plan} staffList={staffs} />}
                                    {activeForm === 'termination' && <TerminationForm data={currentUser.termination} onChange={d => handleUpdateUser({...currentUser, termination: d})} applicationData={currentUser.application} planData={currentUser.plan} />}
                                </div>
                            )}
                        </main>
                    </div>
                    {deleteTarget && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded shadow-xl"><p>削除しますか？</p><div className="flex justify-end gap-2 mt-4"><button onClick={() => setDeleteTarget(null)} className="px-4 py-2 border rounded">キャンセル</button><button onClick={executeDelete} className="px-4 py-2 bg-red-600 text-white rounded">削除</button></div></div></div>
                    )}
                </div>
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
